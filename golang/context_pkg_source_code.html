<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>context 包源码解析 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.2efd3993.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/26.b745054e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.965e5f58.js"><link rel="prefetch" href="/blog/assets/js/23.8248b6b6.js"><link rel="prefetch" href="/blog/assets/js/24.fe6aef0a.js"><link rel="prefetch" href="/blog/assets/js/25.ef479bf5.js"><link rel="prefetch" href="/blog/assets/js/27.e9839df3.js"><link rel="prefetch" href="/blog/assets/js/28.796bfa26.js"><link rel="prefetch" href="/blog/assets/js/29.38b104b6.js"><link rel="prefetch" href="/blog/assets/js/3.159d2146.js"><link rel="prefetch" href="/blog/assets/js/30.4af86574.js"><link rel="prefetch" href="/blog/assets/js/31.90b14a89.js"><link rel="prefetch" href="/blog/assets/js/32.b471f649.js"><link rel="prefetch" href="/blog/assets/js/33.d8e805f8.js"><link rel="prefetch" href="/blog/assets/js/34.09a753bf.js"><link rel="prefetch" href="/blog/assets/js/35.3fee7620.js"><link rel="prefetch" href="/blog/assets/js/36.03747912.js"><link rel="prefetch" href="/blog/assets/js/37.554dda8c.js"><link rel="prefetch" href="/blog/assets/js/38.46bcde33.js"><link rel="prefetch" href="/blog/assets/js/39.a82e6ea2.js"><link rel="prefetch" href="/blog/assets/js/4.8ed88519.js"><link rel="prefetch" href="/blog/assets/js/40.d6208f57.js"><link rel="prefetch" href="/blog/assets/js/41.b7a3a229.js"><link rel="prefetch" href="/blog/assets/js/42.ffb33af9.js"><link rel="prefetch" href="/blog/assets/js/43.c90b42ae.js"><link rel="prefetch" href="/blog/assets/js/44.fe190f21.js"><link rel="prefetch" href="/blog/assets/js/45.a4116688.js"><link rel="prefetch" href="/blog/assets/js/46.395f4bf2.js"><link rel="prefetch" href="/blog/assets/js/47.898431b6.js"><link rel="prefetch" href="/blog/assets/js/48.cb7a367c.js"><link rel="prefetch" href="/blog/assets/js/49.0f5b617e.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.bfaba15c.js"><link rel="prefetch" href="/blog/assets/js/51.604e12fd.js"><link rel="prefetch" href="/blog/assets/js/52.e63c94bd.js"><link rel="prefetch" href="/blog/assets/js/6.169e9be1.js"><link rel="prefetch" href="/blog/assets/js/7.e70cb6ab.js"><link rel="prefetch" href="/blog/assets/js/8.2450bca1.js"><link rel="prefetch" href="/blog/assets/js/9.5476b311.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Golang</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/golang/effective_go.html" class="sidebar-link">读 Effective Go 总结</a></li><li><a href="/blog/golang/flag_pkg_source_code.html" class="sidebar-link">flag 包源码解析</a></li><li><a href="/blog/golang/context_pkg_source_code.html" class="active sidebar-link">context 包源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/golang/context_pkg_source_code.html#context-context-接口" class="sidebar-link">context.Context 接口</a></li><li class="sidebar-sub-header"><a href="/blog/golang/context_pkg_source_code.html#context-的树结构" class="sidebar-link">context 的树结构</a></li><li class="sidebar-sub-header"><a href="/blog/golang/context_pkg_source_code.html#context-withcancel" class="sidebar-link">context.WithCancel</a></li><li class="sidebar-sub-header"><a href="/blog/golang/context_pkg_source_code.html#context-withvalue" class="sidebar-link">context.WithValue</a></li><li class="sidebar-sub-header"><a href="/blog/golang/context_pkg_source_code.html#context-withtimeout-和-context-withdeadline" class="sidebar-link">context.WithTimeout 和 context.WithDeadline</a></li><li class="sidebar-sub-header"><a href="/blog/golang/context_pkg_source_code.html#context-的最佳实践" class="sidebar-link">context 的最佳实践</a></li></ul></li><li><a href="/blog/golang/reflect_pkg_source_code_1.html" class="sidebar-link">reflect 包 DeepEqual 函数源码解析</a></li><li><a href="/blog/golang/map_type_1.html" class="sidebar-link">关于 map 类型的思考</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="context-包源码解析"><a href="#context-包源码解析" class="header-anchor">#</a> context 包源码解析</h1> <p>本文代码和测试均基于 golang 1.13.4。</p> <p>golang 中，我们经常会有对于一个请求启动多个 goroutine 来进行处理，同时 goroutine 中可能又会启动其他 goroutine 去处理，但是，一旦请求需要终止，这些 goroutine 需要被通知退出，以避免溢出。context 包的设计就是用来在单个请求中的不同 goroutine 之间同步特定数据，以及设置取消，超时信号，当请求被终止的时候，通知所有的 goroutine 结束。</p> <h2 id="context-context-接口"><a href="#context-context-接口" class="header-anchor">#</a> context.Context 接口</h2> <p>context 包中的核心便是 context.Context 接口，定义了四个方法，从中基本也可以看出了 context 支持的用途：</p> <ul><li><code>Done()</code> 函数返回一个只读 channel，供 goroutine 从中获取值，如果拿到了值，说明 context 被取消，通知该 goroutine 应该退出</li> <li><code>Err()</code> 函数返回 context 被取消的错误信息，是被取消还是超时，还是超过了 deadline 等。</li> <li><code>Deadline()</code> 函数返回什么时间该 context 将被取消。</li> <li><code>Value(key)</code> 函数返回注册到该 context 中的 key 对应的 value 信息。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// A Context carries a deadline, cancelation signal, and request-scoped values</span>
<span class="token comment">// across API boundaries. Its methods are safe for simultaneous use by multiple</span>
<span class="token comment">// goroutines.</span>
<span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// Done returns a channel that is closed when this Context is canceled</span>
    <span class="token comment">// or times out.</span>
    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// Err indicates why this context was canceled, after the Done channel</span>
    <span class="token comment">// is closed.</span>
    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

    <span class="token comment">// Deadline returns the time when this Context will be canceled, if any.</span>
    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>

    <span class="token comment">// Value returns the value associated with key or nil if none.</span>
    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="context-的树结构"><a href="#context-的树结构" class="header-anchor">#</a> context 的树结构</h2> <p>context 的设计是一棵树，当声明一个 context 的时候都需要传入一个父 context，以此形成了树结构，当父 context 的行为发生变化时，比如执行取消函数，该 context 下的所有 子 context 都会执行取消（当然子 context 派生的 context 也会被取消），从而实现了通过 context 来跟踪控制所有相关联的 goroutines。既然是树结构，肯定会有 root 节点， context 包中 root 节点被设计成永远不会被取消，并且提供了两个现成的实现  <code>context.Background()</code> 和 <code>context.TODO()</code>，大部分情况下都应该用 <code>context.Background()</code> 作为 root 节点:</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// An emptyCtx is never canceled, has no values, and has no deadline. It is not</span>
<span class="token comment">// struct{}, since vars of this type must have distinct addresses.</span>
<span class="token keyword">type</span> emptyCtx <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> e <span class="token punctuation">{</span>
	<span class="token keyword">case</span> background<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;context.Background&quot;</span>
	<span class="token keyword">case</span> todo<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;context.TODO&quot;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">&quot;unknown empty Context&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	background <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
	todo       <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{</span>
	<span class="token keyword">return</span> background
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{</span>
	<span class="token keyword">return</span> todo
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="context-包提供的四个功能"><a href="#context-包提供的四个功能" class="header-anchor">#</a> context 包提供的四个功能</h3> <p>下面是 4 个 <code>with</code> 开头函数，代表了 context 提供的四个功能，每个函数最后都返回一个 <code>Context</code> 接口，因此这四类 Context 可以彼此任意作为父子 context 来继承，形成链式调用，以实现复杂的需求。下面会详细分析四类 context 的实现。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// </span>
<span class="token keyword">func</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelFunc<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">WithValue</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> Context
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="context-withcancel"><a href="#context-withcancel" class="header-anchor">#</a> context.WithCancel</h2> <p><code>context.WithCancel</code> 函数传入一个父 context 并基于此返回了一个子 Context 接口和一个 cancel 函数，当调用 cancel 函数时，将取消 context，控制所有传入该 context 的 groutines 结束。下面分析代码实现：</p> <ul><li>第一步使用 <code>newCancelCtx</code> 生成了一个 <code>cancelCtx</code> 类型的结构体，该结构体中内嵌了 Context 接口类型，即传入的父 Context。使用 muetx 锁机制确保了类型安全，<code>done</code> channel 在 context 被取消的时候 close 用来通知 goroutine 结束。最后 children 虽然是 map 类型，实际上是一个实现了 <code>canceler</code> 接口的 Set，用来存储子 context 中实现了 <code>canceler</code> 接口的 context，以便在父 context 收到取消指令后，执行子 context 的 cancel 函数。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// A canceler is a context type that can be canceled directly. The</span>
<span class="token comment">// implementations are *cancelCtx and *timerCtx.</span>
<span class="token keyword">type</span> canceler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// A cancelCtx can be canceled. When canceled, it also cancels any children</span>
<span class="token comment">// that implement canceler.</span>
<span class="token keyword">type</span> cancelCtx <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Context

	mu       sync<span class="token punctuation">.</span>Mutex            <span class="token comment">// protects following fields</span>
	done     <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>         <span class="token comment">// created lazily, closed by first cancel call</span>
	children <span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// set to nil by the first cancel call</span>
	err      <span class="token builtin">error</span>                 <span class="token comment">// set to non-nil by the first cancel call</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CancelFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token function">newCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
	<span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// newCancelCtx returns an initialized cancelCtx.</span>
<span class="token keyword">func</span> <span class="token function">newCancelCtx</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> cancelCtx <span class="token punctuation">{</span>
	<span class="token keyword">return</span> cancelCtx<span class="token punctuation">{</span>Context<span class="token punctuation">:</span> parent<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ul><li>第二步是执行 <code>propagateCancel(parent)</code> 函数将该 context 注册到其父 context 的 children 字段中，这一步中判断了 4 种情况：
<ul><li>如果 parent.Done() == nil，即其 <code>parent</code> 是 <code>context.Background</code> 这种默认实现，直接返回，无需注册。</li> <li>判断 <code>parent</code> 的类型是否是 <code>*cancelCtx</code> 类型，目前有三种类型 <code>*cancelCtx</code>、<code>*timerCtx</code> 或者 <code>*valueCtx</code>。除了 <code>*valueCtx</code>, 其余两种内部都包含 <code>cancelCtx</code>。注意这里 <code>parentCancelCtx</code> 函数会一直的往上找，直到根 context 或者最近的包含 cancelCtx 结构体的父 context。</li> <li>如果是该类型并且 <code>p.err != nil</code>，说明父 context 已经执行取消执行，此时该创建出的 context 已经没有意义，需要立即执行 cancel 函数。</li> <li>如果是该类型并且父 context 没有取消，将创建的 cancelCtx 加入到父 context 的 children 中，以此父 context 便有了管理该 context 的能力。</li> <li>如果不是该类型，比如说 backgroundCtx =&gt; valueCtx =&gt; cancelCtx 这条链就查不到满足的 context，这种情况会起一个 goroutine 来接收 parent 的 done 信号，如果收到信号，执行 <code>child.cancel(false, parent.Err())</code> 并退出 goroutine，如果收到自己主动取消的 done 信号，退出 goroutine。</li></ul></li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// propagateCancel arranges for child to be canceled when parent is.</span>
<span class="token keyword">func</span> <span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> child canceler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> parent<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token comment">// parent is never canceled</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">parentCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// parent has already been canceled</span>
			child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> p<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				p<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>parent<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parent<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>child<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// parentCancelCtx follows a chain of parent references until it finds a</span>
<span class="token comment">// *cancelCtx. This function understands how each of the concrete types in this</span>
<span class="token comment">// package represents its parent.</span>
<span class="token keyword">func</span> <span class="token function">parentCancelCtx</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cancelCtx<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> c <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>cancelCtx<span class="token punctuation">:</span>
			<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token boolean">true</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>timerCtx<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>c<span class="token punctuation">.</span>cancelCtx<span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token comment">// 遇到 valueCtx 继续往上查找</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>valueCtx<span class="token punctuation">:</span>
			parent <span class="token operator">=</span> c<span class="token punctuation">.</span>Context
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><ul><li><p>第三步返回了一个 <code>func() { c.cancel(true, Canceled) }</code> cancelFunc 类型的函数，我们来分析下 cancel 函数做的事情：</p> <ul><li>这是一个闭包封装了 cancelCtx 中的 cancel 函数。该函数在执行的时候会设置锁，主要做了三件事情：
<ul><li>关闭掉 <code>c.done</code> channel，让监听该 context 的 goroutine 退出。</li> <li>然后 for 循环遍历 <code>c.children</code> 中，分别执行 <code>child.cancel(false, err)</code> 函数递归的关闭掉了子 context 的 done channel，从而实现了取消信号的传递，之后将 <code>c.children</code> 置为 nil。注意代码中的注释，执行这一步的时候，不仅会持有该 context 的锁，子 context 的锁也会被持有。</li> <li>最后，如果该 context 是主动关闭，将从其 parent 中移除掉该 context。</li></ul></li></ul></li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// cancel closes c.done, cancels each of c's children, and, if</span>
<span class="token comment">// removeFromParent is true, removes c from its parent's children.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cancelCtx<span class="token punctuation">)</span> <span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;context: internal error: missing cancel error&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token comment">// already canceled</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>err <span class="token operator">=</span> err
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>done <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>done <span class="token operator">=</span> closedchan
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>done<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> child <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>children <span class="token punctuation">{</span>
		<span class="token comment">// NOTE: acquiring the child's lock while holding parent's lock.</span>
		child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token boolean">nil</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> removeFromParent <span class="token punctuation">{</span>
		<span class="token function">removeChild</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ul><li>最后顺便分析下 <code>Done()</code> 函数的实现:</li></ul> <p><code>Done()</code> 函数实际上就是初始化该 context 的 done channel，然后返回给调用方。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cancelCtx<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>done <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	d <span class="token operator">:=</span> c<span class="token punctuation">.</span>done
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> d
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="context-withvalue"><a href="#context-withvalue" class="header-anchor">#</a> context.WithValue</h2> <p><code>context.WithValue</code> 函数携带一个 key-value 的信息，并只会返回一个 Context 接口，而且永远不会被取消。其核心是一个 Value 函数，通过 key 来获取 value，如果不匹配，递归的检查其父 context 的 value 方法中有没有存储该值，这里实际上有个问题，如果 父 context 是 valueCtx，自然可以往上找，如果两个 valueCtx 中间被 cancelCtx 隔开，那么便不能一直往上找了，因为 cancelCtx 的 Value 函数返回了 nil。例如 valueCtx =&gt; cancelCtx =&gt; valueCtx 这种情况。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">WithValue</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> Context <span class="token punctuation">{</span>
	<span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;nil key&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>reflectlite<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Comparable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;key is not comparable&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>valueCtx<span class="token punctuation">{</span>parent<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// A valueCtx carries a key-value pair. It implements Value for that key and</span>
<span class="token comment">// delegates all other calls to the embedded Context.</span>
<span class="token keyword">type</span> valueCtx <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Context
	key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>valueCtx<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">contextName</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.WithValue(type &quot;</span> <span class="token operator">+</span>
		reflectlite<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
		<span class="token string">&quot;, val &quot;</span> <span class="token operator">+</span> <span class="token function">stringify</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>valueCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>key <span class="token operator">==</span> key <span class="token punctuation">{</span>
		<span class="token keyword">return</span> c<span class="token punctuation">.</span>val
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Context<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="context-withtimeout-和-context-withdeadline"><a href="#context-withtimeout-和-context-withdeadline" class="header-anchor">#</a> context.WithTimeout 和 context.WithDeadline</h2> <p>这两个放在一块介绍是因为本质上这两个是一样的，都是 timerCtx 结构体实现的。只不过一个是过时间间隔取消，一个是过具体时间取消。通过下面的代码也可以看出来了，所以只对 <code>WithDeadline</code> 做介绍。</p> <p><code>WithDeadline</code> 传入两个参数分别是 父 context 和 deadline 时间，返回 <code>timerCtx</code> 结构体。该结构体内嵌了 cancelCtx（因为总归是要取消的嘛），一个 timer 定时器以及 deadline 时间。</p> <p><code>WithDeadline</code> 函数的具体实现如下：</p> <ul><li><p>先检查了 <code>parent.Deadline()</code> 是否存在，如果存在并且 deadline 时间要在当前 context 的 deadline 之前，直接以 <code>withCancel</code> 创建 context。因为父 context 的 deadline 更早，当父 context 执行的时候会关闭子 context，子 context 再设置时间已经没有意义了。</p></li> <li><p>初始化 <code>timerCtx</code> 结构体，内嵌 cancelCtx 结构体，在初始化 <code>newCancelCtx</code> 的时候传入了 parent，所以实际上继承关系为 <code>parent =&gt; cancelCtx =&gt; timerCtx</code>。然后执行 <code>propagateCancel</code> 函数（上面已经介绍过）将创建好的 context 注册进 parent 的 children 中。</p></li> <li><p>检查 deadline 是否已经过了，如果过了，直接执行 <code>c.cancel(true, DeadlineExceeded)</code>，依旧返回了 context 和 cancel 函数，下次再调用 cancel 函数会直接返回，因为 cancelCtx.err 已经不再为空。</p></li> <li><p>如果时间没过，初始化一个定时器 timer， 在定时器时间到的时候执行 <code>c.cancel(true, DeadlineExceeded)</code> 函数。</p></li> <li><p>最后还是会返回 context 和 cancel 函数，允许在时间没到的时候手动调用函数结束 context。</p></li> <li><p>最后注意 cancel 函数的实现，主要的逻辑还是调用了 <code>cancelCtx.cancel</code> 函数，但也做了一些额外的工作，比如说关闭定时器。</p></li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> timerCtx <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	cancelCtx
	timer <span class="token operator">*</span>time<span class="token punctuation">.</span>Timer <span class="token comment">// Under cancelCtx.mu.</span>

	deadline time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> d time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> cur<span class="token punctuation">,</span> ok <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> cur<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// The current deadline is already sooner than the new one.</span>
		<span class="token keyword">return</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>timerCtx<span class="token punctuation">{</span>
		cancelCtx<span class="token punctuation">:</span> <span class="token function">newCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">,</span>
		deadline<span class="token punctuation">:</span>  d<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	dur <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	<span class="token keyword">if</span> dur <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> DeadlineExceeded<span class="token punctuation">)</span> <span class="token comment">// deadline has already passed</span>
		<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">)</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>timer <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>dur<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> DeadlineExceeded<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>timerCtx<span class="token punctuation">)</span> <span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>cancelCtx<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token keyword">if</span> removeFromParent <span class="token punctuation">{</span>
		<span class="token comment">// Remove this timerCtx from its parent cancelCtx's children.</span>
		<span class="token function">removeChild</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cancelCtx<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>timer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h2 id="context-的最佳实践"><a href="#context-的最佳实践" class="header-anchor">#</a> context 的最佳实践</h2> <p>至此，context 包就介绍完了，<a href="https://golang.org/pkg/context/" target="_blank" rel="noopener noreferrer">go 官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中也给出了 context 包的一些最佳实践：</p> <ul><li>不要在一个结构体中使用 context，相反的，应该作为函数的第一个参数将 context 显式的传入，标准命名是 <code>ctx</code>。</li> <li>不要传入一个空的 Context，如果不确定使用哪个 context，请使用 <code>context.TODO()</code>。</li> <li>使用 value Context 的时候，仅仅将请求范围内的数据传传入，不要将函数的可选参数也传入。</li> <li>可以将相同的 context 传给不同的 goroutine，context 由多个 goroutine 同步使用是安全的。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/golang/flag_pkg_source_code.html" class="prev">
        flag 包源码解析
      </a></span> <span class="next"><a href="/blog/golang/reflect_pkg_source_code_1.html">
        reflect 包 DeepEqual 函数源码解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.2efd3993.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/26.b745054e.js" defer></script>
  </body>
</html>
