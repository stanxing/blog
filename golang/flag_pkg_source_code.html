<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>flag 包源码解析 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.8ad36d1f.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/27.79342037.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.488e1876.js"><link rel="prefetch" href="/blog/assets/js/23.62f3df12.js"><link rel="prefetch" href="/blog/assets/js/24.ed2866c4.js"><link rel="prefetch" href="/blog/assets/js/25.e7705e24.js"><link rel="prefetch" href="/blog/assets/js/26.fa80b953.js"><link rel="prefetch" href="/blog/assets/js/28.224192e2.js"><link rel="prefetch" href="/blog/assets/js/29.2713351c.js"><link rel="prefetch" href="/blog/assets/js/3.d2edf95a.js"><link rel="prefetch" href="/blog/assets/js/30.7b69fe57.js"><link rel="prefetch" href="/blog/assets/js/31.35b40577.js"><link rel="prefetch" href="/blog/assets/js/32.131aec90.js"><link rel="prefetch" href="/blog/assets/js/33.0f3c446a.js"><link rel="prefetch" href="/blog/assets/js/34.4786b108.js"><link rel="prefetch" href="/blog/assets/js/35.3c498c3e.js"><link rel="prefetch" href="/blog/assets/js/36.bfbf82b4.js"><link rel="prefetch" href="/blog/assets/js/37.30b8f1ad.js"><link rel="prefetch" href="/blog/assets/js/38.1148a674.js"><link rel="prefetch" href="/blog/assets/js/39.5eeb7b08.js"><link rel="prefetch" href="/blog/assets/js/4.40ca436a.js"><link rel="prefetch" href="/blog/assets/js/40.d6375d92.js"><link rel="prefetch" href="/blog/assets/js/41.002bc860.js"><link rel="prefetch" href="/blog/assets/js/42.1461c1b7.js"><link rel="prefetch" href="/blog/assets/js/43.b0f5584f.js"><link rel="prefetch" href="/blog/assets/js/44.1a945646.js"><link rel="prefetch" href="/blog/assets/js/45.118e3170.js"><link rel="prefetch" href="/blog/assets/js/46.429c0def.js"><link rel="prefetch" href="/blog/assets/js/47.a7e5ccc7.js"><link rel="prefetch" href="/blog/assets/js/48.68bc81c8.js"><link rel="prefetch" href="/blog/assets/js/49.c6a9737f.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.62270785.js"><link rel="prefetch" href="/blog/assets/js/6.dc656f0b.js"><link rel="prefetch" href="/blog/assets/js/7.bda6ec64.js"><link rel="prefetch" href="/blog/assets/js/8.cf18d63f.js"><link rel="prefetch" href="/blog/assets/js/9.cc1fc44e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Golang</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/golang/effective_go.html" class="sidebar-link">读 Effective Go 总结</a></li><li><a href="/blog/golang/flag_pkg_source_code.html" class="active sidebar-link">flag 包源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/golang/flag_pkg_source_code.html#用法" class="sidebar-link">用法</a></li><li class="sidebar-sub-header"><a href="/blog/golang/flag_pkg_source_code.html#数据结构" class="sidebar-link">数据结构</a></li><li class="sidebar-sub-header"><a href="/blog/golang/flag_pkg_source_code.html#结尾" class="sidebar-link">结尾</a></li></ul></li><li><a href="/blog/golang/context_pkg_source_code.html" class="sidebar-link">context 包源码解析</a></li><li><a href="/blog/golang/reflect_pkg_source_code_1.html" class="sidebar-link">reflect 包 DeepEqual 函数源码解析</a></li><li><a href="/blog/golang/map_type_1.html" class="sidebar-link">关于 map 类型的思考</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="flag-包源码解析"><a href="#flag-包源码解析" class="header-anchor">#</a> flag 包源码解析</h1> <p>本文代码和测试均基于 golang 1.13.4。</p> <h2 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h2> <p>flag 包的主要用途是用来解析命令行参数。根据文档中的介绍，使用方式也很简单，例如定义一个命令行参数 <code>log-level</code>, 类型是 int，实现代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 通过下面命令即可传入命令行参数</span>
<span class="token comment">// go run main.go --log-level=2</span>

<span class="token keyword">import</span> <span class="token string">&quot;flag&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// flag.Int 的三个参数含义分别是：命令行参数名称，命令行参数默认值，命令行使用帮助</span>
    logLevel <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;log-level&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;help message for log level&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里值得注意的是，代码 <code>flag.Int()</code> 的返回值是一个指针，实际上包里所有定义参数类型的方法都返回的是指针，所以如果需要后面的代码中使用 <code>logLevel</code>，应该使用 <code>*logLevel</code> 来获取该变量的值。不过 flag 包中也提供了第二种方式来定义命令行参数，代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> logLevel <span class="token builtin">int</span>
<span class="token comment">// 参数含义同上，只不过函数增加了一个参数存放要定义的变量的指针</span>
<span class="token comment">// 这行代码会将命令行参数解析到的值或者默认值绑定到变量 logLevel 上</span>
flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flagVar<span class="token punctuation">,</span> <span class="token string">&quot;log-level&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;help message for log level&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在定义完所有的参数后，使用 <code>flag.Parse()</code> 即可将所有的参数解析到对应的变量里，当然在不报错的情况下，报错的情况另行分析。</p> <p>在命令行中，<code>flag</code> 包支持以下几种命令参数写法的解析：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>-flag / --flag // 只支持 boolean 类型，意味着 -flag<span class="token operator">=</span>true
-flag<span class="token operator">=</span>x / --flag<span class="token operator">=</span>x
-flag x / --flag x // 这种类型不允许 boolean 类型使用
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>需要注意的是：</p> <ul><li>命令行参数之前使用一个中划线或者两个中划线的形式是等价的</li> <li><code>-flag x</code> 这种形式不支持 boolean 类型，根据文档中的介绍，如果想要设置，应该显式的使用 <code>-flag=false</code> 来设置。</li> <li>flag 解析停止在第一个非 <code>-</code> 开头的参数或者在终端终止符 <code>--</code> 之后结束。</li> <li><code>1, 0, t, f, T, F, true, false, TRUE, FALSE, True, False</code> 都可以作为 boolean 类型。</li></ul> <h3 id="为什么-boolean-类型不支持-flag-x-的形式"><a href="#为什么-boolean-类型不支持-flag-x-的形式" class="header-anchor">#</a> 为什么 boolean 类型不支持 <code>--flag x</code> 的形式</h3> <p>当读文档看到整个限制时，第一眼是感到疑惑，首先看 godoc 中的解释：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-flag x  // non-boolean flags only

One or two minus signs may be used; they are equivalent. The last form is not permitted for boolean flags because the meaning of the command

cmd -x *

where * is a Unix shell wildcard, will change if there is a file called 0, false, etc. You must use the -flag=false form to turn off a boolean flag.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>官方中写到原因是因为一个命令 <code>cmd -x *</code> 中的最末尾的参数可能是一个文件，假设整个文件名称叫做 <code>false</code> 和 <code>0</code>，那么就可能造成解析错误。官方这个解释给的挺牵强，我并没有看懂，恰好在 <a href="https://github.com/golang/go/issues/22961" target="_blank" rel="noopener noreferrer">go 官方 issue <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中搜到了相关的讨论，拿出来做个分享：</p> <ul><li>如果 boolean 类型总是需要设置一个值，那么就要写成 <code>cmd -boolflag true *</code> 或者 <code>cmd -boolflag=true *</code> 这种样式，但是这种样式不是人们所习惯的，人们习惯直接 <code>-boolflag</code> 就代表 <code>true</code>。</li> <li>但是同时要支持 <code>-boolflag</code> 和 <code>-boolflag x</code> 的话，<code>-boolflag</code> 到底是代表 <code>true</code> 还是 <code>x</code>，就要看 <code>x</code> 的值，如果它是个 bool，那么就代表 <code>x</code>，如果不是，它就代表 <code>true</code>。这样是会有歧义的而且是危险的。</li> <li>对于非 boolean 类型来说，<code>-nonboolflag x</code> 后面肯定要跟一个值，所以不存在歧义。</li> <li>issue 中还提供了一个非常好的例子来解释，比如 <code>ls -l false</code>，它会列出叫做 false 文件的属性，而不是设置 -l 的值为 false。</li></ul> <p>该 issue 后面还讨论了很多，我这里只截取了官方对这种行为的解释，我个人认为是可以理解的，毕竟 golang 要作为语言平台来兼容所有的情况，而不是应用程序层面。</p> <h2 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h2> <h3 id="flag-struct"><a href="#flag-struct" class="header-anchor">#</a> Flag struct</h3> <p>Flag 整个结构体定义如下，它代表着一个命令行参数实例，其中 <code>Name</code>, <code>Usage</code> 很好理解，注意 <code>DefValue</code> 说的的默认值并不是函数 <code>flag.Int()</code>中传入的那个默认值，是指绑定变量的实际值的字符串形式。最重要的便是 <code>Value</code> 这个数据结构，其类型是一个接口。<code>Flag</code> 这个结构体便是通过这个接口做到了存储任何实现了 <code>Value</code> 接口的数据类型的值。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// A Flag represents the state of a flag.</span>
<span class="token keyword">type</span> Flag <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name     <span class="token builtin">string</span> <span class="token comment">// name as it appears on command line</span>
	Usage    <span class="token builtin">string</span> <span class="token comment">// help message</span>
	Value    Value  <span class="token comment">// value as set</span>
	DefValue <span class="token builtin">string</span> <span class="token comment">// default value (as text); for usage message</span>
<span class="token punctuation">}</span>

<span class="token comment">// Value is the interface to the dynamic value stored in a flag.</span>
<span class="token comment">// (The default value is represented as a string.)</span>
<span class="token comment">//</span>
<span class="token comment">// If a Value has an IsBoolFlag() bool method returning true,</span>
<span class="token comment">// the command-line parser makes -name equivalent to -name=true</span>
<span class="token comment">// rather than using the next command-line argument.</span>
<span class="token comment">//</span>
<span class="token comment">// Set is called once, in command line order, for each flag present.</span>
<span class="token comment">// The flag package may call the String method with a zero-valued receiver,</span>
<span class="token comment">// such as a nil pointer.</span>
<span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">Set</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><code>Value</code> 接口很简单，只有 <code>String()</code> 和 <code>Set()</code> 两个方法，通过看一组例子就明白 flag 包是如何做到的，并且据此我们该如何实现自定义的参数类型。</p> <p>下面这段代码是 flag 包中绑定 int 类型变量的实现，首先定义了 int 类型的别名 <code>intValue</code>，主要是为了对其实现 <code>Value</code> 的接口方法，这样 intValue 类型的值便能存储到 <code>Flag</code> 中。注意，这里是<code>intValue 指针</code> 实现了接口，并不是 <code>intValue</code> 值类型实现的。<code>String()</code> 方法的实现很简单，就是将该 int 变量转换成字符串，实际用在了打印帮助的信息时候；<code>Set()</code> 方法是将命令行参数字符串解析成 int 类型，并和给定的变量绑定，完成赋值的目的。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// -- int Value</span>
<span class="token keyword">type</span> intValue <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>intValue<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	v<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span>IntSize<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		err <span class="token operator">=</span> <span class="token function">numError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token operator">*</span>i <span class="token operator">=</span> <span class="token function">intValue</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>intValue<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>intValue<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="flagset-struct"><a href="#flagset-struct" class="header-anchor">#</a> FlagSet struct</h3> <p>顾名思义，<code>FlagSet</code> 就是一个存储所有命令行参数的集合，其数据结构如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// A FlagSet represents a set of defined flags. The zero value of a FlagSet</span>
<span class="token comment">// has no name and has ContinueOnError error handling.</span>
<span class="token keyword">type</span> FlagSet <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Usage is the function called when an error occurs while parsing flags.</span>
	<span class="token comment">// The field is a function (not a method) that may be changed to point to</span>
	<span class="token comment">// a custom error handler. What happens after Usage is called depends</span>
	<span class="token comment">// on the ErrorHandling setting; for the command line, this defaults</span>
	<span class="token comment">// to ExitOnError, which exits the program after calling Usage.</span>
	Usage <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	name          <span class="token builtin">string</span>
	parsed        <span class="token builtin">bool</span>
	actual        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag
	formal        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag
	args          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// arguments after flags</span>
	errorHandling ErrorHandling
	output        io<span class="token punctuation">.</span>Writer <span class="token comment">// nil means stderr; use out() accessor</span>
<span class="token punctuation">}</span>

<span class="token comment">// These constants cause FlagSet.Parse to behave as described if the parse fails.</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	ContinueOnError ErrorHandling <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// Return a descriptive error.</span>
	ExitOnError                          <span class="token comment">// Call os.Exit(2).</span>
	PanicOnError                         <span class="token comment">// Call panic with a descriptive error.</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>接下来对照着结构体解释下各字段的含义：</p> <ul><li><code>Usage</code> 是一个 function 类型，意思是当解析报错的时候，用来打印报错信息，具体的实现可以参考文章后面。</li> <li><code>name</code> 代表该 <code>FlagSet</code> 的名称，值为 <code>os.Args[0]</code> 的结果，即执行文件的完整路径。</li> <li><code>parsed</code> 标识是否被解析</li> <li><code>actual</code> 类型是一个 Flag 集合，代表实际从命令行参数中解析出来的参数集合。</li> <li><code>formal</code> 类型也是一个 Flag 集合，代表代码中定义的默认的参数集合。（一般实际的参数会小于或等于默认定义的参数）</li> <li><code>errorHandling</code> 其类型实际是个枚举值，参见上面代码描述，默认的 FlagSet 中该值为 <code>ExitOnError</code></li> <li><code>output</code></li></ul> <h3 id="解析过程"><a href="#解析过程" class="header-anchor">#</a> 解析过程</h3> <p>以解析一个 int 类型为例，当我们在代码中写下下面两行代码时，便完成了命令行参数 <code>log-level</code> 和代码中的 int 变量 <code>logLevel</code> 的绑定。我们通过源码来分析下 flag 包是怎么实现的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;flag&quot;</span>
logLevel <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;log-level&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;help message for log level&quot;</span><span class="token punctuation">)</span>
flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>首先，在 <code>import &quot;flag&quot;</code> 包的过程中，执行了包中的变量声明和 <code>init()</code> 函数。<code>CommandLine</code> 变量被实例化为了一个 <code>FlagSet</code> 实例。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// CommandLine is the default set of command-line flags, parsed from os.Args.</span>
<span class="token comment">// The top-level functions such as BoolVar, Arg, and so on are wrappers for the</span>
<span class="token comment">// methods of CommandLine.</span>
<span class="token keyword">var</span> CommandLine <span class="token operator">=</span> <span class="token function">NewFlagSet</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ExitOnError<span class="token punctuation">)</span>

<span class="token comment">// NewFlagSet returns a new, empty flag set with the specified name and</span>
<span class="token comment">// error handling property. If the name is not empty, it will be printed</span>
<span class="token comment">// in the default usage message and in error messages.</span>
<span class="token keyword">func</span> <span class="token function">NewFlagSet</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> errorHandling ErrorHandling<span class="token punctuation">)</span> <span class="token operator">*</span>FlagSet <span class="token punctuation">{</span>
	f <span class="token operator">:=</span> <span class="token operator">&amp;</span>FlagSet<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span>          name<span class="token punctuation">,</span>
		errorHandling<span class="token punctuation">:</span> errorHandling<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>Usage <span class="token operator">=</span> f<span class="token punctuation">.</span>defaultUsage
	<span class="token keyword">return</span> f
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Override generic FlagSet default Usage with call to global Usage.</span>
	<span class="token comment">// Note: This is not CommandLine.Usage = Usage,</span>
	<span class="token comment">// because we want any eventual call to use any updated value of Usage,</span>
	<span class="token comment">// not the value it has when this line is run.</span>
	CommandLine<span class="token punctuation">.</span>Usage <span class="token operator">=</span> commandLineUsage
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li>执行 <code>flag.Int()</code> 方法时，调用了 <code>CommandLine.Int()</code> 方法，整个方法很简单，就是使用 <code>new</code> 关键词分配内存空间，创建了一个 int 类型的零值，返回指针 <code>p</code>， 又调用了 <code>f.IntVar()</code> 使用 <code>newIntValue</code> 函数将默认值和 p 指针绑定， 注意 int 被强转成了 intValue，此时 p 是指向默认值的指针。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Int defines an int flag with specified name, default value, and usage string.</span>
<span class="token comment">// The return value is the address of an int variable that stores the value of the flag.</span>
<span class="token keyword">func</span> <span class="token function">Int</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">int</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> CommandLine<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Int defines an int flag with specified name, default value, and usage string.</span>
<span class="token comment">// The return value is the address of an int variable that stores the value of the flag.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FlagSet<span class="token punctuation">)</span> <span class="token function">Int</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">int</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
	p <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
	<span class="token keyword">return</span> p
<span class="token punctuation">}</span>

<span class="token comment">// IntVar defines an int flag with specified name, default value, and usage string.</span>
<span class="token comment">// The argument p points to an int variable in which to store the value of the flag.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FlagSet<span class="token punctuation">)</span> <span class="token function">IntVar</span><span class="token punctuation">(</span>p <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">int</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span><span class="token function">Var</span><span class="token punctuation">(</span><span class="token function">newIntValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newIntValue</span><span class="token punctuation">(</span>val <span class="token builtin">int</span><span class="token punctuation">,</span> p <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>intValue <span class="token punctuation">{</span>
	<span class="token operator">*</span>p <span class="token operator">=</span> val
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>intValue<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li>接着又调用了 <code>f.Var()</code> 函数，将该 int 类型的值存入 <code>Flag</code> 实例中，其中 <code>Flag</code> 实例中的 <code>DefValue</code> 存入了默认值的字符串表示。<br>
其次检查命令行参数名称是否在 <code>f.formal</code> 整个 map 中存在，如果存在，报错；否则将该 <code>Flag</code> 实例插入到 <code>f.formal</code> 中。至此，初始化 int 变量默认值执行完毕。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Var defines a flag with the specified name and usage string. The type and</span>
<span class="token comment">// value of the flag are represented by the first argument, of type Value, which</span>
<span class="token comment">// typically holds a user-defined implementation of Value. For instance, the</span>
<span class="token comment">// caller could create a flag that turns a comma-separated string into a slice</span>
<span class="token comment">// of strings by giving the slice the methods of Value; in particular, Set would</span>
<span class="token comment">// decompose the comma-separated string into the slice.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FlagSet<span class="token punctuation">)</span> <span class="token function">Var</span><span class="token punctuation">(</span>value Value<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Remember the default value as a string; it won't change.</span>
	flag <span class="token operator">:=</span> <span class="token operator">&amp;</span>Flag<span class="token punctuation">{</span>name<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> value<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> alreadythere <span class="token operator">:=</span> f<span class="token punctuation">.</span>formal<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
	<span class="token keyword">if</span> alreadythere <span class="token punctuation">{</span>
		<span class="token keyword">var</span> msg <span class="token builtin">string</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			msg <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;flag redefined: %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			msg <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s flag redefined: %s&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token comment">// Happens only if flags are declared with identical names</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>formal <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>formal <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>formal<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> flag
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>调用 <code>flag.Parse()</code> 后，就开始了解析命令行参数的值绑定到变量的过程，也是按照顺序解释代码。这一步调用了 <code>CommandLine.Parse()</code> 方法, 其中 <code>os.Args[1:]</code> 即为执行文件后面剩下的参数信息。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Parse parses the command-line flags from os.Args[1:]. Must be called</span>
<span class="token comment">// after all flags are defined and before flags are accessed by the program.</span>
<span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Ignore errors; CommandLine is set for ExitOnError.</span>
	CommandLine<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><code>CommandLine.Parse()</code> 方法使用 for 循环分别解析 arguments 参数传入的值，核心方法便是 <code>f.parseOne()</code>。<code>f.parsed = true f.args = arguments</code> 这两步分别赋值。<br>
如果遇到错误，那么就根据 <code>f.errorHandling</code> 设置的值来判断该退出还是该继续，默认是 <code>ExitOnError</code>。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Parse parses flag definitions from the argument list, which should not</span>
<span class="token comment">// include the command name. Must be called after all flags in the FlagSet</span>
<span class="token comment">// are defined and before flags are accessed by the program.</span>
<span class="token comment">// The return value will be ErrHelp if -help or -h were set but not defined.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FlagSet<span class="token punctuation">)</span> <span class="token function">Parse</span><span class="token punctuation">(</span>arguments <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>parsed <span class="token operator">=</span> <span class="token boolean">true</span>
	f<span class="token punctuation">.</span>args <span class="token operator">=</span> arguments
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		seen<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">parseOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> seen <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> f<span class="token punctuation">.</span>errorHandling <span class="token punctuation">{</span>
		<span class="token keyword">case</span> ContinueOnError<span class="token punctuation">:</span>
			<span class="token keyword">return</span> err
		<span class="token keyword">case</span> ExitOnError<span class="token punctuation">:</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> PanicOnError<span class="token punctuation">:</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ul><li><code>f.ParseOne()</code> 比较复杂，继续按步骤分析代码：
<ul><li>首先取 <code>s = f.args[0]</code> 为第一段参数，如果 s 长度小于 2 或者第一个字符不是 <code>-</code>， 直接退出，这种情况说明已经遍历参数到了最尾端，需要跳出参数解析了。</li> <li>不满足上述情况的 s 说明是个有效的命令行参数，如果 s 的第2个字符也是 <code>-</code>， 说明整个参数开头是 <code>--</code>，如果整个 s 就等于 <code>--</code>，说明这解析到了终端的终止符，需要跳出解析了。</li> <li><code>name := s[numMinuses:]</code>，去掉 <code>-</code> 或者 <code>--</code> 前缀后，如果 name 长度为 0 或者第一位字符还是个 <code>-</code> 或者是个 <code>=</code>，这是非法的，跳出解析，并且抛错。</li> <li><code>f.args = f.args[1:]</code> 这一步保留了后面的参数供下次循环解析。</li> <li>如果 <code>name</code> 中包含 <code>=</code>，假设 <code>=</code> 在字符串中的序号是 i，那么将 name[0：i] 作为 name，把 name[i+1:] 作为 value，解析成功。（注意这里 value 可能为 boolean 值）</li> <li><code>flag, alreadythere := m[name]</code>，去 f.formal 中检查有没有这个 <code>name</code>，如果不存在，说明在命令行参数中提供了，可是代码中却没有定义。这里要分两种情况：
<ul><li>如果代码中没定义的这个 name 是 <code>help</code> 或者 <code>h</code>，那么打印帮助信息，并抛错 errHelp。</li> <li>如果不属于这两个，直接抛错，flag 未定义。</li></ul></li> <li>到目前为止如果没抛错的话，现在解析出来的命令行参数 name 一定存在，value 不一定存在，如果参数是 boolean 类型，那么可以分两种情况：
<ul><li>没有 value，那么调用 <code>Set()</code> 方法将 boolean 设置为 <code>true</code>，</li> <li>有 value 的话，如果 value 符合 boolean 定义，那么调用 <code>Set()</code> 方法设置值，不符合抛错，无效的 boolean 类型。</li></ul></li> <li>如果不是 boolean 类型，那么也分两种情况：
<ul><li>有 value 的话，调用 <code>Set()</code> 方法将 value 设置进入对应的变量中</li> <li>没有 value 的话，由于一定需要有一个值，所以从 f.args 中读取下一个元素作为值设置到变量中。代码为：<code>value, f.args = f.args[0], f.args[1:]</code></li></ul></li> <li><code>f.actual[name] = flag</code>，将实际解析到的并 flag 参数存入 <code>f.actual</code> 中。注意，实际上 flag 对象是一个指针， <code>a.formal</code> 中也发生了更改。至此解析结束。</li></ul></li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// parseOne parses one flag. It reports whether a flag was seen.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FlagSet<span class="token punctuation">)</span> <span class="token function">parseOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	s <span class="token operator">:=</span> f<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'-'</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	numMinuses <span class="token operator">:=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'-'</span> <span class="token punctuation">{</span>
		numMinuses<span class="token operator">++</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">{</span> <span class="token comment">// &quot;--&quot; terminates the flags</span>
			f<span class="token punctuation">.</span>args <span class="token operator">=</span> f<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	name <span class="token operator">:=</span> s<span class="token punctuation">[</span>numMinuses<span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'-'</span> <span class="token operator">||</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'='</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">failf</span><span class="token punctuation">(</span><span class="token string">&quot;bad flag syntax: %s&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// it's a flag. does it have an argument?</span>
	f<span class="token punctuation">.</span>args <span class="token operator">=</span> f<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	hasValue <span class="token operator">:=</span> <span class="token boolean">false</span>
	value <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span> <span class="token comment">// equals cannot be first</span>
		<span class="token keyword">if</span> name<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'='</span> <span class="token punctuation">{</span>
			value <span class="token operator">=</span> name<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			hasValue <span class="token operator">=</span> <span class="token boolean">true</span>
			name <span class="token operator">=</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	m <span class="token operator">:=</span> f<span class="token punctuation">.</span>formal
	flag<span class="token punctuation">,</span> alreadythere <span class="token operator">:=</span> m<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token comment">// BUG</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>alreadythere <span class="token punctuation">{</span>
		<span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">&quot;help&quot;</span> <span class="token operator">||</span> name <span class="token operator">==</span> <span class="token string">&quot;h&quot;</span> <span class="token punctuation">{</span> <span class="token comment">// special case for nice help message.</span>
			f<span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ErrHelp
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">failf</span><span class="token punctuation">(</span><span class="token string">&quot;flag provided but not defined: -%s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> fv<span class="token punctuation">,</span> ok <span class="token operator">:=</span> flag<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token punctuation">(</span>boolFlag<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> fv<span class="token punctuation">.</span><span class="token function">IsBoolFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// special case: doesn't need an arg</span>
		<span class="token keyword">if</span> hasValue <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> fv<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">failf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid boolean value %q for -%s: %v&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> fv<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">failf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid boolean flag %s: %v&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// It must have a value, which might be the next argument.</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>hasValue <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token comment">// value is the next arg</span>
			hasValue <span class="token operator">=</span> <span class="token boolean">true</span>
			value<span class="token punctuation">,</span> f<span class="token punctuation">.</span>args <span class="token operator">=</span> f<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>hasValue <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">failf</span><span class="token punctuation">(</span><span class="token string">&quot;flag needs an argument: -%s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> flag<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">failf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid value %q for flag -%s: %v&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>actual <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>actual <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Flag<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>actual<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> flag
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h2 id="结尾"><a href="#结尾" class="header-anchor">#</a> 结尾</h2> <p>至此，flag 包源码基本就分析完了，从中其实可以学到不少东西，比如采用接口以极高的可扩展性来实现存储任意类型，除了包里定义的，根据这套规则可以实现任意结构体和参数的绑定关系。<br>
这部分代码就不实现了，不过有官方文档中提供了的<a href="https://godoc.org/flag#example-Value" target="_blank" rel="noopener noreferrer">自定义类型 URLValue 的例子<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>参考。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/golang/effective_go.html" class="prev">
        读 Effective Go 总结
      </a></span> <span class="next"><a href="/blog/golang/context_pkg_source_code.html">
        context 包源码解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8ad36d1f.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/27.79342037.js" defer></script>
  </body>
</html>
