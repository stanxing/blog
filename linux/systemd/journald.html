<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>journald | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.8ad36d1f.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/45.118e3170.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.488e1876.js"><link rel="prefetch" href="/blog/assets/js/23.62f3df12.js"><link rel="prefetch" href="/blog/assets/js/24.ed2866c4.js"><link rel="prefetch" href="/blog/assets/js/25.e7705e24.js"><link rel="prefetch" href="/blog/assets/js/26.fa80b953.js"><link rel="prefetch" href="/blog/assets/js/27.79342037.js"><link rel="prefetch" href="/blog/assets/js/28.224192e2.js"><link rel="prefetch" href="/blog/assets/js/29.2713351c.js"><link rel="prefetch" href="/blog/assets/js/3.d2edf95a.js"><link rel="prefetch" href="/blog/assets/js/30.7b69fe57.js"><link rel="prefetch" href="/blog/assets/js/31.35b40577.js"><link rel="prefetch" href="/blog/assets/js/32.131aec90.js"><link rel="prefetch" href="/blog/assets/js/33.0f3c446a.js"><link rel="prefetch" href="/blog/assets/js/34.4786b108.js"><link rel="prefetch" href="/blog/assets/js/35.3c498c3e.js"><link rel="prefetch" href="/blog/assets/js/36.bfbf82b4.js"><link rel="prefetch" href="/blog/assets/js/37.30b8f1ad.js"><link rel="prefetch" href="/blog/assets/js/38.1148a674.js"><link rel="prefetch" href="/blog/assets/js/39.5eeb7b08.js"><link rel="prefetch" href="/blog/assets/js/4.40ca436a.js"><link rel="prefetch" href="/blog/assets/js/40.d6375d92.js"><link rel="prefetch" href="/blog/assets/js/41.002bc860.js"><link rel="prefetch" href="/blog/assets/js/42.1461c1b7.js"><link rel="prefetch" href="/blog/assets/js/43.b0f5584f.js"><link rel="prefetch" href="/blog/assets/js/44.1a945646.js"><link rel="prefetch" href="/blog/assets/js/46.429c0def.js"><link rel="prefetch" href="/blog/assets/js/47.a7e5ccc7.js"><link rel="prefetch" href="/blog/assets/js/48.68bc81c8.js"><link rel="prefetch" href="/blog/assets/js/49.c6a9737f.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.62270785.js"><link rel="prefetch" href="/blog/assets/js/6.dc656f0b.js"><link rel="prefetch" href="/blog/assets/js/7.bda6ec64.js"><link rel="prefetch" href="/blog/assets/js/8.cf18d63f.js"><link rel="prefetch" href="/blog/assets/js/9.cc1fc44e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Linux</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Ubuntu</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Systemd</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/linux/systemd/journald.html" class="active sidebar-link">journald</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/linux/systemd/journald.html#journald-介绍" class="sidebar-link">journald 介绍</a></li><li class="sidebar-sub-header"><a href="/blog/linux/systemd/journald.html#syslog-缺点" class="sidebar-link">syslog 缺点</a></li><li class="sidebar-sub-header"><a href="/blog/linux/systemd/journald.html#journalctl-介绍" class="sidebar-link">journalctl 介绍</a></li><li class="sidebar-sub-header"><a href="/blog/linux/systemd/journald.html#参考文档" class="sidebar-link">参考文档</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Shell</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="journald"><a href="#journald" class="header-anchor">#</a> journald</h1> <p>ubuntu 16.04+ 版本采用了 systemd 管理作为系统初始化软件，它是一系列工具的集合，其中系统日志管理模块使用的是 <code>systemd-journald</code> 服务。由于工作中的系统基础架构的日志收集这一块功能使用了 journald 服务，这篇文章记录下对该服务的介绍和踩过的坑。</p> <h2 id="journald-介绍"><a href="#journald-介绍" class="header-anchor">#</a> journald 介绍</h2> <ul><li>journald 是启动在机器中的一个 daemon 进程，这个服务设计的初衷是为了克服现有 syslog 服务的日志内容容器伪造和日志格式不统一的问题，journald 使用二进制格式来存储日志信息，因此日志信息很难被伪造，同时 journald 提供了 journalctl 命令行工具来查看日志信息。</li> <li>日志默认存储在 /run/log/journal/ 中，要想永久保存可以创建 /var/log/journal 目录，并且执行 systemd-tmpfiles --create --prefix /var/log/journal。</li> <li>journald 可以接受 SIGUSR1（等同 journalctl --flush，将 /run/ 中的日志写到 /var/ 中）、SIGUSR2（等同 journalctl --rotate，立即 rotate 日志）、SIGRTMIN+1（等同 journalctl --sync,立即将 cache 中的日志刷写到磁盘中）信号。</li></ul> <h2 id="syslog-缺点"><a href="#syslog-缺点" class="header-anchor">#</a> syslog 缺点</h2> <ul><li>syslog 的日志格式非常宽松，没有定义结构化的日志格式，也无法索引，使得日志的阅读变得困难。</li> <li>syslog 日志项目保存的元数据很有限，缺少一些关键信息，比如服务名、授权进程或者稳定的时间戳。</li> <li>syslog 的 rotate 只是基于时间的，无法基于磁盘使用量实现 rotate。</li> <li>syslog 没有访问控制。</li> <li>syslog 所记录的日志相对单一，与其他日志系统（wtmp, lastlog, audit 等）一起组成了机器上完整的日志系统。</li> <li>Syslog 不处理系统启动早期和关机晚期的日志。</li></ul> <h3 id="journald-优点"><a href="#journald-优点" class="header-anchor">#</a> journald 优点</h3> <ul><li>journald 可以记录二进制的文件，不容易被伪造，并且添加了索引，便于搜索。</li> <li>journald 会为每个登录用户创建独立的日志文件，使用 ACL 实现访问控制，保证每个用户可以访问自己的日志文件。</li> <li>journald 记录了更多的元数据。</li> <li>journald 可以调整输出格式，依据各种字段信息，筛选想要的日志。</li> <li>journald 仍然使用 syslog(3) 收集系统日志，并且支持将日志转发到不同的日志服务中。</li></ul> <h3 id="journald-conf-介绍"><a href="#journald-conf-介绍" class="header-anchor">#</a> journald.conf 介绍</h3> <p>默认配置文件了路径为 <code>/etc/systemd/journald.conf</code>，由于配置项众多，具体的请参考<a href="https://www.freedesktop.org/software/systemd/man/journalctl.html#" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或<a href="http://www.jinbuguo.com/systemd/journald.conf.html#" target="_blank" rel="noopener noreferrer">中文译本<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，下面仅列举在生产环境中遇到的一些值得注意的配置项目：</p> <ul><li><code>Storage</code>：日志存储方式，默认 auto （当 /var/log/journal 不存在的时候存储在 /run/log/journal），可选值有：volatile(/run/log/journal)和 presistent (会创建 /var/log/journal)。</li> <li><code>RateLimitIntervalSec</code> 和 <code>RateLimitBurst</code>：用来限制日志的生成速率。RateLimitIntervalSec= 用于设置一个时间段长度，默认值是30秒。 RateLimitBurst= 用于设置一个正整数，表示消息条数，默认值是10000条。表示在 RateLimitIntervalSec= 时间段内，每个服务最多允许产生 RateLimitBurst= 数量(条数)的日志。在同一个时间段内，超出数量限制的日志将被丢弃，直到下一个时间段才能再次开始记录。对于所有被丢弃的日志消息，仅用一条类似&quot;xxx条消息被丢弃&quot;的消息来代替。这个限制是针对每个服务的限制，一个服务超限并不会影响到另一个服务的日志记录。如果 docker 的 log driver 使用的是 journald，这里很容易就超了，因此，可以将 RateLimitBurst 设置为 <code>0</code>，表示不受限制。</li> <li><code>SystemMaxUse</code> 和 <code>RuntimeMaxUse</code>：限制日志文件的大小上限。以 &quot;System&quot; 开头的选项用于限制磁盘使用量，也就是 /var/log/journal 的使用量。以 &quot;Runtime&quot; 开头的选项用于限制内存使用量，也就是 /run/log/journal 的使用量。<code>SystemMaxUse</code> 与 <code>RuntimeMaxUse</code> 的默认值是10%空间与4G空间两者中的较小者。</li> <li><code>ForwardToSyslog</code> 和 <code>ForwardToKMsg</code>：ForwardToSyslog 表示是否将接收到的日志消息转发给传统的 syslog 守护进程，默认值为&quot;no&quot;。ForwardToKMsg= 表示是否将接收到的日志消息转发给内核日志缓冲区(kmsg)，默认值为&quot;no&quot;。</li></ul> <h2 id="journalctl-介绍"><a href="#journalctl-介绍" class="header-anchor">#</a> journalctl 介绍</h2> <p>journalctl 用于检索有 journald 收集的日志，这里主要介绍一些常用的 journalctl 命令，当作工具来使用。</p> <h3 id="journalctl-命令使用"><a href="#journalctl-命令使用" class="header-anchor">#</a> journalctl 命令使用</h3> <ul><li>journalctl -a 完整显示所有字段内容，即使其中包含非打印字符或者字段内容超长。 默认情况下，包含非打印字符的字段将被缩写为&quot;blob data&quot;(二进制数据)。</li> <li>journalctl -f 类似 tail -f，监控日志输出。</li> <li>journalctl -e 跳转到日志文件末尾。</li> <li>journalctl -n, --lines= 限制显示最新的日志行数。</li> <li>journalctl -r 反转日志行的输出顺序， 也就是最先显示最新的日志。</li> <li>journalctl -o 选择输出格式。可选的几个重要的值如下（全部的请参考文档）：
<ul><li>short，这是默认值，其输出格式与传统的 syslog 文件的格式相似， 每条日志一行。</li> <li>json，将日志项格式化为 JSON 对象，并用换行符分隔(也就是每条日志一行）。</li> <li>json-pretty，将日志项按照JSON数据结构格式化，但是每个字段一行，以便于人类阅读。</li> <li>cat， 仅显示日志的实际内容， 而不显示与此日志相关的 任何元数据(包括时间戳)。</li></ul></li> <li>journalctl --list-boots 列出每次启动的序号。</li> <li>journalctl -b [ID] 显示特定启动的日志，0表示最近一次，-1表示上一次，1表示最早的一次启动。</li> <li>journalctl -x, --catalog 输出日志的一些说明信息。</li> <li>journalctl -k 输出内核日志。</li> <li>journalctl -t, --identifier=SYSLOG_IDENTIFIER 输出指定 syslog 标志符的日志。</li> <li>journalctl -u 输出特定unit的日志。</li> <li>journalctl -p 输出指定优先级的日志。可选的值有：&quot;emerg&quot; (0), &quot;alert&quot; (1), &quot;crit&quot; (2), &quot;err&quot; (3), &quot;warning&quot; (4), &quot;notice&quot; (5), &quot;info&quot; (6), &quot;debug&quot; (7)</li> <li>journalctl -c, --cursor 从指定cursor开始读取日志。</li> <li>journalctl -S, --since, -U, --until 输出从 since 到 until 这个时间段的日志，设为 &quot;now&quot; 以表示当前时间。</li> <li>journalctl -F --field 显示所有日志中指定字段的所有可能值。[译者注]类似于SQL语句：&quot;SELECT DISTINCT 指定字段 FROM 全部日志&quot;。</li> <li>journalctl -N --fields 输出所有日志字段的名称。</li> <li>journalctl --header 此选项并不用于显示日志内容， 而是用于显示 日志文件内部的头信息(类似于元数据)。</li> <li>journalctl --disk-usage 所有日志文件的磁盘占用总量。</li> <li>journalctl --sync --flush 将缓存或者 /var/run/log/journal 的日志写入磁盘。</li> <li>journalctl --rotate 立即执行日志轮转。</li> <li>journalctl --vacuum-size=200M 删除归档日志，使得磁盘占用保留到 200MB</li> <li>journalctl --vacuum-time=1d 删除一天前的全部日志</li> <li>journalctl --verify 验证 jounal 内部日志的一致性（不是很懂什么意思）
<ul><li><a href="http://ju.outofmemory.cn/entry/343962" target="_blank" rel="noopener noreferrer">在这篇文章中<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 记录了一个使用它的具体的案例</li></ul></li></ul> <p>备注：<br>
journalctl 后可以直接跟日志中的字段名称来过滤，其字段名称请使用 <code>journalctl -o jsonpretty</code> 来查看</p> <h3 id="journalctl-例子"><a href="#journalctl-例子" class="header-anchor">#</a> journalctl 例子</h3> <ul><li>journalctl --since &quot;14:10&quot; --until &quot;14:11&quot; 输出特定时间段的日志。</li> <li>journalctl --since &quot;2020-02-20 14:10&quot; --until &quot;2020-02-20 14:11&quot; 输出带日期时间段的日志。</li> <li>journalctl --vacuum-size=500M 保留500M日志文件，其他按时间删除最早的。</li> <li>journalctl --vacuum-time=1days 删除一天前的日志文件。</li> <li>journalctl -o json-pretty  _SYSTEMD_UNIT=docker.service _PID=1021 输出按照 <code>_SYSTEMD_UNIT</code> 和 <code>_PID</code> 字段过滤的日志。</li> <li>journalctl -o json-pretty _SYSTEMD_UNIT=docker.service  _SYSTEMD_UNIT=kubelet.service 当同一字段多次出现时，输出满足其中任意一个条件的日志。</li> <li>journalctl -o json-pretty -u docker.service -u kubelet.service 与上面搜索条件等价。</li></ul> <h2 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h2> <ul><li><a href="http://www.jinbuguo.com/systemd/journalctl.html" target="_blank" rel="noopener noreferrer">金步国<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/linux/ubuntu/postinstall.html" class="prev">
        安装完 ubuntu 后要做的事
      </a></span> <span class="next"><a href="/blog/linux/shell/coding_style.html">
        shell 编码规范
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8ad36d1f.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/45.118e3170.js" defer></script>
  </body>
</html>
