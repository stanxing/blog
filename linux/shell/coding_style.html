<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>shell 编码规范 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.2efd3993.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/44.fe190f21.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.965e5f58.js"><link rel="prefetch" href="/blog/assets/js/23.8248b6b6.js"><link rel="prefetch" href="/blog/assets/js/24.fe6aef0a.js"><link rel="prefetch" href="/blog/assets/js/25.ef479bf5.js"><link rel="prefetch" href="/blog/assets/js/26.b745054e.js"><link rel="prefetch" href="/blog/assets/js/27.e9839df3.js"><link rel="prefetch" href="/blog/assets/js/28.796bfa26.js"><link rel="prefetch" href="/blog/assets/js/29.38b104b6.js"><link rel="prefetch" href="/blog/assets/js/3.159d2146.js"><link rel="prefetch" href="/blog/assets/js/30.4af86574.js"><link rel="prefetch" href="/blog/assets/js/31.90b14a89.js"><link rel="prefetch" href="/blog/assets/js/32.b471f649.js"><link rel="prefetch" href="/blog/assets/js/33.d8e805f8.js"><link rel="prefetch" href="/blog/assets/js/34.09a753bf.js"><link rel="prefetch" href="/blog/assets/js/35.3fee7620.js"><link rel="prefetch" href="/blog/assets/js/36.03747912.js"><link rel="prefetch" href="/blog/assets/js/37.554dda8c.js"><link rel="prefetch" href="/blog/assets/js/38.46bcde33.js"><link rel="prefetch" href="/blog/assets/js/39.a82e6ea2.js"><link rel="prefetch" href="/blog/assets/js/4.8ed88519.js"><link rel="prefetch" href="/blog/assets/js/40.d6208f57.js"><link rel="prefetch" href="/blog/assets/js/41.b7a3a229.js"><link rel="prefetch" href="/blog/assets/js/42.ffb33af9.js"><link rel="prefetch" href="/blog/assets/js/43.c90b42ae.js"><link rel="prefetch" href="/blog/assets/js/45.a4116688.js"><link rel="prefetch" href="/blog/assets/js/46.395f4bf2.js"><link rel="prefetch" href="/blog/assets/js/47.898431b6.js"><link rel="prefetch" href="/blog/assets/js/48.cb7a367c.js"><link rel="prefetch" href="/blog/assets/js/49.0f5b617e.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.bfaba15c.js"><link rel="prefetch" href="/blog/assets/js/51.604e12fd.js"><link rel="prefetch" href="/blog/assets/js/52.e63c94bd.js"><link rel="prefetch" href="/blog/assets/js/6.169e9be1.js"><link rel="prefetch" href="/blog/assets/js/7.e70cb6ab.js"><link rel="prefetch" href="/blog/assets/js/8.2450bca1.js"><link rel="prefetch" href="/blog/assets/js/9.5476b311.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Linux</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Kernel</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Ubuntu</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Systemd</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Shell</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/linux/shell/coding_style.html" class="active sidebar-link">shell 编码规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#shell-文件和解释器调用" class="sidebar-link">shell 文件和解释器调用</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#环境变量" class="sidebar-link">环境变量</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#注释" class="sidebar-link">注释</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#代码格式" class="sidebar-link">代码格式</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#特性和-bug" class="sidebar-link">特性和 BUG</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#命名约定" class="sidebar-link">命名约定</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#调用命令" class="sidebar-link">调用命令</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#结论" class="sidebar-link">结论</a></li><li class="sidebar-sub-header"><a href="/blog/linux/shell/coding_style.html#关于补充知识的参考文档" class="sidebar-link">关于补充知识的参考文档</a></li></ul></li><li><a href="/blog/linux/shell/grammer.html" class="sidebar-link">shell 常用语法</a></li><li><a href="/blog/linux/shell/command.html" class="sidebar-link">linux 常用命令</a></li><li><a href="/blog/linux/shell/zsh_vs_bash.html" class="sidebar-link">zsh 和 bash 的不同行为汇总</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="shell-编码规范"><a href="#shell-编码规范" class="header-anchor">#</a> shell 编码规范</h1> <p>一直觉得 linux shell 的语法很乱，各种书写规范以及兼容性很容易给开发者带来困惑，因此遵循一套 shell 语法标准是非常有必要的，本文是对 <a href="https://google.github.io/styleguide/shell.xml" target="_blank" rel="noopener noreferrer">google shell style gudie<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的翻译和补充：</p> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <h3 id="哪种-shell-应该被使用"><a href="#哪种-shell-应该被使用" class="header-anchor">#</a> 哪种 shell 应该被使用</h3> <ul><li><code>Bash</code> 是可执行文件被允许的唯一 shell 脚本语言，可执行文件必须以 <code>#!/bin/bash</code> 和 最少的 flag 作为开始。使用 <code>set</code> 去设置 <code>shell</code> 选项以便于你以 <code>bash &lt;script_name&gt;</code> 调用脚本的时候不会中断它的功能。</li> <li>将所有的可执行脚本限制为 bash 为我们提供了一种安装在我们所有机器上的一致的 shell 语言。（所有的机器都可以使用 bash shell）</li> <li>唯一的例外是你被任何代码中的需求所迫，其中一个例子是Solaris SVR4软件包，它需要纯Bourne shell来处理任何脚本。</li></ul> <h3 id="什么时候使用-shell"><a href="#什么时候使用-shell" class="header-anchor">#</a> 什么时候使用 shell</h3> <ul><li>尽管 shell 脚本不是一门开发语言，但它在 Google 被用来写各种实用性脚本。本代码风格规范更多的是对它的使用的认可而不是将其用于广泛部署的建议。</li> <li>一些建议：
<ul><li>如果您主要是为了调用其他的使用程序，并且只执行相对较少的数据操作，shell 是一个可以接受的选择。</li> <li>如果性能很重要，选择其他的语言而不是 shell。</li> <li>如果你发现你无论如何需要使用数组，但超过了 ${PIPESTATUS} 的分配，你应该使用 Python。</li> <li>如何你正在写一个脚本超过 100 行，你也许可以用 Python 代替它。记住脚本是会增长的。早早的用另一种语言重写你的脚本可以避免在以后哦的日子里进程耗时的重写。</li></ul></li></ul> <h2 id="shell-文件和解释器调用"><a href="#shell-文件和解释器调用" class="header-anchor">#</a> shell 文件和解释器调用</h2> <h3 id="文件扩展名"><a href="#文件扩展名" class="header-anchor">#</a> 文件扩展名</h3> <ul><li>可执行文件应该没有扩展名（强烈建议）或者是 <code>.sh</code> 扩展名。库文件必须有一个 <code>.sh</code> 扩展名并且没有可执行权限。在执行程序的时候不需要知道程序是用什么语言编写的，而且 shell 不要求扩展名，因此对于可执行文件我们不希望使用扩展名。然而，对于库文件，知道是用什么语言编写的是非常重要的，并且有时候需要在不同的语言里引用类似的库。这允许具有相同目的的但用不同语言编写的库文件使用除了语言特定的后缀之外相同的命名。</li></ul> <h3 id="suid-sgid"><a href="#suid-sgid" class="header-anchor">#</a> SUID/SGID</h3> <ul><li>SUID 和 SGID 在 shell 脚本是被禁用的。（这里不细翻译了，不太懂这两个词的意思）</li></ul> <h2 id="环境变量"><a href="#环境变量" class="header-anchor">#</a> 环境变量</h2> <h3 id="stdout-和-stderr"><a href="#stdout-和-stderr" class="header-anchor">#</a> STDOUT 和 STDERR</h3> <ul><li>全部的错误信息应该被写到 <code>STDERR</code>，这样可以更容易的将正常状态和实际问题分开。</li> <li>定义一个 function 用来打印错误信息以及其他状态信息是被推荐的，例如：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function-name function">err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">'%Y-%m-%dT%H:%M:%S%z'</span><span class="token variable">)</span></span>]: <span class="token variable">$@</span>&quot;</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token operator">!</span>do_something<span class="token punctuation">;</span> <span class="token keyword">then</span>
  err <span class="token string">&quot;Unable to do something&quot;</span>
  <span class="token builtin class-name">exit</span> <span class="token string">&quot;<span class="token variable">${E_DID_NOTHING}</span>&quot;</span>
<span class="token keyword">if</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="注释"><a href="#注释" class="header-anchor">#</a> 注释</h2> <h3 id="文件头"><a href="#文件头" class="header-anchor">#</a> 文件头</h3> <ul><li>以一句对文件内容的描述作为每一个脚本的开始。每个文件必须在最顶层有一句包含该文件内容简要概述的注释。版权通知和作者信息是可选的。例如：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment"># Perform hot backups of Oracle databases.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="功能注释"><a href="#功能注释" class="header-anchor">#</a> 功能注释</h3> <ul><li>任何不明显不简短的 function 都应该被注释。任何在一个库文件里的 function，无论长度或者复杂性如何都必须被注释。</li> <li>function 的注释应该包括：
<ul><li>function 的描述</li> <li>被使用和修改的全局变量</li> <li>传入的参数</li> <li>返回值</li></ul></li> <li>举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment"># Perform hot backups of Oracle databases.</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">'/usr/xpg4/bin:/usr/bin:/opt/csw/bin:/opt/goog/bin'</span>

<span class="token comment">#######################################</span>
<span class="token comment"># Cleanup files from the backup dir</span>
<span class="token comment"># Globals:</span>
<span class="token comment">#   BACKUP_DIR</span>
<span class="token comment">#   ORACLE_SID</span>
<span class="token comment"># Arguments:</span>
<span class="token comment">#   None</span>
<span class="token comment"># Returns:</span>
<span class="token comment">#   None</span>
<span class="token comment">#######################################</span>
<span class="token function-name function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="实现注释"><a href="#实现注释" class="header-anchor">#</a> 实现注释</h3> <ul><li>在棘手的，重要的，非显而易见的，有趣的代码部分都应该添加注释</li></ul> <h3 id="todo-注释"><a href="#todo-注释" class="header-anchor">#</a> TODO 注释</h3> <ul><li>在临时代码，一个短期的解决方案或者不是足够好的代码部分添加 TODO 注释，举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># TODO(author): Handle the unlikely edge cases (bug ####)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="代码格式"><a href="#代码格式" class="header-anchor">#</a> 代码格式</h2> <ul><li>对于修改一个已经存在的脚本文件，应该遵循现有的代码规范，下面的规范适用于新的代码。</li></ul> <h3 id="缩进"><a href="#缩进" class="header-anchor">#</a> 缩进</h3> <ul><li>缩进 2 个空格，不要使用 Tab。</li></ul> <h3 id="行长度"><a href="#行长度" class="header-anchor">#</a> 行长度</h3> <ul><li>行的最大长度是 80 个字符。</li></ul> <h3 id="管道"><a href="#管道" class="header-anchor">#</a> 管道</h3> <ul><li>如果管道不适合全部写在一行，则每条管道应该分别被分割成一行，举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># All fits on one line</span>
command1 <span class="token operator">|</span> command2

<span class="token comment"># Long commands</span>
command1 <span class="token punctuation">\</span>
  <span class="token operator">|</span> command2 <span class="token punctuation">\</span>
  <span class="token operator">|</span> command3 <span class="token punctuation">\</span>
  <span class="token operator">|</span> command4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="循环"><a href="#循环" class="header-anchor">#</a> 循环</h3> <ul><li>把 <code>; do</code> ，<code>; then</code> 和 <code>while</code>, <code>for</code> 或者 <code>if</code> 放在同一行。在 shell 里面循环有点不一样，但是在声明 function 时，我们遵循与花括号相同的原则。那就是 <code>; then</code> 和 <code>;do</code> 应该 与 <code>while/if/for</code>在同一行。<code>else</code> 应该在它自己的行上，并且结束语应该在与开头语句垂直对齐的行上。<br>
举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">for</span> <span class="token for-or-select variable">dir</span> <span class="token keyword">in</span> <span class="token variable">${dirs_to_cleanup}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -d <span class="token string">&quot;<span class="token variable">${dir}</span>/<span class="token variable">${ORACLE_SID}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    log_date <span class="token string">&quot;Cleaning up old files in <span class="token variable">${dir}</span>/<span class="token variable">${ORACLE_SID}</span>&quot;</span>
    <span class="token function">rm</span> <span class="token string">&quot;<span class="token variable">${dir}</span>/<span class="token variable">${ORACLE_SID}</span>&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$?</span>&quot;</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      error_message
    <span class="token keyword">fi</span>
  <span class="token keyword">else</span>
    <span class="token function">mkdir</span> -p <span class="token string">&quot;<span class="token variable">${dir}</span>/<span class="token variable">${ORACLE_SID}</span>&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$?</span> -ne 0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      error_message
    <span class="token keyword">fi</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="case-语句"><a href="#case-语句" class="header-anchor">#</a> Case 语句</h3> <ul><li>缩进选择是 2 个空格</li> <li>一个单行的选择需要在右括号之后有一个空格</li> <li>一个很长的或者多命令选择应该以匹配模式， 逻辑代码以及 <code>；;</code> 被分割成多行。</li> <li>被匹配的表达式产品在 <code>case</code> 和 <code>esac</code> 缩进一个级别。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">${expression}</span>&quot;</span> <span class="token keyword">in</span>
  a<span class="token punctuation">)</span>
    <span class="token assign-left variable">variable</span><span class="token operator">=</span><span class="token string">&quot;...&quot;</span>
    some_command <span class="token string">&quot;<span class="token variable">${variable}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${other_expr}</span>&quot;</span> <span class="token punctuation">..</span>.
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  absolute<span class="token punctuation">)</span>
    <span class="token assign-left variable">actions</span><span class="token operator">=</span><span class="token string">&quot;relative&quot;</span>
    another_command <span class="token string">&quot;<span class="token variable">${actions}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${other_expr}</span>&quot;</span> <span class="token punctuation">..</span>.
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  *<span class="token punctuation">)</span>
    error <span class="token string">&quot;Unexpected expression '<span class="token variable">${expression}</span>'&quot;</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>简单的命令可以和模式，<code>;;</code> 放在同一行，只要表达式仍然可读。这通常适用于</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">verbose</span><span class="token operator">=</span><span class="token string">'false'</span>
<span class="token assign-left variable">aflag</span><span class="token operator">=</span><span class="token string">''</span>
<span class="token assign-left variable">bflag</span><span class="token operator">=</span><span class="token string">''</span>
<span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">'avf:v'</span> flag<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">${flag}</span>&quot;</span> <span class="token keyword">in</span>
    a<span class="token punctuation">)</span> <span class="token assign-left variable">aflag</span><span class="token operator">=</span><span class="token string">'true'</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    b<span class="token punctuation">)</span> <span class="token assign-left variable">bflag</span><span class="token operator">=</span><span class="token string">'true'</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    f<span class="token punctuation">)</span> <span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${OPTARG}</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token function">v</span><span class="token punctuation">)</span> <span class="token assign-left variable">verbose</span><span class="token operator">=</span><span class="token string">'true'</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span> error <span class="token string">&quot;Unexpected option <span class="token variable">${flag}</span>&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="变量扩展"><a href="#变量扩展" class="header-anchor">#</a> 变量扩展</h3> <p>按优先顺序排列：</p> <ul><li>与你找到的已存在的代码风格保持一致</li> <li>为变量使用引号，参考下面</li> <li>除非严格需要或避免深度混淆，否则不要用花括号引用 shell 特定的占位符。举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># Section of recommended cases</span>
<span class="token comment">#Preferred style for 'special' variables:</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Postional: <span class="token variable">$1</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$2</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$3</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Specials: !=<span class="token variable">$!</span>, -=$-, _=<span class="token variable">$_</span>. ?=<span class="token variable">$?</span>, #=<span class="token variable">$#</span> *=<span class="token variable">$*</span> @=<span class="token variable">$@</span> \$=<span class="token variable">$$</span> ...&quot;</span>

<span class="token comment"># Braces necessary:</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;many parameters: <span class="token variable">${10}</span>&quot;</span>

<span class="token comment"># Braces avioding confusion:</span>
<span class="token comment"># Output is &quot;a0b0c0&quot;</span>
<span class="token builtin class-name">set</span> -- a b c
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${1}</span>0<span class="token variable">${2}</span>0<span class="token variable">${3}</span>0&quot;</span> <span class="token comment"># a0b0c0</span>

<span class="token comment"># Preferred style for other variables:</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;PATH=<span class="token variable">${<span class="token environment constant">PATH</span>}</span>, PWD=<span class="token variable">${<span class="token environment constant">PWD</span>}</span>, mine=<span class="token variable">${some_var}</span>&quot;</span>
<span class="token keyword">while</span> <span class="token builtin class-name">read</span> f<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;file=<span class="token variable">${f}</span>&quot;</span>
<span class="token keyword">done</span> <span class="token operator">&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token function">ls</span> -l /tmp<span class="token punctuation">)</span>

<span class="token comment"># Selection of discouraged cases</span>

<span class="token comment"># Unquoted vars, unbraced vars, brace-qutoted single letter, shell specials</span>
<span class="token builtin class-name">echo</span> <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token variable">$avar</span> <span class="token string">&quot;b=<span class="token variable">$bvar</span>&quot;</span> <span class="token string">&quot;PID=<span class="token variable">${$}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${1}</span>&quot;</span>
<span class="token comment"># Confusing use: this is expanded as &quot;${1}0${2}0${3}0&quot;, not &quot;${10}${20}${30}</span>
<span class="token builtin class-name">set</span> -- a b c
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$10</span><span class="token variable">$20</span><span class="token variable">$30</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="引号"><a href="#引号" class="header-anchor">#</a> 引号</h3> <ul><li>总是对包含变量，命令替换，空格或者 shell 元字符的字符串加引号, 除非不加引号的扩展是必需的</li> <li>不要对整形字面量使用引号</li> <li>请注意 <code>[[</code> 的引号规则</li> <li>使用 <code>$@</code> 除非有特殊的理由使用 <code>$*</code></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 单引号表明不需要替换</span>
<span class="token comment"># 双引号表示替换是必需的或是容忍的</span>

<span class="token comment"># 例子</span>
<span class="token comment"># 对命令替换使用引号</span>
<span class="token assign-left variable">flag</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>some_command and its args <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span> <span class="token string">'quoted separately'</span><span class="token variable">)</span></span>&quot;</span>

<span class="token comment"># 对变量使用引号</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${flag}</span>&quot;</span>

<span class="token comment"># 切勿对整数加引号</span>
<span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">32</span>
<span class="token comment"># 对命令替换使用引号，即使你期待的值是整形</span>
<span class="token assign-left variable">number</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>generate_number<span class="token variable">)</span></span>&quot;</span>

<span class="token comment"># 推荐对单词加引号，但不是必须</span>
<span class="token builtin class-name">readonly</span> <span class="token assign-left variable">USE_INTEGER</span><span class="token operator">=</span><span class="token string">'true'</span>

<span class="token comment"># &quot;quote shell meta characters&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">'Hello stranger, and well met. Earn lots of <span class="token variable">$$</span>$'</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Process <span class="token variable">$$</span>: Done making \$\$\$.&quot;</span>

<span class="token comment"># 命令</span>
<span class="token comment"># ($1 is assumed to contain a value here)</span>
<span class="token function">grep</span> -li Hugo /dev/null <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span>

<span class="token comment"># Less simple examples</span>
<span class="token comment"># &quot;quote variables, unless proven false&quot;: ccs might be empty</span>
<span class="token function">git</span> send-email --to <span class="token string">&quot;<span class="token variable">${reviewers}</span>&quot;</span> <span class="token variable">${ccs<span class="token operator">:+</span>&quot;--cc&quot; &quot;${ccs}</span>&quot;<span class="token punctuation">}</span>

<span class="token comment"># Positional parameter precautions: $1 might be unset</span>
<span class="token comment"># Single quotes leave regex as-is.</span>
<span class="token function">grep</span> -cP <span class="token string">'([Ss]pecial|\|?characters*)$'</span> <span class="token variable">${1<span class="token operator">:+</span>&quot;$1&quot;}</span>

<span class="token comment"># For passing on arguments,</span>
<span class="token comment"># &quot;$@&quot; is right almost everytime, and</span>
<span class="token comment"># $* is wrong almost everytime:</span>
<span class="token comment">#</span>
<span class="token comment"># * $* and $@ will split on spaces, clobbering up arguments</span>
<span class="token comment">#   that contain spaces and dropping empty strings;</span>
<span class="token comment"># * &quot;$@&quot; will retain arguments as-is, so no args</span>
<span class="token comment">#   provided will result in no args being passed on;</span>
<span class="token comment">#   This is in most cases what you want to use for passing</span>
<span class="token comment">#   on arguments.</span>
<span class="token comment"># * &quot;$*&quot; expands to one argument, with all args joined</span>
<span class="token comment">#   by (usually) spaces,</span>
<span class="token comment">#   so no args provided will result in one empty string</span>
<span class="token comment">#   being passed on.</span>
<span class="token comment"># (Consult 'man bash' for the nit-grits ;-)</span>

<span class="token builtin class-name">set</span> -- <span class="token number">1</span> <span class="token string">&quot;2 two&quot;</span> <span class="token string">&quot;3 three tres&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$#</span> <span class="token punctuation">;</span> <span class="token builtin class-name">set</span> -- <span class="token string">&quot;<span class="token variable">$*</span>&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$#</span>, <span class="token variable">$@</span>&quot;</span><span class="token punctuation">)</span>
<span class="token builtin class-name">set</span> -- <span class="token number">1</span> <span class="token string">&quot;2 two&quot;</span> <span class="token string">&quot;3 three tres&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$#</span> <span class="token punctuation">;</span> <span class="token builtin class-name">set</span> -- <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$#</span>, <span class="token variable">$@</span>&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="对引号的补充"><a href="#对引号的补充" class="header-anchor">#</a> 对引号的补充</h3> <ul><li>单词分隔<br> <a href="http://mywiki.wooledge.org/WordSplitting" target="_blank" rel="noopener noreferrer">单词分隔<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是 bash shell 的默认行为，因此使用字符串和参数扩展时要小心，例如下面的这个例子，不要认为单词分隔只是折叠了空格，实际上，这个例子中真正发生的是，第一个命令（指的是Bash）将我们句子中的每个单词作为单独的参数传递给 echo。Bash 使用单词之间的空白将句子分隔成单词，以确定每个单词的开始和结束位置。而在第2个例子中，Bash被强制将整个引用的字符串做为一个参数传递给 echo。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token builtin class-name">echo</span> Push that word             away from me.
Push that word away from me.
$ <span class="token builtin class-name">echo</span> <span class="token string">&quot;Push that word             away from me.&quot;</span>
Push that word             away from me.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>再看下面的例子，单词分隔不仅仅发生在字符串字面量上，它也发生在参数扩展之后！正如你看到的，在第一个 echo 命令中忽略了引号。Bash 扩展了我们的语句，然后使用单词分隔将产生的扩展分解为用于回显的参数，结果破坏了我们经过深思熟虑的格式化。在第二个例子中，用引号引起句子的参数扩展确保 shell 不会用空白分隔成多个参数。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token assign-left variable">sentence</span><span class="token operator">=</span><span class="token string">&quot;Push that word             away from me.&quot;</span>
$ <span class="token builtin class-name">echo</span> <span class="token variable">$sentence</span>
Push that word away from me.
$ <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$sentence</span>&quot;</span>
Push that word             away from me.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>单词分隔发生在全部的空白处，包括制表符，新行，和其他在IFS变量中定义的字符。下面是另一个例子去展示如果你忽略引号会有多糟糕。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -al<span class="token variable">)</span></span>&quot;</span>
total <span class="token number">8</span>
drwxr-xr-x   <span class="token number">4</span> lhunath <span class="token function">users</span> <span class="token number">1</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;.&quot;</span>/
drwxr-xr-x <span class="token number">102</span> lhunath <span class="token function">users</span> <span class="token number">9</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;..&quot;</span>/
-rw-r--r--   <span class="token number">1</span> lhunath <span class="token function">users</span> <span class="token number">0</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;a&quot;</span>
-rw-r--r--   <span class="token number">1</span> lhunath <span class="token function">users</span> <span class="token number">0</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;b&quot;</span>
-rw-r--r--   <span class="token number">1</span> lhunath <span class="token function">users</span> <span class="token number">0</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;c&quot;</span>
drwxr-xr-x   <span class="token number">2</span> lhunath <span class="token function">users</span> <span class="token number">1</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;d&quot;</span>/
drwxr-xr-x   <span class="token number">2</span> lhunath <span class="token function">users</span> <span class="token number">1</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;e&quot;</span>/
$ <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -al<span class="token variable">)</span></span>
total <span class="token number">8</span> drwxr-xr-x <span class="token number">4</span> lhunath <span class="token function">users</span> <span class="token number">1</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;.&quot;</span>/ drwxr-xr-x <span class="token number">102</span> lhunath <span class="token function">users</span> <span class="token number">9</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;..&quot;</span>/ -rw-r--r-- <span class="token number">1</span> lhunath <span class="token function">users</span> <span class="token number">0</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;a&quot;</span> -rw-r--r-- <span class="token number">1</span> lhunath <span class="token function">users</span> <span class="token number">0</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;b&quot;</span> -rw-r--r-- <span class="token number">1</span> lhunath <span class="token function">users</span> <span class="token number">0</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;c&quot;</span> drwxr-xr-x <span class="token number">2</span> lhunath <span class="token function">users</span> <span class="token number">1</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;d&quot;</span>/ drwxr-xr-x <span class="token number">2</span> lhunath <span class="token function">users</span> <span class="token number">1</span> <span class="token number">2007</span>-06-28 <span class="token number">13</span>:13 <span class="token string">&quot;e&quot;</span>/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在一些情况下可能希望省略引号，例如你需要单词分隔的功能：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token assign-left variable">friends</span><span class="token operator">=</span><span class="token string">&quot;Marcus JJ Thomas Michelangelo&quot;</span>
$ <span class="token keyword">for</span> <span class="token for-or-select variable">friend</span> <span class="token keyword">in</span> <span class="token variable">$friends</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
$   <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$friend</span> is my friend!&quot;</span><span class="token punctuation">;</span>
$ <span class="token keyword">done</span>
Marcus is my friend<span class="token operator">!</span>
JJ is my friend<span class="token operator">!</span>
Thomas is my friend<span class="token operator">!</span>
Michelangelo is my friend<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>但是，说实话，几乎所有的上述情况都应该使用数组。数组的优点是他们不需要明确的分隔符就可以分隔字符串。这意味着在数组中的字符串可以包含任何有效的字符，不需要担心它可能包含字符分隔符（像上个例子中的空格）。举例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">friends</span><span class="token operator">=</span><span class="token punctuation">(</span> <span class="token string">&quot;Marcus The Rich&quot;</span> <span class="token string">&quot;JJ The Short&quot;</span> <span class="token string">&quot;Timid Thomas&quot;</span> <span class="token string">&quot;Michelangelo The Mobster&quot;</span> <span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">friend</span> <span class="token keyword">in</span> <span class="token string">&quot;<span class="token variable">${friends<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$friend</span> is my friend&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="特性和-bug"><a href="#特性和-bug" class="header-anchor">#</a> 特性和 BUG</h2> <h3 id="命令替换"><a href="#命令替换" class="header-anchor">#</a> 命令替换</h3> <ul><li>使用 <code>$(command)</code> 代替反引号。嵌套的反引号在内部需要用 \ 来转义，而 <code>$(command)</code> 在引号嵌套时格式不需要改变而且可读性更好，举例：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 推荐</span>
<span class="token assign-left variable">var</span><span class="token operator">=</span><span class="token string">&quot;$(command &quot;<span class="token variable"><span class="token variable">$(</span>command1<span class="token variable">)</span></span>&quot;</span><span class="token punctuation">)</span><span class="token string">&quot;
# 反例
var=&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">command</span> <span class="token punctuation">\</span><span class="token variable">`</span></span>command1<span class="token punctuation">\</span>``&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="test-和"><a href="#test-和" class="header-anchor">#</a> test <code>[[</code> 和 <code>[</code></h3> <ul><li>相比 <code>test</code>, <code>[</code> 和 <code>/usr/bin/[</code> ，<code>[[</code> 是首选。<code>[[...]]</code> 减少了因为路径扩展或者在 <code>[[</code> 和 <code>]]</code> 之间发生单词分割的错误，而且它允许 <code>[ ... ]</code> 不能的正则匹配。举例：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># This ensures the string on the left is made up of characters in the</span>
<span class="token comment"># alnum character class followed by the string name.</span>
<span class="token comment"># Note that the RHS should not be quoted here.</span>
<span class="token comment"># For the gory details, see</span>
<span class="token comment"># E14 at https://tiswww.case.edu/php/chet/bash/FAQ</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;filename&quot;</span> <span class="token operator">=</span>~ ^<span class="token punctuation">[</span><span class="token punctuation">[</span>:alnum:<span class="token punctuation">]</span><span class="token punctuation">]</span>+name <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Match&quot;</span>
<span class="token keyword">fi</span>

<span class="token comment"># This matches the exact pattern &quot;f*&quot; (Does not match in this case)</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;filename&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;f*&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Match&quot;</span>
<span class="token keyword">fi</span>

<span class="token comment"># This gives a &quot;too many arguments&quot; error as f* is expanded to the</span>
<span class="token comment"># contents of the current directory</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;filename&quot;</span> <span class="token operator">==</span> f* <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Match&quot;</span>
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="检查-strtings"><a href="#检查-strtings" class="header-anchor">#</a> 检查 Strtings</h3> <ul><li>尽可能的使用引号而不是填充字符，bash 检查一个空字符串非常容易，因此使用字符串为空或者非空的检查而不是使用填充字符这种方式。举例：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 推荐</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${my_var}</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;some_thing&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something
<span class="token keyword">fi</span>
<span class="token comment"># 测试一个字符串是否为空，-z (字符串长度为 0 ) -n (字符串长度不为 0 ) 是首选</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">${my_var}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something
<span class="token keyword">fi</span>
<span class="token comment"># 下面这种方式也是正确的，但是不推荐</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${my_var}</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something
<span class="token keyword">fi</span>
<span class="token comment"># 反例</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${my_var}</span>X&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;someth_stringX&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>为避免困惑，应该明确的使用 -z 或者 -n，举例：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 推荐</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -n <span class="token string">&quot;<span class="token variable">${my_var}</span> &quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something
<span class="token keyword">fi</span>
<span class="token comment"># 反例</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${my_var}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="test-和-补充"><a href="#test-和-补充" class="header-anchor">#</a> test <code>[[</code> 和 <code>[</code> 补充</h3> <ul><li><a href="/blog/linux/shell/shell_grammer.html">shell 条件判断</a></li></ul> <h3 id="通配符文件扩展名"><a href="#通配符文件扩展名" class="header-anchor">#</a> 通配符文件扩展名</h3> <ul><li>当使用通配符文件扩展名时，使用一个明确的路径，因为文件名能以 <code>-</code> 开头，使用 <code>./*</code> 扩展通配符要比 <code>*</code> 安全的多，举例：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 下面是一个文件夹 /tmp 的内容</span>
<span class="token comment"># -f -r somedir somefile</span>
psa@bilby$ <span class="token function">rm</span> -v *
removed directory: <span class="token variable"><span class="token variable">`</span>somedir'
removed <span class="token variable">`</span></span>somefile<span class="token string">'

# 与之相反
psa@bilby$ rm -v ./*
removed <span class="token variable"><span class="token variable">`</span>./-f'
removed <span class="token variable">`</span></span>./-r'</span>
rm: cannot remove <span class="token variable"><span class="token variable">`</span>./somedir': Is a directory
removed <span class="token variable">`</span></span>./somefile'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="eval"><a href="#eval" class="header-anchor">#</a> Eval</h3> <ul><li>eval 命令应该被避免。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># What does this set?</span>
<span class="token comment"># Did it succeed? In part or whole?</span>
<span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>set_my_variables<span class="token variable">)</span></span>

<span class="token comment"># What happens if one of the returned values has a space in it?</span>
<span class="token assign-left variable">variable</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> some_function<span class="token variable">)</span></span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="pipe-to-while-管道输入-while-循环（不知道怎么翻译）"><a href="#pipe-to-while-管道输入-while-循环（不知道怎么翻译）" class="header-anchor">#</a> pipe to while 管道输入 while 循环（不知道怎么翻译）</h3> <ul><li>优先使用流程替换或者 for 循环 来做 pipe to while，在 while 循环中修改的变量不会传播到父进程，因为循环的命令被运行在子进程中。（因为管道后的内容会放在子 shell 执行）举例：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">last_line</span><span class="token operator">=</span><span class="token string">'NULL'</span>
your_command <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> line<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token assign-left variable">last_line</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${line}</span>&quot;</span>
<span class="token keyword">done</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${last_line}</span>&quot;</span> <span class="token comment"># NULL</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>如果你确信输入不会包含特殊字符（通常，这意味着不是用户输入），请使用 for 循环。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">total</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token comment"># Only do this if there are no spaces in return values.</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">value</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">command</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token assign-left variable">total</span><span class="token operator">+=</span><span class="token string">&quot;<span class="token variable">${value}</span>&quot;</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>使用进程替换可以重定向输出，但是需要将命令放在明确的子 shell 中，而不是 bash 为 while 循环创建的隐式子 shell。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">total</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">last_file</span><span class="token operator">=</span>
<span class="token keyword">while</span> <span class="token builtin class-name">read</span> count filename<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token assign-left variable">total</span><span class="token operator">+=</span><span class="token string">&quot;<span class="token variable">${count}</span>&quot;</span>
  <span class="token assign-left variable">last_file</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${filename}</span>&quot;</span>
<span class="token keyword">done</span> <span class="token operator">&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>your_command <span class="token operator">|</span> <span class="token function">uniq</span> -c<span class="token punctuation">)</span>

<span class="token comment"># This will output the second field of the last line of output from</span>
<span class="token comment"># the command.</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Total = <span class="token variable">${total}</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Last one = <span class="token variable">${last_file}</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>使用无需将复杂结果传递给父 shell 的 while 循环 - 这通常需要一些更复杂的解析。注意简单的例子可能更容易通过 awk 等工具完成。如果你不想改变父进程的变量作用域，这可能也很有用。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># Trivial implementation of awk expression:</span>
<span class="token comment">#   awk '$3 == &quot;nfs&quot; { print $2 &quot; maps to &quot; $1 }' /proc/mounts</span>
<span class="token function">cat</span> /proc/mounts <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> src dest <span class="token builtin class-name">type</span> opts rest<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${type}</span> <span class="token operator">==</span> <span class="token string">&quot;nfs&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;NFS <span class="token variable">${dest}</span> maps to <span class="token variable">${src}</span>&quot;</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="命名约定"><a href="#命名约定" class="header-anchor">#</a> 命名约定</h2> <h3 id="函数名"><a href="#函数名" class="header-anchor">#</a> 函数名</h3> <ul><li>小写字母，用下划线分割单词。用 :: 分开库，函数名称后面需要括号。关键词 function 是可选的，但是在一个项目中，使用或者不使用必须是一致的。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># Single function</span>
<span class="token function-name function">my_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>

<span class="token comment"># Part of a package</span>
mypackage::<span class="token function-name function">my_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="变量名"><a href="#变量名" class="header-anchor">#</a> 变量名</h3> <ul><li>和函数命名一样</li></ul> <h3 id="常量和环境变量"><a href="#常量和环境变量" class="header-anchor">#</a> 常量和环境变量</h3> <ul><li>全部大写，用下划线分隔，在文件顶部声明。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># Constant</span>
<span class="token builtin class-name">readonly</span> <span class="token assign-left variable">PATH_TO_FILES</span><span class="token operator">=</span><span class="token string">'/some/path'</span>

<span class="token comment"># Both constant and environment</span>
<span class="token builtin class-name">declare</span> -xr <span class="token assign-left variable">ORACLE_SID</span><span class="token operator">=</span><span class="token string">'PROD'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>一些变量在第一次被设置时变成常量（例如，通过 getopts）。因此，在 getopts 中设置一个条件是正确的，但是设置之后它应该立即变为 readonly。注意 declare 不能在函数中操作全局变量，因此推荐使用 readonly 或者 export。</li></ul> <h3 id="源文件名"><a href="#源文件名" class="header-anchor">#</a> 源文件名</h3> <ul><li>小写，尽量使用下划线分隔。</li></ul> <h3 id="只读变量"><a href="#只读变量" class="header-anchor">#</a> 只读变量</h3> <ul><li>使用 readonly 或者 declare -r 确保变量是只读的。因为全局变量在 shell 中被广泛使用，因此捕捉错误是重要的。当你想要声明一个只读变量，应该使它被明确定义。</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">zip_version</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>dpkg --status <span class="token function">zip</span> <span class="token operator">|</span> <span class="token function">grep</span> Version: <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">' '</span> -f <span class="token number">2</span><span class="token variable">)</span></span>&quot;</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">${zip_version}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  error_message
<span class="token keyword">else</span>
  <span class="token builtin class-name">readonly</span> zip_version
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="使用局部变量"><a href="#使用局部变量" class="header-anchor">#</a> 使用局部变量</h3> <ul><li>使用 local 声名函数范围内的变量。声明和赋值应该在不同的行。确保局部变量仅仅能在一个函数内被访问。这样可以避免污染全局命名空间并无意间设置在函数之外有意义的变量。举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function-name function">my_func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span>

  <span class="token comment"># Separate lines for declaration and assignment:</span>
  <span class="token builtin class-name">local</span> my_var
  <span class="token assign-left variable">my_var</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>my_func<span class="token variable">)</span></span>&quot;</span> <span class="token operator">||</span> <span class="token builtin class-name">return</span>

  <span class="token comment"># DO NOT do this: $? contains the exit code of 'local', not my_func</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">my_var</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>my_func<span class="token variable">)</span></span>&quot;</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token builtin class-name">return</span>

  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="函数位置"><a href="#函数位置" class="header-anchor">#</a> 函数位置</h3> <ul><li>在一个文件中，将全部的函数放在常量的下面，在声明函数之前，只能包含 set 语句和设置常量。在函数之间不要隐藏可执行代码。</li></ul> <h3 id="main-函数"><a href="#main-函数" class="header-anchor">#</a> main 函数</h3> <ul><li>对于一个包含至少一个其他函数的足够长的脚本，一个名为 main 的函数是必要的。为了容易的找到程序的入口，把主程序封装在 main 函数作为最底层的函数。这提供了与其他代码库的一致性，并允许你定义更多的局部变量（如果主代码不是函数则无法做到）。文件中的最后一条非注释行应该是对 main 的调用：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>main <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>很显然，对于线性的短脚本，main 函数有点多余， 不是必需的。</li></ul> <h2 id="调用命令"><a href="#调用命令" class="header-anchor">#</a> 调用命令</h2> <h3 id="检查返回值"><a href="#检查返回值" class="header-anchor">#</a> 检查返回值</h3> <ul><li>总是检查返回值并且给予能提供有用信息的返回值。</li> <li>对于 unpiped 命令，使用 <code>$?</code> 或者通过一个 <code>if</code> 语句直接检查它。举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">mv</span> <span class="token string">&quot;<span class="token variable">${file_list}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${dest_dir}</span>/&quot;</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Unable to move <span class="token variable">${file_list}</span> to <span class="token variable">${dest_dir}</span>&quot;</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span>
  <span class="token builtin class-name">exit</span> <span class="token string">&quot;<span class="token variable">${E_BAD_MOVE}</span>&quot;</span>
<span class="token keyword">fi</span>
<span class="token comment"># or</span>
<span class="token function">mv</span> <span class="token string">&quot;<span class="token variable">${file_list}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${dest_dir}</span>/&quot;</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token string">&quot;<span class="token variable">$?</span>&quot;</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Unable to move <span class="token variable">${file_list}</span> to <span class="token variable">${dest_dir}</span>&quot;</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span>
  <span class="token builtin class-name">exit</span> <span class="token string">&quot;<span class="token variable">${E_BAD_MOVE}</span>&quot;</span>
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>Bash 有 <code>PIPESTATUS</code> 变量允许检查一个管道的全部部分的返回码。如果要检查整个管道的成功或失败是必要的，那么下面的例子是可以接受的：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> -cf - ./* <span class="token operator">|</span> <span class="token punctuation">(</span> <span class="token builtin class-name">cd</span> <span class="token string">&quot;<span class="token variable">${dir}</span>&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> -xf - <span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${<span class="token environment constant">PIPESTATUS</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span>}</span>&quot;</span> -ne <span class="token number">0</span> <span class="token operator">||</span> <span class="token string">&quot;<span class="token variable">${<span class="token environment constant">PIPESTATUS</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span>}</span>&quot;</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Unable to tar files to <span class="token variable">${dir}</span>&quot;</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span>
<span class="token keyword">if</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>然而， 只要你运行了其他的命令，<code>PIPESTATUS</code> 将被覆盖，如果你需要根据管道中发生的错误对错误采取不同的行为，则需要在运行命令后立即将PIPESTATUS分配给另一个变量（不要忘记 <code>[</code> 是一个命令，将覆盖 <code>PIPESTATUS</code>）</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> -cf - ./* <span class="token operator">|</span> <span class="token punctuation">(</span> <span class="token builtin class-name">cd</span> <span class="token string">&quot;<span class="token variable">${dir}</span>&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> -xf - <span class="token punctuation">)</span>
<span class="token assign-left variable">return_codes</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">${<span class="token environment constant">PIPESTATUS</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${return_codes<span class="token punctuation">[</span>0<span class="token punctuation">]</span>}</span>&quot;</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something
<span class="token keyword">fi</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${return_codes<span class="token punctuation">[</span>1<span class="token punctuation">]</span>}</span>&quot;</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  do_something_else
<span class="token keyword">fi</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="内建命令-vs-外部命令"><a href="#内建命令-vs-外部命令" class="header-anchor">#</a> 内建命令 VS 外部命令</h3> <ul><li>在内建命令和独立进程之间尽量选择调用内建命令而不是调独立进程。举例：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># Prefer this:</span>
<span class="token assign-left variable">addition</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>${X} <span class="token operator">+</span> ${Y}<span class="token variable">))</span></span>
<span class="token assign-left variable">substition</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${string<span class="token operator">/</span><span class="token operator">#</span>foo<span class="token operator">/</span>bar}</span>&quot;</span>
<span class="token comment"># Instead of this:</span>
<span class="token assign-left variable">addition</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">expr</span> $<span class="token punctuation">{</span>X<span class="token punctuation">}</span> + $<span class="token punctuation">{</span>Y<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span>
<span class="token assign-left variable">substitution</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${string}</span>&quot;</span> <span class="token operator">|</span> <span class="token function">sed</span> -e <span class="token string">'s/^foo/bar/'</span><span class="token variable">)</span></span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h2> <ul><li>使用常识并保持一致</li></ul> <h2 id="关于补充知识的参考文档"><a href="#关于补充知识的参考文档" class="header-anchor">#</a> 关于补充知识的参考文档</h2> <ul><li><a href="http://mywiki.wooledge.org/BashGuide/Practices#Bash_Tests" target="_blank" rel="noopener noreferrer">http://mywiki.wooledge.org/BashGuide/Practices#Bash_Tests<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/linux/systemd/journald.html" class="prev">
        journald
      </a></span> <span class="next"><a href="/blog/linux/shell/grammer.html">
        shell 常用语法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.2efd3993.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/44.fe190f21.js" defer></script>
  </body>
</html>
