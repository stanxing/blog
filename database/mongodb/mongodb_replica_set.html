<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB 复制集 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.11df36d9.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/20.b55c339f.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.488e1876.js"><link rel="prefetch" href="/blog/assets/js/23.ec1e14cd.js"><link rel="prefetch" href="/blog/assets/js/24.30acfa7a.js"><link rel="prefetch" href="/blog/assets/js/25.7e057639.js"><link rel="prefetch" href="/blog/assets/js/26.d6956725.js"><link rel="prefetch" href="/blog/assets/js/27.89ed39ae.js"><link rel="prefetch" href="/blog/assets/js/28.2eb00a11.js"><link rel="prefetch" href="/blog/assets/js/29.03f53804.js"><link rel="prefetch" href="/blog/assets/js/3.ce341c75.js"><link rel="prefetch" href="/blog/assets/js/30.94c936ff.js"><link rel="prefetch" href="/blog/assets/js/31.878fd6af.js"><link rel="prefetch" href="/blog/assets/js/32.12650543.js"><link rel="prefetch" href="/blog/assets/js/33.d88b3033.js"><link rel="prefetch" href="/blog/assets/js/34.8f4eb828.js"><link rel="prefetch" href="/blog/assets/js/35.6472fbc0.js"><link rel="prefetch" href="/blog/assets/js/36.76952610.js"><link rel="prefetch" href="/blog/assets/js/37.19d547c3.js"><link rel="prefetch" href="/blog/assets/js/38.89b3e172.js"><link rel="prefetch" href="/blog/assets/js/39.7110b5ad.js"><link rel="prefetch" href="/blog/assets/js/4.2c9d8f5c.js"><link rel="prefetch" href="/blog/assets/js/40.4c087bc2.js"><link rel="prefetch" href="/blog/assets/js/41.acd4d42c.js"><link rel="prefetch" href="/blog/assets/js/42.1eeecebb.js"><link rel="prefetch" href="/blog/assets/js/43.b8524b83.js"><link rel="prefetch" href="/blog/assets/js/44.78616964.js"><link rel="prefetch" href="/blog/assets/js/45.f0d78fa1.js"><link rel="prefetch" href="/blog/assets/js/46.780a79ed.js"><link rel="prefetch" href="/blog/assets/js/47.f5ee5c97.js"><link rel="prefetch" href="/blog/assets/js/48.f1cbe58a.js"><link rel="prefetch" href="/blog/assets/js/49.04dae616.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.4371b984.js"><link rel="prefetch" href="/blog/assets/js/51.bbe997be.js"><link rel="prefetch" href="/blog/assets/js/6.f8362109.js"><link rel="prefetch" href="/blog/assets/js/7.31bdba8f.js"><link rel="prefetch" href="/blog/assets/js/8.d84da6fa.js"><link rel="prefetch" href="/blog/assets/js/9.c8d18b4a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Database</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>MongoDB</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/database/mongodb/model_design.html" class="sidebar-link">MongoDB 模型设计</a></li><li><a href="/blog/database/mongodb/mongodb_crud_1.html" class="sidebar-link">MongoDB 3.2 的原子性和事务</a></li><li><a href="/blog/database/mongodb/mongodb_crud_2.html" class="sidebar-link">MongoDB 聚合</a></li><li><a href="/blog/database/mongodb/mongodb_index_1.html" class="sidebar-link">MongoDB 索引类型</a></li><li><a href="/blog/database/mongodb/mongodb_index_2.html" class="sidebar-link">MongoDB 索引</a></li><li><a href="/blog/database/mongodb/mongodb_replica_set.html" class="active sidebar-link">MongoDB 复制集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_replica_set.html#作用" class="sidebar-link">作用</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_replica_set.html#搭建" class="sidebar-link">搭建</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_replica_set.html#数据是如何复制的？" class="sidebar-link">数据是如何复制的？</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_replica_set.html#选举流程" class="sidebar-link">选举流程</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_replica_set.html#影响选举的因素" class="sidebar-link">影响选举的因素</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_replica_set.html#复制集的选项" class="sidebar-link">复制集的选项</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_replica_set.html#注意事项" class="sidebar-link">注意事项</a></li></ul></li><li><a href="/blog/database/mongodb/mongodb_problem_1.html" class="sidebar-link">记一次 MongoDB secondary 节点 block 所有读请求的事故</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongodb-复制集"><a href="#mongodb-复制集" class="header-anchor">#</a> MongoDB 复制集</h1> <h2 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h2> <ul><li><p>实现服务高可用。</p> <ul><li>数据写入时能迅速将数据复制到另一个独立节点上。</li> <li>在接受写入的节点发生故障的时候会自动选举出一个新的替代节点。</li></ul></li> <li><p>在实现高可用的同时，还能实现一些附加作用：</p> <ul><li>数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的延迟。</li> <li>读写分离：不同类型的压力分别在不同的节点上执行。</li> <li>异地容灾：节点可以分布在不同的可用区，在数据中心故障的时候可以快速的切换到异地。</li></ul></li></ul> <h2 id="搭建"><a href="#搭建" class="header-anchor">#</a> 搭建</h2> <p>一个典型的复制集由 3 个及 3 个以上具有投票权的节点组成，包括：</p> <ul><li>一个 primary 节点： 接收写操作和选举时投票</li> <li>两个或者多个 secondary 节点：复制主节点上的新数据和选举时投票。</li> <li>arbiter 节点，也叫投票节点，不存储数据，只用来投票，一般用在只有偶数个数据节点的情况下，为了构成奇数个节点来满足投票大多数的要求，不推荐使用。</li></ul> <h2 id="数据是如何复制的？"><a href="#数据是如何复制的？" class="header-anchor">#</a> 数据是如何复制的？</h2> <ul><li>当一个修改操作，无论是插入，删除或者更新操作，到达主节点时，它对数据的操作将被记录下来，这些记录存在 local 数据库的 oplog 表中。</li> <li>secondary 节点通过在主节点上打开一个 tailable 游标不断获取进入主节点的 oplog，并且在自己的数据库中回放，以保持跟主节点数据的一致。</li></ul> <h2 id="选举流程"><a href="#选举流程" class="header-anchor">#</a> 选举流程</h2> <ul><li>具有投票权的节点之间亮亮发送心跳。</li> <li>当 5 次心跳未收到回复的时候判断为节点失联</li> <li>如果失联的是主节点，从节点会发起选举，选出新的主节点。</li> <li>如果失联的是从节点则不会产生新的选举。</li> <li>基于 RAFT 一致性算法实现，选举成功的必要条件是大多数的投票节点存活。</li> <li>复制集中最多可以有 50 个节点，但是投票节点最多只能有 7 个。</li></ul> <h2 id="影响选举的因素"><a href="#影响选举的因素" class="header-anchor">#</a> 影响选举的因素</h2> <ul><li><p>整个集群中必须有大多数节点存活</p></li> <li><p>被选举为主节点的节点必须：</p> <ul><li>能够与多数节点建立连接</li> <li>具有较新的 oplog</li> <li>具有较高的优先级</li></ul></li></ul> <h2 id="复制集的选项"><a href="#复制集的选项" class="header-anchor">#</a> 复制集的选项</h2> <ul><li>是否具有投票权，</li> <li>优先级： priority， 优先级越高，越容易成为主节点，优先级为 0 的节点无法成为主节点</li> <li>隐藏： hidden，复制数据，但对应用不可见。隐藏节点可以具有投票权，但优先级必须为 0，也就是说不会被选为主节点。</li> <li>延迟： slaveDelay，复制 n 秒之前的数据，保持与主节点的时间差。</li></ul> <h2 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h2> <ul><li>正常的复制集节点都可能成为主节点，因为硬件配置最好是一样的。</li> <li>为保证节点不会同时宕机，各节点不应该部署在同一个机器或者同一个区域。</li> <li>复制集的软件版本必须一致，避免出现一些奇怪的问题。</li> <li>增加节点可以扩展系统的读性能，但是不能扩展系统的写性能。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/database/mongodb/mongodb_index_2.html" class="prev">
        MongoDB 索引
      </a></span> <span class="next"><a href="/blog/database/mongodb/mongodb_problem_1.html">
        记一次 MongoDB secondary 节点 block 所有读请求的事故
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.11df36d9.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/20.b55c339f.js" defer></script>
  </body>
</html>
