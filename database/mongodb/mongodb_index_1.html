<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB 索引类型 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.6d13759b.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/17.74fd029d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.488e1876.js"><link rel="prefetch" href="/blog/assets/js/23.62f3df12.js"><link rel="prefetch" href="/blog/assets/js/24.13398a36.js"><link rel="prefetch" href="/blog/assets/js/25.061fe821.js"><link rel="prefetch" href="/blog/assets/js/26.fa80b953.js"><link rel="prefetch" href="/blog/assets/js/27.79342037.js"><link rel="prefetch" href="/blog/assets/js/28.224192e2.js"><link rel="prefetch" href="/blog/assets/js/29.2713351c.js"><link rel="prefetch" href="/blog/assets/js/3.d2edf95a.js"><link rel="prefetch" href="/blog/assets/js/30.7b69fe57.js"><link rel="prefetch" href="/blog/assets/js/31.efcfe709.js"><link rel="prefetch" href="/blog/assets/js/32.7ff2ab7d.js"><link rel="prefetch" href="/blog/assets/js/33.0f3c446a.js"><link rel="prefetch" href="/blog/assets/js/34.4786b108.js"><link rel="prefetch" href="/blog/assets/js/35.3c498c3e.js"><link rel="prefetch" href="/blog/assets/js/36.bfbf82b4.js"><link rel="prefetch" href="/blog/assets/js/37.30b8f1ad.js"><link rel="prefetch" href="/blog/assets/js/38.1148a674.js"><link rel="prefetch" href="/blog/assets/js/39.5eeb7b08.js"><link rel="prefetch" href="/blog/assets/js/4.2c9d8f5c.js"><link rel="prefetch" href="/blog/assets/js/40.d6375d92.js"><link rel="prefetch" href="/blog/assets/js/41.002bc860.js"><link rel="prefetch" href="/blog/assets/js/42.1461c1b7.js"><link rel="prefetch" href="/blog/assets/js/43.b0f5584f.js"><link rel="prefetch" href="/blog/assets/js/44.1a945646.js"><link rel="prefetch" href="/blog/assets/js/45.f23f8f18.js"><link rel="prefetch" href="/blog/assets/js/46.780a79ed.js"><link rel="prefetch" href="/blog/assets/js/47.f5ee5c97.js"><link rel="prefetch" href="/blog/assets/js/48.f1cbe58a.js"><link rel="prefetch" href="/blog/assets/js/49.04dae616.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.4371b984.js"><link rel="prefetch" href="/blog/assets/js/51.bbe997be.js"><link rel="prefetch" href="/blog/assets/js/6.dc656f0b.js"><link rel="prefetch" href="/blog/assets/js/7.bda6ec64.js"><link rel="prefetch" href="/blog/assets/js/8.cf18d63f.js"><link rel="prefetch" href="/blog/assets/js/9.cc1fc44e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Database</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>MongoDB</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/database/mongodb/model_design.html" class="sidebar-link">MongoDB 模型设计</a></li><li><a href="/blog/database/mongodb/mongodb_crud_1.html" class="sidebar-link">MongoDB 3.2 的原子性和事务</a></li><li><a href="/blog/database/mongodb/mongodb_crud_2.html" class="sidebar-link">MongoDB 聚合</a></li><li><a href="/blog/database/mongodb/mongodb_index_1.html" class="active sidebar-link">MongoDB 索引类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_index_1.html#默认的-id-索引" class="sidebar-link">默认的 _id 索引</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_index_1.html#单字段索引" class="sidebar-link">单字段索引</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_index_1.html#多键索引" class="sidebar-link">多键索引</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_index_1.html#文本索引" class="sidebar-link">文本索引</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_index_1.html#_2dsphere-索引" class="sidebar-link">2dsphere 索引</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_index_1.html#哈希索引" class="sidebar-link">哈希索引</a></li><li class="sidebar-sub-header"><a href="/blog/database/mongodb/mongodb_index_1.html#索引选项" class="sidebar-link">索引选项</a></li></ul></li><li><a href="/blog/database/mongodb/mongodb_index_2.html" class="sidebar-link">MongoDB 索引</a></li><li><a href="/blog/database/mongodb/mongodb_replica_set.html" class="sidebar-link">MongoDB 复制集</a></li><li><a href="/blog/database/mongodb/mongodb_problem_1.html" class="sidebar-link">记一次 MongoDB secondary 节点 block 所有读请求的事故</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongodb-索引类型"><a href="#mongodb-索引类型" class="header-anchor">#</a> MongoDB 索引类型</h1> <p>索引是提升查询性能非常重要的一个手段。MongoDB 索引的底层实现使用了 B-Tree 的数据结构。在索引中存储特定的字段的值或者一组字段的值，支持按照字段的值排序。</p> <h2 id="默认的-id-索引"><a href="#默认的-id-索引" class="header-anchor">#</a> 默认的 _id 索引</h2> <p>mongodb 在集合创建的时候就会默认生成一个 <code>_id</code> 字段的唯一索引，这个索引阻止客户端插入两条 <code>_id</code> 一样的文档，整个索引无法被 drop。</p> <h2 id="单字段索引"><a href="#单字段索引" class="header-anchor">#</a> 单字段索引</h2> <p>即索引中的字段是文档中的一个字段，一般单字段索引的　value　中，<code>1</code> 指定按升序对项目进行排序的索引，<code>-1</code> 指定按降序对项目进行排序的索引。对于单字段索引和排序操作，索引键的排序顺序（即升序或降序）无关紧要，因为MongoDB可以沿任一方向遍历索引。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 注意，这种方式会在前台创建索引，会阻塞　mongodb 的读写操作。可以使用 background : ture 选项设置后台创建索引。</span>
db<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>score<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="在嵌套字段中创建索引"><a href="#在嵌套字段中创建索引" class="header-anchor">#</a> 在嵌套字段中创建索引</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token punctuation">{</span>
  <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;570c04a4ad233577f97dc459&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">1034</span><span class="token punctuation">,</span>
  <span class="token string">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> state<span class="token operator">:</span> <span class="token string">&quot;NY&quot;</span><span class="token punctuation">,</span> city<span class="token operator">:</span> <span class="token string">&quot;New York&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如上文档所述，如果要查询 `location.state` 字段的值，应该建立如下索引：</span>
db<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;location.state&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token comment">// 可以支持如下的查询：</span>
db<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;location.state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CA&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="在嵌套文档中创建索引"><a href="#在嵌套文档中创建索引" class="header-anchor">#</a> 在嵌套文档中创建索引</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;570c04a4ad233577f97dc459&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">1034</span><span class="token punctuation">,</span>
  <span class="token string">&quot;location&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> state<span class="token operator">:</span> <span class="token string">&quot;NY&quot;</span><span class="token punctuation">,</span> city<span class="token operator">:</span> <span class="token string">&quot;New York&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 还是上面的例子，嵌套文档指的是整个 location 字段，可以创建如下索引：</span>
db<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> location<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token comment">// 上面的索引可以支持对嵌套文档的查询，注意跟上面的区分</span>
<span class="token comment">//  这个例子仍然需要注意的一点是，下面这个查询条件不会查到上面的文档，原因是执行相等匹配的时候，不仅会检查字段的值是否相等，还会匹配字段的顺序是否相同，显然顺序并不相同。</span>
db<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> location<span class="token operator">:</span> <span class="token punctuation">{</span> city<span class="token operator">:</span> <span class="token string">&quot;New York&quot;</span><span class="token punctuation">,</span> state<span class="token operator">:</span> <span class="token string">&quot;NY&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <ul><li>一些驱动程序可能会使用NumberLong（1）而不是1来指定索引。这对结果索引没有任何影响。</li></ul> <p>##　复合索引</p> <p>复合索引指的是将多个字段组合到一起创建索引，这样可以加速匹配多个字段的查询。</p> <h3 id="限制"><a href="#限制" class="header-anchor">#</a> 限制</h3> <ul><li>mongodb 限制复合索引最多指定 32 个字段。</li> <li>创建复合索引不得是哈希索引类型。</li></ul> <h3 id="复合索引的字段顺序和字段排序顺序"><a href="#复合索引的字段顺序和字段排序顺序" class="header-anchor">#</a> 复合索引的字段顺序和字段排序顺序</h3> <p>在一个复合索引里，字段顺序是非常重要的。因为在索引中包含的文档引用会首先按照第一个字段的顺序来排序，满足第一个字段后再按照第二个字段的值来排序，以此类推这样子。</p> <p>在单字段索引中，字段的排序顺序是不重要的，因为 mongodb 可以从索引的任意一头来遍历。但是对于复合索引来说，复合索引中字段的排序顺序可能决定了查询条件中的排序操作是否能够命中索引。</p> <p>比如下面一条查询命令，先按照 username 升序，再按照 date 降序，以此来得到查询结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> date<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以创建如下索引：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 该索引可以正确命中，因为字段排序的顺序和索引中指定的顺序完全一致</span>
db<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;username&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是我们<strong>不能创建</strong>如下索引：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 该索引无法命中，因为索引是先按照 username 升序排序的，再按照 date 降序，索引顺序跟要查询的顺序并不匹配，无法直接从索引中遍历得到对应的文档引用，</span>
<span class="token comment">// 只能全表扫描，然后在内存排序，如果数据量很大触发 mongodb 的内存排序限制，一般是 32MB，操作就会报错。</span>
db<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> date<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>多字段排序的要求：</p> <ul><li>对于索引 <code>{ a: 1, b: 1 }</code>， 可以支持在 <code>{ a: 1, b: 1 }</code> 上的排序，但是不能支持 <code>{ b: 1, a: 1 }</code> 的排序。</li> <li>对于索引 <code>{ a: 1, b: -1 }</code>， 可以支持在 <code>{ a: -1, b: 1 }</code>（相当于反向遍历） 或者 <code>{ a: 1, b: -1 }</code> 上的排序，但是不支持 <code>{ a: -1, b: -1 }</code> 或者 <code>{a: 1, b: 1}</code> 上的排序。</li></ul> <h3 id="复合索引的前缀匹配"><a href="#复合索引的前缀匹配" class="header-anchor">#</a> 复合索引的前缀匹配</h3> <p>索引前缀指的是索引字段的子集。对于如下的索引：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> <span class="token string">&quot;item&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;location&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;stock&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>索引前缀包括如下两条：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 一定要注意，不包括 { location: 1} 或者 { stock： 1 }</span>
<span class="token punctuation">{</span> item<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> item<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> location<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>所以上面的索引实际上可以支持三种字段组合的情况：</p> <ul><li>the <code>item</code> field,</li> <li>the <code>item</code> field and the <code>location</code> field,</li> <li>the <code>item</code> field and the <code>location</code> field and the <code>stock</code> field.</li></ul> <p>mongodb 也可以支持在 <code>item</code> 和 <code>stock</code> 字段的查询，因为 <code>item</code> 字段对应了一个索引前缀，但是这个索引的效率核能不是最优的，更好的方式是建立 <code>item</code> 和 <code>stock</code> 字段的复合索引。</p> <p>因此，如果你的集合中既有 <code>{a： 1， b: 1}</code> 和 <code>{a: 1}</code> 索引，而且这两个索引都不包含 sparse 索引或者 unique 索引的约束，那么可以删掉 <code>{ a：1 }</code> 索引以节省存储空间，由于前缀匹配规则的存在，该索引的用例一定能在另一个索引中完全使用。</p> <h3 id="在索引前缀中的排序"><a href="#在索引前缀中的排序" class="header-anchor">#</a> 在索引前缀中的排序</h3> <h3 id="在非前缀的索引子集中排序"><a href="#在非前缀的索引子集中排序" class="header-anchor">#</a> 在非前缀的索引子集中排序</h3> <h2 id="多键索引"><a href="#多键索引" class="header-anchor">#</a> 多键索引</h2> <p>为了索引包含数组值的字段，MongoDB 为数组中的每个元素创建一个索引键。这些多键索引支持对数组字段的有效查询。可以在既包含标量值（例如字符串，数字）又包含嵌套文档的数组上构造多键索引。</p> <p>如果索引字段是数组，MongoDB 都会自动创建一个多键索引，无需显式指定多键类型。</p> <h3 id="基本数组类型"><a href="#基本数组类型" class="header-anchor">#</a> 基本数组类型</h3> <p>对于如下的基本数组类型，创建多键索引后，索引包含 2， 5， 9 三个 key，并且都指向同一个文档。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// db.survey.createIndex( { ratings: 1 } )</span>
<span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token string">&quot;ABC&quot;</span><span class="token punctuation">,</span> ratings<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="嵌套文档的数组类型"><a href="#嵌套文档的数组类型" class="header-anchor">#</a> 嵌套文档的数组类型</h3> <p>对于如下的嵌套文档的数组类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// db.inventory.createIndex( { &quot;stock.size&quot;: 1, &quot;stock.quantity&quot;: 1 } )</span>
<span class="token punctuation">{</span>
  _id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  item<span class="token operator">:</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">,</span>
  stock<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  _id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  item<span class="token operator">:</span> <span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span>
  stock<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">&quot;black&quot;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token string">&quot;L&quot;</span><span class="token punctuation">,</span> color<span class="token operator">:</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="限制-2"><a href="#限制-2" class="header-anchor">#</a> 限制</h3> <ul><li><p>对于一个复合多键索引，每个被索引的文档最多有一个被索引的字段是数组。例如如下的文档，不能在集合上创建复合多键索引 <code>{a：1，b：1}</code>，因为 a 和 b 字段都是数组。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> a<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> category<span class="token operator">:</span> <span class="token string">&quot;AB - both arrays&quot;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>哈希索引不能是多键索引。</p></li> <li><p>多键索引不能覆盖一个查询。</p></li> <li><p>查询作为一个整体的数组</p></li></ul> <p>当查询过滤器为整个数组指定完全匹配时，MongoDB可以使用多键索引查找查询数组的第一个元素，但不能使用多键索引扫描来查找整个数组。相反，在使用多键索引查找查询数组的第一个元素之后，MongoDB检索关联的文档并过滤其数组与查询中的数组匹配的文档。例如下面的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;food&quot;</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> ratings<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;food&quot;</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token string">&quot;bbb&quot;</span><span class="token punctuation">,</span> ratings<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;food&quot;</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token string">&quot;ccc&quot;</span><span class="token punctuation">,</span> ratings<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;food&quot;</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token string">&quot;ddd&quot;</span><span class="token punctuation">,</span> ratings<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">&quot;food&quot;</span><span class="token punctuation">,</span> item<span class="token operator">:</span> <span class="token string">&quot;eee&quot;</span><span class="token punctuation">,</span> ratings<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>该 collection 有如下的多键索引：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> ratings<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>假设有如下的查询：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> ratings<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>MongoDB 可以使用多键索引来查找在 Ratings 数组中任何值为 5 的文档。然后，MongoDB 检索这些文档并过滤其 ratings 数组等于查询数组 [5、9] 的文档。</p> <h2 id="文本索引"><a href="#文本索引" class="header-anchor">#</a> 文本索引</h2> <h2 id="_2dsphere-索引"><a href="#_2dsphere-索引" class="header-anchor">#</a> 2dsphere 索引</h2> <h2 id="哈希索引"><a href="#哈希索引" class="header-anchor">#</a> 哈希索引</h2> <h2 id="索引选项"><a href="#索引选项" class="header-anchor">#</a> 索引选项</h2> <p>###　TTL 索引</p> <p>TTL索引是特殊的单字段索引，并且字段类型必须是 date 类型或者包含有 date 类型的数组，MongoDB 可以使用它在一定时间后或在特定时钟时间自动从集合中删除文档。 数据到期对于某些类型的信息非常有用，例如机器生成的事件数据，日志和会话信息，这些信息只需要在数据库中持续有限的时间。</p> <h3 id="unique-索引"><a href="#unique-索引" class="header-anchor">#</a> Unique 索引</h3> <p>唯一索引可确保索引字段不存储重复值; 即强制索引字段的唯一性。默认情况下，MongoDB在创建集合期间在_id字段上创建唯一索引。</p> <h3 id="partial-索引"><a href="#partial-索引" class="header-anchor">#</a> partial 索引</h3> <h3 id="sparse-索引"><a href="#sparse-索引" class="header-anchor">#</a> sparse 索引</h3></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/database/mongodb/mongodb_crud_2.html" class="prev">
        MongoDB 聚合
      </a></span> <span class="next"><a href="/blog/database/mongodb/mongodb_index_2.html">
        MongoDB 索引
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.6d13759b.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/17.74fd029d.js" defer></script>
  </body>
</html>
