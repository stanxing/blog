<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>理解事务 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.8ad36d1f.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/5.26b70a23.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.488e1876.js"><link rel="prefetch" href="/blog/assets/js/23.62f3df12.js"><link rel="prefetch" href="/blog/assets/js/24.ed2866c4.js"><link rel="prefetch" href="/blog/assets/js/25.e7705e24.js"><link rel="prefetch" href="/blog/assets/js/26.fa80b953.js"><link rel="prefetch" href="/blog/assets/js/27.79342037.js"><link rel="prefetch" href="/blog/assets/js/28.224192e2.js"><link rel="prefetch" href="/blog/assets/js/29.2713351c.js"><link rel="prefetch" href="/blog/assets/js/3.d2edf95a.js"><link rel="prefetch" href="/blog/assets/js/30.7b69fe57.js"><link rel="prefetch" href="/blog/assets/js/31.35b40577.js"><link rel="prefetch" href="/blog/assets/js/32.131aec90.js"><link rel="prefetch" href="/blog/assets/js/33.0f3c446a.js"><link rel="prefetch" href="/blog/assets/js/34.4786b108.js"><link rel="prefetch" href="/blog/assets/js/35.3c498c3e.js"><link rel="prefetch" href="/blog/assets/js/36.bfbf82b4.js"><link rel="prefetch" href="/blog/assets/js/37.30b8f1ad.js"><link rel="prefetch" href="/blog/assets/js/38.1148a674.js"><link rel="prefetch" href="/blog/assets/js/39.5eeb7b08.js"><link rel="prefetch" href="/blog/assets/js/4.40ca436a.js"><link rel="prefetch" href="/blog/assets/js/40.d6375d92.js"><link rel="prefetch" href="/blog/assets/js/41.002bc860.js"><link rel="prefetch" href="/blog/assets/js/42.1461c1b7.js"><link rel="prefetch" href="/blog/assets/js/43.b0f5584f.js"><link rel="prefetch" href="/blog/assets/js/44.1a945646.js"><link rel="prefetch" href="/blog/assets/js/45.118e3170.js"><link rel="prefetch" href="/blog/assets/js/46.429c0def.js"><link rel="prefetch" href="/blog/assets/js/47.a7e5ccc7.js"><link rel="prefetch" href="/blog/assets/js/48.68bc81c8.js"><link rel="prefetch" href="/blog/assets/js/49.c6a9737f.js"><link rel="prefetch" href="/blog/assets/js/50.62270785.js"><link rel="prefetch" href="/blog/assets/js/6.dc656f0b.js"><link rel="prefetch" href="/blog/assets/js/7.bda6ec64.js"><link rel="prefetch" href="/blog/assets/js/8.cf18d63f.js"><link rel="prefetch" href="/blog/assets/js/9.cc1fc44e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Database</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>MySQL</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/database/mysql/model_design.html" class="sidebar-link">关系数据库模型设计</a></li><li><a href="/blog/database/mysql/transaction.html" class="active sidebar-link">理解事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/database/mysql/transaction.html#数据库带来的并发问题" class="sidebar-link">数据库带来的并发问题</a></li><li class="sidebar-sub-header"><a href="/blog/database/mysql/transaction.html#事务的四大特性" class="sidebar-link">事务的四大特性</a></li><li class="sidebar-sub-header"><a href="/blog/database/mysql/transaction.html#事务的隔离级别" class="sidebar-link">事务的隔离级别</a></li><li class="sidebar-sub-header"><a href="/blog/database/mysql/transaction.html#实际演示" class="sidebar-link">实际演示</a></li><li class="sidebar-sub-header"><a href="/blog/database/mysql/transaction.html#参考" class="sidebar-link">参考</a></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="理解事务"><a href="#理解事务" class="header-anchor">#</a> 理解事务</h1> <h2 id="数据库带来的并发问题"><a href="#数据库带来的并发问题" class="header-anchor">#</a> 数据库带来的并发问题</h2> <h3 id="脏读（dirty-read）"><a href="#脏读（dirty-read）" class="header-anchor">#</a> 脏读（Dirty Read）</h3> <p>当事务 A 正在访问数据库中的某条记录，并且对记录做了修改，而这种修改还没有提交到数据库中。这时另外一个事务 B 也访问了这个数据，然后使用了这个数据。因为这个数据是没有提交的数据，如果事务 A 发生了回滚，那么另一个事务读到的数据就是脏数据，依据脏数据做出的操作可能是不正确的。由于事务 B 读取了脏数据，此种情况被成为脏读。</p> <p>典型的例子就是转账事务和取款事务。假设小明有 3000 元，取款事务读取了该 3000，并且取走了 1000 但没有提交，转账事务读取到小明此时剩余 2000 块，并且转入 2000 元，将最后的结果修改成 4000 元。但实际上当取款事务由于错误发生回滚，转账事务由于读取的是脏数据，其结果是错误的。</p> <h3 id="不可重复读（unrepeatable-read）"><a href="#不可重复读（unrepeatable-read）" class="header-anchor">#</a> 不可重复读（Unrepeatable Read）</h3> <p>指在一个事务中多次读取同一条数据。在事务 A 还没有结束的时候，事务 B 更新了事务 A 读取到的记录，然后事务 A 再次的读取的时候发现读到的结果与上次读取的结果不一致。这就发生了一个事务内两次读取到的记录值不一致的问题，此种情况被成为不可重复读。</p> <h3 id="幻读（phantom-read）"><a href="#幻读（phantom-read）" class="header-anchor">#</a> 幻读（Phantom Read）</h3> <p>幻读与不可重复读有点类似。事务 A 在执行读取操作，需要两次统计行的数量，前一次查询到结果后，此时事务 B 插入或者删除了一些行并提交，此时事务 A 再次统计行的数量发现与第一次不再一致，此种情况被称为幻读。就像产生了幻觉一样，平白无故多了或者少了几条记录。</p> <h4 id="不可重复读和幻读的区别"><a href="#不可重复读和幻读的区别" class="header-anchor">#</a> 不可重复读和幻读的区别</h4> <ul><li>不可重复读是读取了其他事务更改的数据，针对的是 update 操作。</li></ul> <p>解决方案：使用行级锁，锁定该行，在执行完整个事务后才释放该锁，这时候允许其他事务更新。</p> <ul><li>幻读是读取了其他事务增加或者删除的数据，针对的是 insert 或者 delete 操作。</li></ul> <p>解决方案：使用表级锁，锁定整个表，在执行完整个事务后才释放锁。</p> <p>为什么需要区分这两种读呢？因为解决方案不同，一个使用行级锁就能解决，一个得需要使用表级锁。</p> <h3 id="丢失修改（lost-to-modify）"><a href="#丢失修改（lost-to-modify）" class="header-anchor">#</a> 丢失修改（Lost to Modify）</h3> <p>丢失修改指的是，事务 A 在访问一条记录后，事务 B 也访问了该记录，事务 A 对其做了修改操作后提交，事务 B 也对其做了修改操作。这样事务 A 中的修改就被丢失了。例如，事务 A 中读取某表中的字段 age = 20，事务 B 也取到到 A = 20， 事务 A 中做 A = A - 1；事务 B 中也做 A = A -1，这样提交后的结果为 19，但事务 A 的修改丢失了，实际上结果应该是 18。</p> <h2 id="事务的四大特性"><a href="#事务的四大特性" class="header-anchor">#</a> 事务的四大特性</h2> <ul><li><p>原子性（Atomicity）：一个事务中操作，要么全部完成，要不全部不完成，不会结束在某个中间环节。事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务没执行过一样。即，事务不可分割，不可简约。</p></li> <li><p>一致性（Consitency）：一个事务执行前和执行后都必须处于一致性状态。拿转账来说，假设用户 A 和用户 B 两者加起来的钱是 5000， 那么不管两人经历了多少次转账，事务结束后，两个用户的前加起来总和是不变的，这就是事务的一致性。</p></li> <li><p>隔离性（Isolation）：一个事务未提交的结果是否对其他事务可见。级别一般有 read_uncommit，read_commit，read_repeatable，Serializable 串行化访问。会在后面详细介绍。</p></li> <li><p>持久性（Durability）：一个事务一旦提交了，那么对数据的改变是持久化的，即便是数据库遇到系统故障的情况下也不会丢掉事务的操作。</p></li></ul> <h2 id="事务的隔离级别"><a href="#事务的隔离级别" class="header-anchor">#</a> 事务的隔离级别</h2> <p>SQL 标准定义了四个隔离级别：</p> <ul><li><p>READ-UNCOMMITTED（读取未提交）：最低的隔离级别，允许读取未提交的数据变更，可能会导致 <strong>脏读</strong>，<strong>不可重复读</strong>, <strong>幻读</strong>。</p></li> <li><p>READ-COMMITTED（读取已提交）：允许事务读取已提交的数据，可以阻止脏读，但是 <strong>幻读</strong>， <strong>不可重复读</strong> 仍然有可能发生。</p></li> <li><p>Repeatable READ（可重复读）：对同一字段的多次读取结果都是一致的，除非是数据被事务自己所修改，可以阻止 <strong>脏读</strong> 和 <strong>不可重复读</strong>，但是不能阻止 <strong>幻读</strong>，也就是加了行级锁（只有表级锁才能阻止幻读）。</p></li> <li><p>Serializable（串行化）：最高的隔离级别，完全服务 ACID 的约束。所有事务逐个一次进行，这样事务之间就不会产生任何干扰，也就是说，该级别可以阻止 <strong>脏读</strong>，<strong>不可重复读</strong> 和<strong>幻读</strong>。</p></li></ul> <p><img src="/blog/assets/img/isolation_level.ea1c5652.png" alt="isolation"></p> <h3 id="mysql"><a href="#mysql" class="header-anchor">#</a> MySQL</h3> <p>MySQL InnoDB 默认使用了 REPEATABLE-READ（可重复的读）。我们可以通过<code>SELECT @@tx_isolation;</code> 命令来查看，MySQL 8.0 该命令改为 <code>SELECT @@transaction_isolation;</code>。</p> <h2 id="实际演示"><a href="#实际演示" class="header-anchor">#</a> 实际演示</h2> <p>参考<a href="https://github.com/Snailclimb/JavaGuide/blob/master/docs/database/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB(%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3).md#%E5%AE%9E%E9%99%85%E6%83%85%E5%86%B5%E6%BC%94%E7%A4%BA" target="_blank" rel="noopener noreferrer">演示<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://cloud.tencent.com/developer/article/1450773" target="_blank" rel="noopener noreferrer">快速理解脏读、不可重复读、幻读<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/Snailclimb/JavaGuide/blob/master/docs/database/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB(%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3).md" target="_blank" rel="noopener noreferrer">事务隔离级别<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/database/mysql/model_design.html" class="prev">
        关系数据库模型设计
      </a></span> <span class="next"><a href="/blog/infrastructure/k8s/kubeadm.html">
        kubeadm 介绍
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8ad36d1f.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/5.26b70a23.js" defer></script>
  </body>
</html>
