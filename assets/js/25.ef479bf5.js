(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{207:function(s,a,t){"use strict";t.r(a);var n=t(6),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"基于-gitlab-搭建代码托管平台"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于-gitlab-搭建代码托管平台"}},[s._v("#")]),s._v(" 基于 GitLab 搭建代码托管平台")]),s._v(" "),t("h2",{attrs:{id:"背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),t("h3",{attrs:{id:"运行方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行方式"}},[s._v("#")]),s._v(" 运行方式")]),s._v(" "),t("p",[s._v("本 gitlab 安装方式使用的是官方推荐的 Omnibus，该安装方式将 gitlab 众多组件打包在了一起，极大的简化了 gitlab 的配置。同时，使用了官方的 docker 镜像，以容器化的方式进行部署。因此，若无特殊说明，以下提到的命令均需要在容器中执行，提到的目录均指的是容器中的目录，若需要在机器上直接执行，请使用 "),t("code",[s._v("docker exec -it gitlab_gitlab_1 ${command}")]),s._v(" 的格式来运行命令。")]),s._v(" "),t("h3",{attrs:{id:"网络架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网络架构"}},[s._v("#")]),s._v(" 网络架构")]),s._v(" "),t("ul",[t("li",[s._v("vpc：\n"),t("ul",[t("li",[s._v("独立 vpc。")])])]),s._v(" "),t("li",[s._v("ecs：\n"),t("ul",[t("li",[s._v("绑定了弹性公网 ip。")]),s._v(" "),t("li",[s._v("修改 "),t("code",[s._v("/etc/ssh/sshd_config")]),s._v(" 文件，将端口改为 2222，并重新启动 sshd 服务。这一步是为了把 ssh 端口让给 docker 容器映射，以实现 ssh 协议 clone 代码。")])])]),s._v(" "),t("li",[s._v("slb：\n"),t("ul",[t("li",[s._v("配置 http 监听 443，并做证书认证，之后将流量转到后端的 80端口; 配置 TCP 协议将 22 端口的流量转到后端 22 端口; 配置 http 重定向到 https。")]),s._v(" "),t("li",[s._v("添加访问控制白名单。")])])]),s._v(" "),t("li",[s._v("堡垒机：\n"),t("ul",[t("li",[s._v("创建资产 "),t("code",[s._v("gitlab")]),s._v("，运维端口 2222， 授权 sre 用户组。")])])])]),s._v(" "),t("h2",{attrs:{id:"docker-compose-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-yml"}},[s._v("#")]),s._v(" docker-compose.yml")]),s._v(" "),t("p",[s._v("参见 docker-compose.yml 文件的内容：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gitlab")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab/gitlab"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ce"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("12.8.6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ce.0\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://gitlab.com/gitlab-org/gitlab-ce/issues/40379#note_60464469")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("entrypoint")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n      bash -c 'sed -i \"s/MIN_CHARS_FOR_PARTIAL_MATCHING = 3/MIN_CHARS_FOR_PARTIAL_MATCHING = 1/g\" /opt/gitlab/embedded/service/gitlab-rails/lib/gitlab/sql/pattern.rb && /assets/wrapper'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("GITLAB_OMNIBUS_CONFIG")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n        # https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template\n        external_url \"https://gitlab.example.com\"\n        # https://docs.gitlab.com/omnibus/settings/nginx.html#supporting-proxied-ssl\n        nginx['listen_port'] = 80\n        nginx['listen_https'] = false\n        pages_external_url \"https://gitlab-pages.example.com\"\n        gitlab_pages['enable'] = true\n        gitlab_pages['external_http'] = [\"0.0.0.0:9090\"]\n        pages_nginx['listen_port'] = 80\n        pages_nginx['listen_https'] = false\n        gitlab_pages['listen_proxy'] = \"localhost:8090\"\n        # https://gitlab.com/gitlab-org/gitlab-pages/issues/129\n        gitlab_pages['inplace_chroot'] = true\n        postgresql['enable'] = true\n        postgresql['statement_timeout'] = \"1800000\" # 30分钟\n        gitlab_rails['db_adapter'] = \"postgresql\"\n        gitlab_rails['db_encoding'] = \"unicode\"\n        gitlab_rails['db_database'] = \"gitlabhq_production\"")]),s._v("\n\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_issue_closing_pattern'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "abcdefg"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'time_zone'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "Asia/Shanghai"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_default_projects_features_wiki'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_default_can_create_group'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_username_changing_enabled'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = true\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_address'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "smtpdm.aliyun.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_port'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = 465\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_user_name'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "gitlab@sre.example.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_password'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "xxxxxx"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_domain'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "gitlab.example.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_authentication'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "login"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_tls'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = true\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable_starttls_auto'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = true\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'smtp_openssl_verify_mode'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "peer"\n\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_enabled'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_address'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "gitlab@sre.example.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_email'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "gitlab@sre.example.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_password'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "xxxxxx"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_host'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "imap.mxhichina.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_port'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = 993\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_ssl'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = true\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_start_tls'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'incoming_email_mailbox_name'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "inbox"\n\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_email_from'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "gitlab@sre.example.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_email_display_name'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "GitLab"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_email_reply_to'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "gitlab@sre.example.com"\n        gitlab_rails'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab_email_subject_suffix'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = ""\n\n        unicorn'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'worker_processes'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = 10\n        unicorn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'worker_timeout'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = 120\n        unicorn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'worker_memory_limit_min'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "400 * 1 << 20"\n        unicorn'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'worker_memory_limit_max'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' = "650 * 1 << 20"\n\n        logging'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'logrotate_rotate'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = 7\n\n        gitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup_keep_time'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = 86400 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1天")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该插件目前不管是否配置了 aliyun_oss_endpoint 只会走公网来上传备份文件，")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所以暂时用不了 gitlab 自动上传的备份的功能")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 相关 issue：https://github.com/fog/fog-aliyun/issues/30")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab_rails['backup_upload_connection'] = {")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   'provider' => 'aliyun',")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   'aliyun_accesskey_id' => 'xxx',")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   'aliyun_accesskey_secret' => 'xxx',")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   'aliyun_region_id' => 'cn-hangzhou',")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   'aliyun_oss_bucket' => 'xxx',")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   'aliyun_oss_endpoint' => 'http://oss-cn-hangzhou-internal.aliyuncs.com'")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# }")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab_rails['backup_upload_remote_directory'] = \"gitlabBackups\"")]),s._v("\n\n        prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        alertmanager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        node_exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        redis_exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        postgres_exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        gitlab_monitor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n        grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" = false\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"80:80"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"22:22"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9090:9090"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /data/gitlab/config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/gitlab\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /data/gitlab/logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/log/gitlab\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /data/gitlab/data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/opt/gitlab\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为 docker 容器挂载本地时区文件")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /etc/localtime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/localtime\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br"),t("span",{staticClass:"line-number"},[s._v("86")]),t("br"),t("span",{staticClass:"line-number"},[s._v("87")]),t("br"),t("span",{staticClass:"line-number"},[s._v("88")]),t("br"),t("span",{staticClass:"line-number"},[s._v("89")]),t("br"),t("span",{staticClass:"line-number"},[s._v("90")]),t("br"),t("span",{staticClass:"line-number"},[s._v("91")]),t("br"),t("span",{staticClass:"line-number"},[s._v("92")]),t("br"),t("span",{staticClass:"line-number"},[s._v("93")]),t("br"),t("span",{staticClass:"line-number"},[s._v("94")]),t("br"),t("span",{staticClass:"line-number"},[s._v("95")]),t("br"),t("span",{staticClass:"line-number"},[s._v("96")]),t("br"),t("span",{staticClass:"line-number"},[s._v("97")]),t("br"),t("span",{staticClass:"line-number"},[s._v("98")]),t("br"),t("span",{staticClass:"line-number"},[s._v("99")]),t("br"),t("span",{staticClass:"line-number"},[s._v("100")]),t("br"),t("span",{staticClass:"line-number"},[s._v("101")]),t("br")])]),t("h3",{attrs:{id:"自动备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自动备份"}},[s._v("#")]),s._v(" 自动备份")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("备份 /etc/gitlab 目录下的所有文件（gitlab 配置文件、secrets 以及各种 key 文件存放路径）。在第一次安装生成这些文件后，将该文件夹在机器上 copy 一份即可，不需要天天备份。")])]),s._v(" "),t("li",[t("p",[s._v("备份 数据库、代码仓库、图片文件等。使用 gitlab 自带的命令进行备份，备份需要上传至阿里云 oss 存储。请使用 "),t("code",[s._v("crontab -e")]),s._v(" 将执行命令添加到定时任务中以完成自动备份，命令如下：")])])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab 本身也支持自动备份的功能，但是由于备份阿里云插件的 bug 没有选择使用，请参考 docker-compose.yml 中 `gitlab_rails['backup_upload_connection']` 的说明")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" * * * /root/gitlab/scripts/backup/backup.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /data/gitlab/logs/backup.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("脚本内容：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash -e")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /data/gitlab/data/backups\n\ndocker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -t gitlab_gitlab_1 gitlab-rake gitlab:backup:create "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CRON")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("latestBackupFile")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"gitlab_backup.tar"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'END {print}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uploading '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${latestBackupFile}")]),s._v('..."')]),s._v("\nossutil64 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${latestBackupFile}")]),s._v(" oss://bucket/gitlabBackups/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${latestBackupFile}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h2",{attrs:{id:"查看日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看日志"}},[s._v("#")]),s._v(" 查看日志")]),s._v(" "),t("ul",[t("li",[s._v("以命令方式查看日志")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 实时查看全部的日志输出")]),s._v("\ngitlab-ctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 实时查看某个组件的日志输出，例如 gitlab-rails")]),s._v("\ngitlab-ctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" gitlab-rails\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 深入查看某个文件")]),s._v("\ngitlab-ctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" nginx/gitlab_error.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("以文件方式查看日志")])]),s._v(" "),t("p",[s._v("所有 gitlab 相关日志都存放在 "),t("code",[s._v("/var/log/gitlab")]),s._v(" 目录下，分别以组件名称作为子目录单独存放。")]),s._v(" "),t("ul",[t("li",[s._v("在应用程序中查看日志")])]),s._v(" "),t("p",[s._v("在 "),t("a",{attrs:{href:"https://gitlab.example.com/admin/logs",target:"_blank",rel:"noopener noreferrer"}},[s._v("Admin Area -> Monitoring -> Logs"),t("OutboundLink")],1),s._v(" 中可查看各组件相关日志。")]),s._v(" "),t("h2",{attrs:{id:"查看配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看配置文件"}},[s._v("#")]),s._v(" 查看配置文件")]),s._v(" "),t("p",[s._v("Omnibus 将全部组件的配置项集中在了 "),t("code",[s._v("/etc/gitlab/gitlab.rb")]),s._v(" 中，并提供了 "),t("code",[s._v("gitlab-ctl reconfigure")]),s._v(" 命令解析配置项并生成各个组件的专属配置文件并 copy 到组件对应的配置目录中。下面是几个重要组件的配置文件所在的目录：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab-rails")]),s._v("\n/var/opt/gitlab/gitlab-rails/etc\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx")]),s._v("\n/var/opt/gitlab/nginx/conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab-shell")]),s._v("\n/var/opt/gitlab/gitlab-shell\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# postgresql")]),s._v("\n/var/opt/gitlab/postgresql/data\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis")]),s._v("\n/var/opt/gitlab/redis\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("需要注意的是，本项目采用环境变量的方式传入需要更改的配置项，如果需要修改某配置项，不应该直接在容器中修改配置，而是应该在 docker-compose 文件中修改，使得改动可以被 track。")]),s._v(" "),t("h2",{attrs:{id:"查看数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看数据库"}},[s._v("#")]),s._v(" 查看数据库")]),s._v(" "),t("h3",{attrs:{id:"登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#登录"}},[s._v("#")]),s._v(" 登录")]),s._v(" "),t("ul",[t("li",[s._v("以 superuser 登录数据库")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录用户为 gitlab-psql")]),s._v("\ngitlab-psql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"控制台调试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#控制台调试"}},[s._v("#")]),s._v(" 控制台调试")]),s._v(" "),t("p",[s._v("首先需要启动一个可以执行 ruby 代码的控制台：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("gitlab-rails console\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("测试邮件能否发送成功")])]),s._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Notify")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("test_email"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'stan.xing@example.com'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Message Subject'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Message Body'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deliver_now\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("注意：console 中执行的代码可能会修改原有的数据，要小心操作。")]),s._v(" "),t("h2",{attrs:{id:"恢复备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#恢复备份"}},[s._v("#")]),s._v(" 恢复备份")]),s._v(" "),t("p",[s._v("需要先将备份文件拷贝到机器上的 "),t("code",[s._v("/data/gitlab/data/backups")]),s._v(" 目录下，即容器中挂载的备份路径。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# name 的值为备份文件名称中的时间加版本号，举例如下：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份文件名称为 1566880022_2019_08_27_11.11.3_gitlab_backup.tar，则 name 的值为 1566880022_2019_08_27_11.11.3")]),s._v("\ngitlab-rake gitlab:backup:restore "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RAILS_ENV")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("production "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BACKUP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${name}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("force")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"gitlab-升级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-升级"}},[s._v("#")]),s._v(" Gitlab 升级")]),s._v(" "),t("h3",{attrs:{id:"从-11-11-3-到-12-8-6-升级方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#从-11-11-3-到-12-8-6-升级方案"}},[s._v("#")]),s._v(" 从 11.11.3 到 12.8.6 升级方案")]),s._v(" "),t("p",[s._v("根据"),t("a",{attrs:{href:"https://docs.gitlab.com/ce/policy/maintenance.html#upgrade-recommendations",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档的升级推荐"),t("OutboundLink")],1),s._v("介绍，gitlab 同 major 版本下跨 minor 和 patch 版本升级是安全的，但是跨 major 版本升级需要先升级到当前 major 版本的最新 minor 和 patch 版本。")]),s._v(" "),t("p",[s._v("为了保证升级版本的之间的 migration 能正确执行，从 11.11.2 升级到最新版（12.8.6）需要按照如下步骤来进行：")]),s._v(" "),t("ul",[t("li",[s._v("升级 11.11.3 => 11.11.8, 先升级到主版本号为 11 的最后一个 release tag，升级后检查 migration 是否结束。")]),s._v(" "),t("li",[s._v("升级 11.11.8 => 12.0.9，再升级到 12.0 的最后一个 patch 版本，升级后检查 migration 是否结束。")]),s._v(" "),t("li",[s._v("升级 12.0.9 => 12.8.6, gitlab 最新版，升级后检查 migration 是否结束。")])]),s._v(" "),t("h3",{attrs:{id:"升级准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#升级准备"}},[s._v("#")]),s._v(" 升级准备")]),s._v(" "),t("h4",{attrs:{id:"下载-docker-镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下载-docker-镜像"}},[s._v("#")]),s._v(" 下载 docker 镜像")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 11.11.3 => 11.11.8 => 12.0.9 => 12.8.6")]),s._v("\ndocker pull gitlab/gitlab-ce:11.11.8-ce.0\ndocker pull gitlab/gitlab-ce:12.0.9-ce.0\ndocker pull gitlab/gitlab-ce:12.8.6-ce.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h4",{attrs:{id:"检查-migration-是否结束的命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查-migration-是否结束的命令"}},[s._v("#")]),s._v(" 检查 migration 是否结束的命令")]),s._v(" "),t("p",[s._v("文档参考"),t("a",{attrs:{href:"https://docs.gitlab.com/ce/update/README.html#checking-for-background-migrations-before-upgrading",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1)]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it gitlab_gitlab_1 gitlab-rails console\nputs Sidekiq::Queue.new"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"background_migration"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".size\nSidekiq::ScheduledSet.new.select "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("r"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" r.klass "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'BackgroundMigrationWorker'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(".size\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"升级步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#升级步骤"}},[s._v("#")]),s._v(" 升级步骤")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("./stop")]),s._v(" 停掉当前 gitlab。")]),s._v(" "),t("li",[s._v("替换 docker-compose 镜像 image 为 "),t("code",[s._v("gitlab/gitlab-ce:11.11.8-ce.0")]),s._v("。")]),s._v(" "),t("li",[t("code",[s._v("./start")]),s._v(" 后执行 "),t("code",[s._v("docker logs -f gitlab_gitlab_1")]),s._v(" 查看有无报错或不正常日志。")]),s._v(" "),t("li",[s._v("检查 migration 是否结束。根据后台监控显示， migration job 大概需要等待 4 分钟才进入队列中执行。")]),s._v(" "),t("li",[s._v("migration 结束后简单测试功能是否正常，主要是 list/create/close issue、MR，发邮件这些。")]),s._v(" "),t("li",[s._v("重复上面 1-5 步骤升级 "),t("code",[s._v("gitlab/gitlab-ce:12.0.9-ce.0")])]),s._v(" "),t("li",[s._v("重复上面 1-5 步骤升级 "),t("code",[s._v("gitlab/gitlab-ce:12.8.6-ce.0")])])]),s._v(" "),t("h3",{attrs:{id:"备注"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备注"}},[s._v("#")]),s._v(" 备注")]),s._v(" "),t("p",[s._v("升级过程中 gitlab 各组件版本变化:")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("GitLab "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.11")]),s._v(".3 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e3eeb779d72"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nGitLab Shell "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.1")]),s._v(".0\nGitLab Workhorse v8.7.0\nGitLab API v4\nGitLab Pages "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v(".0\nRuby "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.5")]),s._v(".3p105\nRails "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.1")]),s._v(".7\nPostgreSQL "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.7")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("GitLab "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.11")]),s._v(".8 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("1d18d065069"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nGitLab Shell "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.1")]),s._v(".0\nGitLab Workhorse v8.7.0\nGitLab API v4\nGitLab Pages "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.5")]),s._v(".1\nRuby "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.5")]),s._v(".3p105\nRails "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.1")]),s._v(".7\nPostgreSQL "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.7")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("GitLab "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12.0")]),s._v(".9 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("891da1422d9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nGitLab Shell "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.3")]),s._v(".0\nGitLab Workhorse v8.7.1\nGitLab API v4\nGitLab Pages "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.6")]),s._v(".3\nRuby "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.6")]),s._v(".3p62\nRails "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.1")]),s._v(".7\nPostgreSQL "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.7")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("GitLab "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12.8")]),s._v(".6 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("5fc76a64537"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nGitLab Shell "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.0")]),s._v(".0\nGitLab Workhorse v8.21.0\nGitLab API v4\nGitLab Pages "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.16")]),s._v(".0\nRuby "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.6")]),s._v(".5p114\nRails "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6.0")]),s._v(".2\nPostgreSQL "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.12")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h2",{attrs:{id:"其他常用命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他常用命令"}},[s._v("#")]),s._v(" 其他常用命令")]),s._v(" "),t("p",[s._v("下面仅仅列出了一些常用的运维命令，gitlab 还封装了很多功能强大的构建脚本，具体请查看参考资料中的 "),t("code",[s._v("rake tasks")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 gitlab 所有组件;若要单独启动某个组件，请在后面添加组件名称")]),s._v("\ngitlab-ctl start\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止 gitlab 所有组件")]),s._v("\ngitlab-ctl stop\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启 gitlab 所有组件")]),s._v("\ngitlab-ctl restart\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 gitlab 各个组件状态")]),s._v("\ngitlab-ctl status\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新生成生成配置文件（修改某项配置后，需要执行该命令）")]),s._v("\ngitlab-ctl reconfigure\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 gitlab 各个组件版本")]),s._v("\ngitlab-rake gitlab:env:info\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查 gitlab 各个组件")]),s._v("\ngitlab-rake gitlab:check "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SANITIZE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新 postgresql（具体更新到什么版本请参考文档）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://docs.gitlab.com/omnibus/package-information/postgresql_versions.html")]),s._v("\ngitlab-ctl pg-upgrade\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h2",{attrs:{id:"参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://docs.gitlab.com/omnibus/",target:"_blank",rel:"noopener noreferrer"}},[s._v("omnibus"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://docs.gitlab.com/omnibus/maintenance/",target:"_blank",rel:"noopener noreferrer"}},[s._v("omnibus maintenance"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://docs.gitlab.com/ee/raketasks/backup_restore.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("backup_restore"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://docs.gitlab.com/ee/raketasks/",target:"_blank",rel:"noopener noreferrer"}},[s._v("rake tasks"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);