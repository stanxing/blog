<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Telegraf 源码阅读 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.2efd3993.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/7.e70cb6ab.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.965e5f58.js"><link rel="prefetch" href="/blog/assets/js/23.8248b6b6.js"><link rel="prefetch" href="/blog/assets/js/24.fe6aef0a.js"><link rel="prefetch" href="/blog/assets/js/25.ef479bf5.js"><link rel="prefetch" href="/blog/assets/js/26.b745054e.js"><link rel="prefetch" href="/blog/assets/js/27.e9839df3.js"><link rel="prefetch" href="/blog/assets/js/28.796bfa26.js"><link rel="prefetch" href="/blog/assets/js/29.38b104b6.js"><link rel="prefetch" href="/blog/assets/js/3.159d2146.js"><link rel="prefetch" href="/blog/assets/js/30.4af86574.js"><link rel="prefetch" href="/blog/assets/js/31.90b14a89.js"><link rel="prefetch" href="/blog/assets/js/32.b471f649.js"><link rel="prefetch" href="/blog/assets/js/33.d8e805f8.js"><link rel="prefetch" href="/blog/assets/js/34.09a753bf.js"><link rel="prefetch" href="/blog/assets/js/35.3fee7620.js"><link rel="prefetch" href="/blog/assets/js/36.03747912.js"><link rel="prefetch" href="/blog/assets/js/37.554dda8c.js"><link rel="prefetch" href="/blog/assets/js/38.46bcde33.js"><link rel="prefetch" href="/blog/assets/js/39.a82e6ea2.js"><link rel="prefetch" href="/blog/assets/js/4.8ed88519.js"><link rel="prefetch" href="/blog/assets/js/40.d6208f57.js"><link rel="prefetch" href="/blog/assets/js/41.b7a3a229.js"><link rel="prefetch" href="/blog/assets/js/42.ffb33af9.js"><link rel="prefetch" href="/blog/assets/js/43.c90b42ae.js"><link rel="prefetch" href="/blog/assets/js/44.fe190f21.js"><link rel="prefetch" href="/blog/assets/js/45.a4116688.js"><link rel="prefetch" href="/blog/assets/js/46.395f4bf2.js"><link rel="prefetch" href="/blog/assets/js/47.898431b6.js"><link rel="prefetch" href="/blog/assets/js/48.cb7a367c.js"><link rel="prefetch" href="/blog/assets/js/49.0f5b617e.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.bfaba15c.js"><link rel="prefetch" href="/blog/assets/js/51.604e12fd.js"><link rel="prefetch" href="/blog/assets/js/52.e63c94bd.js"><link rel="prefetch" href="/blog/assets/js/6.169e9be1.js"><link rel="prefetch" href="/blog/assets/js/8.2450bca1.js"><link rel="prefetch" href="/blog/assets/js/9.5476b311.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Infrastructure</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Log</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Logstash</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Monitor</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>Influxdata</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/infrastructure/monitor/influxdata/telegraf.html" class="active sidebar-link">Telegraf 源码阅读</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/infrastructure/monitor/influxdata/telegraf.html#数据流向图" class="sidebar-link">数据流向图</a></li><li class="sidebar-sub-header"><a href="/blog/infrastructure/monitor/influxdata/telegraf.html#主函数处理流程" class="sidebar-link">主函数处理流程</a></li></ul></li><li><a href="/blog/infrastructure/monitor/influxdata/tick.html" class="sidebar-link">基于 Tick 脚本的报警设计</a></li><li><a href="/blog/infrastructure/monitor/influxdata/batch_vs_stream.html" class="sidebar-link">Kapacitor Batch Vs Stream</a></li><li><a href="/blog/infrastructure/monitor/influxdata/down_sampling.html" class="sidebar-link">数据降采样</a></li></ul></section></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="telegraf-源码阅读"><a href="#telegraf-源码阅读" class="header-anchor">#</a> Telegraf 源码阅读</h1> <p><a href="https://www.influxdata.com/time-series-platform/telegraf/" target="_blank" rel="noopener noreferrer">Telegraf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是 influxData 公司开源的基于插件的数据收集和发送代理，是监控平台搭建中必不可少的一环。公司内部的监控平台的数据收集组件就使用了它，源于其插件化的可扩展性，非常适合自定义。本篇文章分享下 telegraf（版本 1.3） 内部的实现机制，从中确实学到了很多东西。</p> <h2 id="数据流向图"><a href="#数据流向图" class="header-anchor">#</a> 数据流向图</h2> <p>下面是 telegraf 处理数据的流程图，其插件一共分为四类，分别如下：</p> <ul><li>inputs：输入插件，用于生成 metrics，inputs 插件有两类，分别需要实现 <code>telegraf.Input</code> 或 <code>telegraf.ServiceInput</code> 接口。</li> <li>processors：用于对数据的流式处理，processors 各插件之间按照顺序执行，需要实现 <code>telegraf.Processor</code> 接口。</li> <li>aggregators：用于对 period 时间内的数据做一些聚合处理，返回聚合后的结果给 output 端，需要实现 <code>telegraf.Aggregator</code> 接口。</li> <li>outputs：输出后端，比如 influxdb，文件等，对应 inputs，也分两种类型，分别需要实现 <code>telegraf.Output</code> 或 <code>telegraf.ServiceOutput</code> 接口。</li></ul> <p>其中，这四类插件全部支持 Filter，可以在任意阶段丢弃或添加字段，下面会详细介绍。</p> <p><img src="/blog/assets/img/telegraf-1.05d44953.png" alt="telegraf"></p> <h2 id="主函数处理流程"><a href="#主函数处理流程" class="header-anchor">#</a> 主函数处理流程</h2> <ul><li><p>该项目的入口文件是 <code>cmd/telegraf.go</code>，在 <code>import</code> 阶段便做了一件非常重要的事情，那便是 import 各插件对应的 package 文件，以使得内部的 init 函数得以执行，从而将各插件在初始化的时候便注册到了相应的变量里，主要 import 代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token operator">...</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/influxdata/telegraf/plugins/aggregators/all&quot;</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/influxdata/telegraf/plugins/inputs/all&quot;</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/influxdata/telegraf/plugins/outputs/all&quot;</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/influxdata/telegraf/plugins/processors/all&quot;</span>
    <span class="token operator">...</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以 <code>import .../inputs/all</code> 为例分析：</p> <ul><li>第一步，进入到 <code>plugins/inputs/all</code> 包中可以发现，里面导入了 inputs 目录下定义的所有插件包：</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/influxdata/telegraf/plugins/inputs/aerospike&quot;</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/influxdata/telegraf/plugins/inputs/amqp_consumer&quot;</span>
    <span class="token boolean">_</span> <span class="token string">&quot;github.com/influxdata/telegraf/plugins/inputs/apache&quot;</span>
    <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>随便找了一个具体的 inputs 文件夹下的包查看，例如 <code>plugins/inputs/apache&quot;</code>,可以看到，内部定义了 init 函数，其中调用 <code>inputs.Add()</code> 方法将该插件的实例注册到了 <code>inputs.Inputs</code> map 中。从代码中可以看到，map 的 value 类型 <code>Creator</code> 是一个函数，返回 <code>telegraf.Input</code> 接口。显然，每一个自定义的 input 插件必须实现该接口，才能被框架所用。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// plugins/inputs/apache.go</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inputs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;apache&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> telegraf<span class="token punctuation">.</span>Input <span class="token punctuation">{</span>
	    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Apache<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// plugins/inputs/registry.go</span>
<span class="token keyword">package</span> inputs

<span class="token keyword">type</span> Creator <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> telegraf<span class="token punctuation">.</span>Input

<span class="token keyword">var</span> Inputs <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Creator<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Add</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> creator Creator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Inputs<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> creator
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>其余三类插件的初始化逻辑都是一样的，每个插件注册的 <code>Creator</code> 函数返回对应的接口类型。</p></li> <li><p>当插件初始化完成后，进入 <code>main</code> 函数逻辑：</p> <ul><li>第一步，<code>flag.Parse()</code>, 各 flag 参数的意义都很明确了，以 <code>fInputFilters</code> 为例，其定义了当程序运行时，启用的 input 插件名称，多个值以冒号隔开。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token operator">...</span>
<span class="token keyword">var</span> fInputFilters <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;input-filter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;filter the inputs to enable, separator is :&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> fInputList <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">&quot;input-list&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;print available input plugins.&quot;</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>省略若干代码，接下来便进入到最重要的 <code>reloadLoop</code> 函数, 该函数接收命令行参数传入的插件信息，开始初始化和运行逻辑：</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token function">reloadLoop</span><span class="token punctuation">(</span>stop <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inputFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> outputFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> aggregatorFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> processorFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>reloadLoop</code> 函数介绍，下面主要介绍函数里执行的主要流程：</p> <ul><li>利用一个带缓冲的 channel 实现了 reload 机制，通过 SIGHUP 信号触发，实现逻辑还是比较简洁的，在进入 for 循环后，又执行了一次 <code>reload &lt;- false</code> 是为了当 <code>ag.Run(shutdown)</code> 退出后整个 for 循环也正确退出；由于执行 <code>ag.Run(shutdown)</code> 会一直收集数据而阻塞，正常情况下 for 循环只会执行一次，收到 <code>SIGHUP</code> 信号后，先 <code>&lt;-reload</code> 取出第二次设置的 false， 再 <code>close(shutdown)</code> 并设置 <code>reload &lt;- true</code> 以便再次进入 for 循环，由此便实现了 reload 机制：</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>reload <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
reload <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
<span class="token keyword">for</span> <span class="token operator">&lt;-</span>reload <span class="token punctuation">{</span>
    reload <span class="token operator">&lt;-</span> <span class="token boolean">false</span>
    <span class="token comment">// 省去无关代码</span>
    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>signals<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Interrupt<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGHUP<span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> sig <span class="token operator">:=</span> <span class="token operator">&lt;-</span>signals<span class="token punctuation">:</span>
            <span class="token keyword">if</span> sig <span class="token operator">==</span> os<span class="token punctuation">.</span>Interrupt <span class="token punctuation">{</span>
                <span class="token function">close</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> sig <span class="token operator">==</span> syscall<span class="token punctuation">.</span>SIGHUP <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;I! Reloading Telegraf config\n&quot;</span><span class="token punctuation">)</span>
                <span class="token operator">&lt;-</span>reload
                reload <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
                <span class="token function">close</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>stop<span class="token punctuation">:</span>
            <span class="token function">close</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 省去无关代码</span>
    ag<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ul><li><p><code>c.LoadConfig(*fConfig)</code> 解析配置文件，初始化 config 结构体。该函数会传入配置文件的路径，解析配置项，telegraf 的配置文件采用的是 TOML 的语法。配置项里定义的每个插件都会调用其对应类型的 <code>add${type}</code> 方法去完成插件和参数的映射，在下面会具体介绍。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>c <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">LoadConfig</span><span class="token punctuation">(</span><span class="token operator">*</span>fConfig<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><code>ag := agent.NewAgent(c)</code> 初始化 agent 结构体。agent 可以理解成整个 telegraf 全局的代理，由它发起所有的操作。其结构体只保存了 config 字段。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Agent <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Config <span class="token operator">*</span>config<span class="token punctuation">.</span>Config
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>err = ag.Connect()</code> 从 <code>a.Config.Outputs</code> 中获取到所有的 ouptput 实例，然后调用其内部的 <code>Connect</code> 方法与后端进行连接，为收集 metrics 做准备。</p></li> <li><p><code>ag.Run(shutdown)</code> 运行主逻辑，开始收集，处理和发送 metrics，将重点介绍。</p></li></ul></li> <li><p><code>c.LoadConfig(*fConfig)</code> 介绍：该函数会加载所有插件的配置文件，处理方式大同小异，这里以 input 插件 docker 为例，假设在配置文件中定义的结构体如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[[inputs.docker]]
endpoint = &quot;$DOCKER_ENDPOINT&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p>在代码中，经过 toml 包的映射后，最重要的是调用 <code>c.addInput(name, value)</code> 方法，将插件以及插件的参数做初始化。</p> <ul><li><p>先通过 name 从 <code>inputs.Input</code> 从找到注册的 <code>creator</code> 函数，调用它生成一个默认的 input 实例，该实例在这里用接口 <code>telegraf.Input</code> 存储。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>creator<span class="token punctuation">,</span> ok <span class="token operator">:=</span> inputs<span class="token punctuation">.</span>Inputs<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Undefined but requested input: %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
input <span class="token operator">:=</span> <span class="token function">creator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>类型断言 input 是否也实现了 <code>SetParser</code> 接口，如果实现了，先执行 <code>buildParser</code> 函数，用配置文件（最重要的参数是 <code>data_format</code>）填充 <code>parsers.Config{}</code> 对象 c，然后使用 <code>parsers.NewParser(c)</code> 根据构建 parser 实例，并执行 <code>SetParser(parser)</code> 将 parser 设置到 input 实例中，可以参考 inputs 插件中的 <code>tail</code>,实现了该接口。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">switch</span> t <span class="token operator">:=</span> input<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> parsers<span class="token punctuation">.</span>ParserInput<span class="token punctuation">:</span>
    parser<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">buildParser</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> table<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    t<span class="token punctuation">.</span><span class="token function">SetParser</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>调用 <code>buildInput</code> 函数，将解析 input 插件公共的配置参数，并设置到结构体中，返回一个 <code>pluginConfig</code> 实例，其类型为 <code>*models.InputConfig</code>。注意，这一步最后会执行 <code>buildFilter</code> 函数，所以，Filter 相关的参数也可以在配置文件中定义，在这一步一起解析出来。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> InputConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name              <span class="token builtin">string</span>
    NameOverride      <span class="token builtin">string</span>
    MeasurementPrefix <span class="token builtin">string</span>
    MeasurementSuffix <span class="token builtin">string</span>
    Tags              <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    Filter            Filter
    Interval          time<span class="token punctuation">.</span>Duration
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>接下来执行 <code>toml.UnmarshalTable(table, input)</code>， 将定义的插件结构体参数反射进 <code>telegraf.Input</code> 所存储的 input 实例中，完成 input 的初始化，这一步会覆盖掉 input 插件自身的默认值。自此可以明白，写一个 input 插件需要注意两类配置参数，一类是定义自身的参数，另一类是框架中已经定义好的公共参数，根据实际情况来使用完成自己的需求实现。</p></li> <li><p>最后一步执行 <code>models.NewRunningInput(input, pluginConfig)</code>，合并两类配置，返回最终形态的 input 运行时实例，结构体类型叫做 <code>*models.RunningInput</code>，并添加到 c.Inputs 中，这个数组中存了所有启用的 input 插件运行时实例。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> RunningInput <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Input  telegraf<span class="token punctuation">.</span>Input
    Config <span class="token operator">*</span>InputConfig

    trace       <span class="token builtin">bool</span>
    defaultTags <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>

    MetricsGathered selfstat<span class="token punctuation">.</span>Stat
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>然后 for 循环遍历每个 input 插件，便完成了 c.Inputs 的初始化，其他插件类型整个初始化逻辑基本一致。只是 <code>c.Processors</code> 将会排序一次，排序方式按照每个 processor 配置参数中定义的 Order 字段的大小。order 越小，排的越靠前。</p></li></ul></li></ul></li> <li><p><code>ag.Run(shutdown)</code> 函数介绍：</p> <ul><li>先初始化一个带 buffer 的 <code>telegraf.Metric</code> 类型的 channel 作为队列，该 channel 将在所有 inputs 插件中共享，说明所有 inputs 插件收集到的数据最终实际是汇总到一起进入 processors 插件中的。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// channel shared between all input threads for accumulating metrics</span>
metricC <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> telegraf<span class="token punctuation">.</span>Metric<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p>先启用所有的 <code>ServiceInput</code> 插件， 通过 <code>NewAccumulator</code> 创建一个累加器 <code>Accumulator</code> 传入给插件中，用于插件在内部调用 <code>acc.AddFields</code> 方法添加 metrics 到 <code>metricC</code> 中，这类插件不会按照 interval 去运行，只要执行了 <code>p.Start</code> 方法便会一直运行，直到方法自己退出。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Start all ServicePlugins</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> input <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Inputs <span class="token punctuation">{</span>
    input<span class="token punctuation">.</span><span class="token function">SetDefaultTags</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Tags<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> p <span class="token operator">:=</span> input<span class="token punctuation">.</span>Input<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> telegraf<span class="token punctuation">.</span>ServiceInput<span class="token punctuation">:</span>
        acc <span class="token operator">:=</span> <span class="token function">NewAccumulator</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> metricC<span class="token punctuation">)</span>
        <span class="token comment">// Service input plugins should set their own precision of their</span>
        <span class="token comment">// metrics.</span>
        acc<span class="token punctuation">.</span><span class="token function">SetPrecision</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Nanosecond<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;E! Service for input %s failed to start, exiting\n%s\n&quot;</span><span class="token punctuation">,</span>
                input<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">defer</span> p<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 实际上 input 实际，也就是 `*models.RunningInput` 结构体还实现了 `MetricMaker` 接口，用于创建一个满足 `telegraf.Metric` 接口的 metric</span>
<span class="token keyword">func</span> <span class="token function">NewAccumulator</span><span class="token punctuation">(</span>maker MetricMaker<span class="token punctuation">,</span> metrics <span class="token keyword">chan</span> telegraf<span class="token punctuation">.</span>Metric<span class="token punctuation">)</span> <span class="token operator">*</span>accumulator <span class="token punctuation">{</span>
    acc <span class="token operator">:=</span> accumulator<span class="token punctuation">{</span>
        maker<span class="token punctuation">:</span>     maker<span class="token punctuation">,</span>
        metrics<span class="token punctuation">:</span>   metrics<span class="token punctuation">,</span>
        precision<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Nanosecond<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>acc
<span class="token punctuation">}</span>

<span class="token comment">// AddFields</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ac <span class="token operator">*</span>accumulator<span class="token punctuation">)</span> <span class="token function">AddFields</span><span class="token punctuation">(</span>measurement <span class="token builtin">string</span><span class="token punctuation">,</span> fields <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> tags <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> t <span class="token operator">...</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> m <span class="token operator">:=</span> ac<span class="token punctuation">.</span>maker<span class="token punctuation">.</span><span class="token function">MakeMetric</span><span class="token punctuation">(</span>measurement<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> telegraf<span class="token punctuation">.</span>Untyped<span class="token punctuation">,</span> ac<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    ac<span class="token punctuation">.</span>metrics <span class="token operator">&lt;-</span> m
<span class="token punctuation">}</span>

<span class="token comment">// 实现了 `telegraf.Metric` 接口的 metric 结构体如下：</span>
<span class="token keyword">type</span> metric <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    tags   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    fields <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    t      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>

    mType     telegraf<span class="token punctuation">.</span>ValueType
    aggregate <span class="token builtin">bool</span>

    <span class="token comment">// cached values for reuse in &quot;get&quot; functions</span>
    hashID <span class="token builtin">uint64</span>
    nsec   <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div></li> <li><p>如果 <code>RoundInterval</code> 启用了，将 interval 与时间的整秒对齐，详细解释参考注释：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Round collection to nearest interval by sleeping</span>
<span class="token comment">// 假设间隔是 10s 执行一次，我 9点05分01 秒启动了 telegraf，用当前时间和 10s 取余数的结果就是 1s，10 -1 = 9s，所以得出来需要先睡9秒再执行</span>
<span class="token comment">// 这样就实现了与间隔秒数对齐。</span>
<span class="token keyword">if</span> a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>RoundInterval <span class="token punctuation">{</span>
    i <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>Interval<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>再启动 metrics 处理协程 <code>a.flusher</code> 函数，其主要逻辑是，接收放入 <code>metricC</code> 中的 metrics，然后将其应用 <code>a.Config.Processors</code> 进行过滤或变换，得到最终的结果后将其发送到 <code>outMetricC</code> 等待进一步处理。<br>
该函数内部还启动了一个协程，用于接收 <code>outMetricC</code> 中的 metrics，该 metrics 将根据 <code>m.IsAggregate()</code> 的值来判断是否将其添加到 <code>a.Config.Aggregators</code> 中，同时判断 <code>dropOriginal</code> 的值来判断是否将源数据发往 <code>a.Config.Outputs</code>，go 语言通过 channel 的实现使得整个流程非常清晰。需要注意 <code>RunningAggregator</code> 的结构体中定义了一个 channel，在插件初始化的时候便初始化完成，大小为 <code>100</code>。所以，经过 processors 过滤后的 metrics 是先存入了 <code>aggregator</code> 自己内部的 channel 中。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">flusher</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">,</span> metricC<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;E! Flusher routine failed, exiting: %s\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">close</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// a.flusher 函数部分代码</span>
<span class="token keyword">for</span> <span class="token punctuation">{</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> m <span class="token operator">:=</span> <span class="token operator">&lt;-</span>outMetricC<span class="token punctuation">:</span>
		<span class="token keyword">var</span> dropOriginal <span class="token builtin">bool</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>m<span class="token punctuation">.</span><span class="token function">IsAggregate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> agg <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Aggregators <span class="token punctuation">{</span>
				<span class="token keyword">if</span> ok <span class="token operator">:=</span> agg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
					dropOriginal <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dropOriginal <span class="token punctuation">{</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> o <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Outputs <span class="token punctuation">{</span>
				<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Outputs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
					o<span class="token punctuation">.</span><span class="token function">AddMetric</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					o<span class="token punctuation">.</span><span class="token function">AddMetric</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// agg.Add 函数实现，注意 aggregator 将传入的 metric 重新生成，应用了一遍 aggregator 上的 Filter</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RunningAggregator<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>in telegraf<span class="token punctuation">.</span>Metric<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">IsActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// check if the aggregator should apply this metric</span>
        name <span class="token operator">:=</span> in<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        fields <span class="token operator">:=</span> in<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        tags <span class="token operator">:=</span> in<span class="token punctuation">.</span><span class="token function">Tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        t <span class="token operator">:=</span> in<span class="token punctuation">.</span><span class="token function">Time</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token comment">// aggregator should not apply this metric</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>

        in<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> metric<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 省略部分代码</span>
    r<span class="token punctuation">.</span>metrics <span class="token operator">&lt;-</span> in
    <span class="token keyword">return</span> r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>DropOriginal
<span class="token punctuation">}</span>
<span class="token comment">// RunningAggregator struct 定义</span>
<span class="token keyword">type</span> RunningAggregator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    a      telegraf<span class="token punctuation">.</span>Aggregator
    Config <span class="token operator">*</span>AggregatorConfig

    metrics <span class="token keyword">chan</span> telegraf<span class="token punctuation">.</span>Metric

    periodStart time<span class="token punctuation">.</span>Time
    periodEnd   time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>

<span class="token comment">// NewRunningAggregator 初始化代码</span>
<span class="token keyword">func</span> <span class="token function">NewRunningAggregator</span><span class="token punctuation">(</span>a telegraf<span class="token punctuation">.</span>Aggregator<span class="token punctuation">,</span> conf <span class="token operator">*</span>AggregatorConfig<span class="token punctuation">)</span> <span class="token operator">*</span>RunningAggregator <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>RunningAggregator<span class="token punctuation">{</span>
        a<span class="token punctuation">:</span>       a<span class="token punctuation">,</span>
        Config<span class="token punctuation">:</span>  conf<span class="token punctuation">,</span>
        metrics<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> telegraf<span class="token punctuation">.</span>Metric<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div></li> <li><p>启动 <code>Aggregators</code> 处理协程，获取一定间隔内的 metrics，然后进行处理。也是先用 <code>NewAccumulator</code> 初始化一个新的累加器，将 metricC 传入进去。<code>agg.Run()</code> 函数是处理聚合的核心，请结合代码注释来理解 <code>aggregators</code> 的逻辑：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Aggregators<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> aggregator <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Aggregators <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>agg <span class="token operator">*</span>models<span class="token punctuation">.</span>RunningAggregator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        acc <span class="token operator">:=</span> <span class="token function">NewAccumulator</span><span class="token punctuation">(</span>agg<span class="token punctuation">,</span> metricC<span class="token punctuation">)</span>
        acc<span class="token punctuation">.</span><span class="token function">SetPrecision</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>Precision<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>Interval<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
        agg<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> shutdown<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>aggregator<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RunningAggregator<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>acc telegraf<span class="token punctuation">.</span>Accumulator<span class="token punctuation">,</span> shutdown <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The start of the period is truncated to the nearest second.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Every metric then gets it's timestamp checked and is dropped if it</span>
    <span class="token comment">// is not within:</span>
    <span class="token comment">//</span>
    <span class="token comment">//   start &lt; t &lt; end + truncation + delay</span>
    <span class="token comment">//</span>
    <span class="token comment">// So if we start at now = 00:00.2 with a 10s period and 0.3s delay:</span>
    <span class="token comment">//   now = 00:00.2</span>
    <span class="token comment">//   start = 00:00</span>
    <span class="token comment">//   truncation = 00:00.2</span>
    <span class="token comment">//   end = 00:10</span>
    <span class="token comment">// 1st interval: 00:00 - 00:10.5</span>
    <span class="token comment">// 2nd interval: 00:10 - 00:20.5</span>
    <span class="token comment">// etc.</span>
    <span class="token comment">//</span>
    now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span>periodStart <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">Truncate</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    truncation <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>periodStart<span class="token punctuation">)</span>
    r<span class="token punctuation">.</span>periodEnd <span class="token operator">=</span> r<span class="token punctuation">.</span>periodStart<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Period<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Delay<span class="token punctuation">)</span>
    periodT <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Period<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> periodT<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注意数据不是从 metricC 中拿的，而是从 aggregator 内部的 metrics channel 拿的，因为 metricC 中代表的是所有的输入数据， aggregator.metrics 是经过了 processors 过滤之后的。</span>
        <span class="token keyword">case</span> m <span class="token operator">:=</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>metrics<span class="token punctuation">:</span>
            <span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">Time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>periodStart<span class="token punctuation">)</span> <span class="token operator">||</span>
                m<span class="token punctuation">.</span><span class="token function">Time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>periodEnd<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>truncation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Delay<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// the metric is outside the current aggregation period, so</span>
                <span class="token comment">// skip it.</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 添加 metric</span>
            r<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>periodT<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
            r<span class="token punctuation">.</span>periodStart <span class="token operator">=</span> r<span class="token punctuation">.</span>periodEnd
            r<span class="token punctuation">.</span>periodEnd <span class="token operator">=</span> r<span class="token punctuation">.</span>periodStart<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Period<span class="token punctuation">)</span>
            <span class="token comment">// push 这批数据到 acc 中 的 metricC 中，aggregator 实际也相当于是一个输入源，在 a.flusher 会根据 `IsAggregate()` 来判断是不是 aggregator 生成的。</span>
            <span class="token comment">// 这一步既然传入了 acc，肯定会以 acc.AddFields(或者其他 Add 方法)将 metric 加入 MetricC 中，会调用 aggregator.MakeMetric 方法，因此，生成的 metric 都会设置 aggregate = true</span>
            r<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span>
            r<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div></li> <li><p>启用所有的 input 插件，为每个 input 插件都起一个协程运行 <code>a.gatherer</code> 函数，该函数中以定义的 interval 不间断的执行 <code>input.Input.Gather(acc)</code> 函数，收集 metrics 数据并发送给 metricC，上面的 <code>a.flusher</code> 会接收到 channel 发来的值进行二次处理。<code>a.gather()</code> 中也会为每个 input 插件都构造一个新的累加器，将 metricC channel 传入，与前面的 <code>processors</code>、<code>aggregators</code> 共享。for select 模式永久接收 ticker.C, 定时执行 <code>gatherWithTimeout</code> 函数。<code>gatherWithTimeout</code> 会等待 <code>input.Input.Gather(acc)</code> 执行完成，同时会检查超时，如果超时的话报错，但是依旧会等待执行结束，应该是为了防止留下挂起的进程，并且一遍又一遍的调用挂起的进程。<br>
}()</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Inputs<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> input <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Inputs <span class="token punctuation">{</span>
    interval <span class="token operator">:=</span> a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>Interval<span class="token punctuation">.</span>Duration
    <span class="token comment">// overwrite global interval if this plugin has it's own.</span>
    <span class="token keyword">if</span> input<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Interval <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        interval <span class="token operator">=</span> input<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Interval
    <span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>in <span class="token operator">*</span>models<span class="token punctuation">.</span>RunningInput<span class="token punctuation">,</span> interv time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        a<span class="token punctuation">.</span><span class="token function">gatherer</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">,</span> in<span class="token punctuation">,</span> interv<span class="token punctuation">,</span> metricC<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> interval<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Agent<span class="token punctuation">)</span> <span class="token function">gatherer</span><span class="token punctuation">(</span>shutdown <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> input <span class="token operator">*</span>models<span class="token punctuation">.</span>RunningInput<span class="token punctuation">,</span> interval time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> metricC <span class="token keyword">chan</span> telegraf<span class="token punctuation">.</span>Metric<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">panicRecover</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>

    GatherTime <span class="token operator">:=</span> selfstat<span class="token punctuation">.</span><span class="token function">RegisterTiming</span><span class="token punctuation">(</span><span class="token string">&quot;gather&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;gather_time_ns&quot;</span><span class="token punctuation">,</span>
        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> input<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    acc <span class="token operator">:=</span> <span class="token function">NewAccumulator</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> metricC<span class="token punctuation">)</span>
    acc<span class="token punctuation">.</span><span class="token function">SetPrecision</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>Precision<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
        a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>Interval<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>

    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        internal<span class="token punctuation">.</span><span class="token function">RandomSleep</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span>CollectionJitter<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> shutdown<span class="token punctuation">)</span>

        start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">gatherWithTimeout</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">,</span> input<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> interval<span class="token punctuation">)</span>
        elapsed <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>

        GatherTime<span class="token punctuation">.</span><span class="token function">Incr</span><span class="token punctuation">(</span>elapsed<span class="token punctuation">.</span><span class="token function">Nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>shutdown<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gatherWithTimeout</span><span class="token punctuation">(</span>shutdown <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> input <span class="token operator">*</span>models<span class="token punctuation">.</span>RunningInput<span class="token punctuation">,</span> acc <span class="token operator">*</span>accumulator<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 每个 input 插件都要实现核心的 Gather 方法，在此时调用</span>
        done <span class="token operator">&lt;-</span> input<span class="token punctuation">.</span>Input<span class="token punctuation">.</span><span class="token function">Gather</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                acc<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
            err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;took longer to collect than collection interval (%s)&quot;</span><span class="token punctuation">,</span>
                timeout<span class="token punctuation">)</span>
            acc<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>shutdown<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div></li></ul></li></ul> <p>至此，整个主函数逻辑分析完毕。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/infrastructure/log/logstash/tune_performance.html" class="prev">
        Logstash 性能优化
      </a></span> <span class="next"><a href="/blog/infrastructure/monitor/influxdata/tick.html">
        基于 Tick 脚本的报警设计
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.2efd3993.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/7.e70cb6ab.js" defer></script>
  </body>
</html>
