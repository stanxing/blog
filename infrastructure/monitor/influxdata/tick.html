<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Tick 脚本的报警设计 | Stan Xing 的个人博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="记录自己的技术成长">
    <link rel="preload" href="/blog/assets/css/0.styles.eb3efacf.css" as="style"><link rel="preload" href="/blog/assets/js/app.8ad36d1f.js" as="script"><link rel="preload" href="/blog/assets/js/2.371adafa.js" as="script"><link rel="preload" href="/blog/assets/js/38.1148a674.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.76044a89.js"><link rel="prefetch" href="/blog/assets/js/11.16dcfdf2.js"><link rel="prefetch" href="/blog/assets/js/12.567cf3a1.js"><link rel="prefetch" href="/blog/assets/js/13.fc698a2f.js"><link rel="prefetch" href="/blog/assets/js/14.120e22bc.js"><link rel="prefetch" href="/blog/assets/js/15.31517948.js"><link rel="prefetch" href="/blog/assets/js/16.f2796001.js"><link rel="prefetch" href="/blog/assets/js/17.74fd029d.js"><link rel="prefetch" href="/blog/assets/js/18.ea9c27da.js"><link rel="prefetch" href="/blog/assets/js/19.c5d2f40c.js"><link rel="prefetch" href="/blog/assets/js/20.b55c339f.js"><link rel="prefetch" href="/blog/assets/js/21.95249f05.js"><link rel="prefetch" href="/blog/assets/js/22.488e1876.js"><link rel="prefetch" href="/blog/assets/js/23.62f3df12.js"><link rel="prefetch" href="/blog/assets/js/24.ed2866c4.js"><link rel="prefetch" href="/blog/assets/js/25.e7705e24.js"><link rel="prefetch" href="/blog/assets/js/26.fa80b953.js"><link rel="prefetch" href="/blog/assets/js/27.79342037.js"><link rel="prefetch" href="/blog/assets/js/28.224192e2.js"><link rel="prefetch" href="/blog/assets/js/29.2713351c.js"><link rel="prefetch" href="/blog/assets/js/3.d2edf95a.js"><link rel="prefetch" href="/blog/assets/js/30.7b69fe57.js"><link rel="prefetch" href="/blog/assets/js/31.35b40577.js"><link rel="prefetch" href="/blog/assets/js/32.131aec90.js"><link rel="prefetch" href="/blog/assets/js/33.0f3c446a.js"><link rel="prefetch" href="/blog/assets/js/34.4786b108.js"><link rel="prefetch" href="/blog/assets/js/35.3c498c3e.js"><link rel="prefetch" href="/blog/assets/js/36.bfbf82b4.js"><link rel="prefetch" href="/blog/assets/js/37.30b8f1ad.js"><link rel="prefetch" href="/blog/assets/js/39.5eeb7b08.js"><link rel="prefetch" href="/blog/assets/js/4.40ca436a.js"><link rel="prefetch" href="/blog/assets/js/40.d6375d92.js"><link rel="prefetch" href="/blog/assets/js/41.002bc860.js"><link rel="prefetch" href="/blog/assets/js/42.1461c1b7.js"><link rel="prefetch" href="/blog/assets/js/43.b0f5584f.js"><link rel="prefetch" href="/blog/assets/js/44.1a945646.js"><link rel="prefetch" href="/blog/assets/js/45.118e3170.js"><link rel="prefetch" href="/blog/assets/js/46.429c0def.js"><link rel="prefetch" href="/blog/assets/js/47.a7e5ccc7.js"><link rel="prefetch" href="/blog/assets/js/48.68bc81c8.js"><link rel="prefetch" href="/blog/assets/js/49.c6a9737f.js"><link rel="prefetch" href="/blog/assets/js/5.26b70a23.js"><link rel="prefetch" href="/blog/assets/js/50.62270785.js"><link rel="prefetch" href="/blog/assets/js/6.dc656f0b.js"><link rel="prefetch" href="/blog/assets/js/7.bda6ec64.js"><link rel="prefetch" href="/blog/assets/js/8.cf18d63f.js"><link rel="prefetch" href="/blog/assets/js/9.cc1fc44e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.eb3efacf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Stan Xing 的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blog/" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithms</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Infrastructure</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>K8S</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Log</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Logstash</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Monitor</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>Influxdata</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/infrastructure/monitor/influxdata/telegraf.html" class="sidebar-link">Telegraf 源码阅读</a></li><li><a href="/blog/infrastructure/monitor/influxdata/tick.html" class="active sidebar-link">基于 Tick 脚本的报警设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/infrastructure/monitor/influxdata/tick.html#链操作符" class="sidebar-link">链操作符</a></li><li class="sidebar-sub-header"><a href="/blog/infrastructure/monitor/influxdata/tick.html#单双引号" class="sidebar-link">单双引号</a></li><li class="sidebar-sub-header"><a href="/blog/infrastructure/monitor/influxdata/tick.html#tick-node" class="sidebar-link">Tick Node</a></li><li class="sidebar-sub-header"><a href="/blog/infrastructure/monitor/influxdata/tick.html#报警分类" class="sidebar-link">报警分类</a></li><li class="sidebar-sub-header"><a href="/blog/infrastructure/monitor/influxdata/tick.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/blog/infrastructure/monitor/influxdata/batch_vs_stream.html" class="sidebar-link">Kapacitor Batch Vs Stream</a></li><li><a href="/blog/infrastructure/monitor/influxdata/down_sampling.html" class="sidebar-link">数据降采样</a></li></ul></section></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SRE</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="基于-tick-脚本的报警设计"><a href="#基于-tick-脚本的报警设计" class="header-anchor">#</a> 基于 Tick 脚本的报警设计</h1> <h2 id="链操作符"><a href="#链操作符" class="header-anchor">#</a> 链操作符</h2> <ul><li><p><code>|</code>：表示声明了一个链接方法（chaining method），会创建一个对应 node 的实例，并且使其跟它上面的 node 相连接。</p></li> <li><p><code>.</code>：表示声明了一个属性方法调用，用来设置一个 node 内部属性的值。</p></li> <li><p><code>@</code>：声明一个用户定义的函数（UDF）调用，本质上是将新的 UDF 节点添加到管道的链接方法。</p></li></ul> <h2 id="单双引号"><a href="#单双引号" class="header-anchor">#</a> 单双引号</h2> <ul><li>声明一个字符串请使用单引号。</li> <li>为了在 lambda 表达式中访问一个 tag 或者 filed 的值需要使用双引号来引用 tag 或者 field 名称。</li></ul> <p>请看下面一个例子来体会引号该怎么用：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code>   <span class="token comment">// Data frame</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> stream
     <span class="token operator">|</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">'telegraf'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retentionPolicy</span><span class="token punctuation">(</span><span class="token string">'autogen'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">measurement</span><span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">'host'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;cpu&quot;</span> <span class="token operator">==</span> <span class="token string">'cpu-total'</span><span class="token punctuation">)</span>
     <span class="token operator">|</span><span class="token function">eval</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token number">100.0</span> <span class="token operator">-</span> <span class="token string">&quot;usage_idle&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'used'</span><span class="token punctuation">)</span>
   <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在 <code>where</code> 方法中，里面传入一个 lambda 表达式，表达的是比较 tag 字段 &quot;cpu&quot; 的值是否等于字符串 <code>cpu-total</code>, 根据规则，这里的 <code>cpu</code> 需要使用双引号。对于链方法 <code>eval</code> 也是相同的逻辑，所以 <code>usage_idle</code> 也需要使用双引号。需要注意的是，<code>groupBy</code> 里面也是一个 tag 字段名称，但是使用的是单引号，这里就是想表达的是字符串的意思，对该字段做 groupBy，所以用单引号是对的。</p> <p>再看下面一个例子：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">|</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">'{{ index .Tags &quot;host&quot;}}/mem_used'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">'{{ .ID }}:{{ index .Fields &quot;stat&quot; }}'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这是一个 alert node，里面的 id 和 message 属性方法中使用了字符串模板的语法。<code>index .Tags &quot;host&quot;</code> 表示索引 tag 字段 &quot;host&quot; 的值填充到字符串模板中，所以这里 <code>host</code> 也需要双引号。id 方法设置的值会在 message 方法中以 .ID 的方式被引用。</p> <h2 id="tick-node"><a href="#tick-node" class="header-anchor">#</a> Tick Node</h2> <ul><li><code>eval</code>：支持传入多个 lambda 表达式对 data point 做转换，并将转换后的结果用 <code>As</code> 方法设置名称，默认情况下，eval 只会保留 <code>As</code> 设置的新字段，其余字段都将被丢弃，如果还希望保留原始的字段，请使用 <code>keep</code>，不管是否设置 <code>keep</code>，所有的 tag 字段都会被保留。</li> <li><code>mean</code>：对 window 中的数据做聚合，求出过去一分钟内 cpu used 的平均值。</li> <li><code>derivative</code>：计算导数，计算公式为：（current-previous）/（time_difference/unit）, 通过 <code>unit</code> 方法来设置时间单位</li> <li><code>stateCount</code>：传入一个 lambda 表达式，对连续满足表达式的状态进行计数。注意<strong>连续</strong>二字，如果连续的 window 聚合的结果满足表达式，该 node 会将计数结果累加，如果中途某个结果不满足，计数结果将会被重置。</li> <li><code>stats</code>：该节点传入一个时间，用来统计在一个给定时间间隔内 data point 的数量，使用 <code>align</code> 方法可以将给定的时间间隔对齐。比如给定一分钟，就是从 0s 到 60s。返回的结果字段名叫 <code>emitted</code>，可以在下个节点中使用。</li> <li><code>difference</code>：计算传入的字段对应的值与上次的差值，返回的字段名叫 <code>difference</code>。</li> <li><code>alert</code>：报警 node，其 <code>.message</code> 方法用于定义报警信息，<code>.crit</code> 方法表明报警的条件，<code>.critReset</code> 表明报警恢复的条件，<code>.stateChangesOnly</code> 传入一个时间，表示在该时间内仅仅发送状态不同的时间，<code>.post</code> 表明报警发送的地址，接收一个 http 协议。</li></ul> <h2 id="报警分类"><a href="#报警分类" class="header-anchor">#</a> 报警分类</h2> <h3 id="host-报警"><a href="#host-报警" class="header-anchor">#</a> host 报警</h3> <p>默认由 telegraf 提供的能力：</p> <ul><li>cpu</li> <li>disk</li> <li>diskio</li> <li>load</li> <li>memory</li> <li>net</li> <li>netstat</li></ul> <p>需要自己写插件的：</p> <ul><li>kernel</li></ul> <p>下面是一个 cpu 报警的 case，正好用来分析如何实现一个 tick 脚本来做报警：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> cpu <span class="token operator">=</span> stream
  <span class="token operator">|</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">measurement</span><span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>

cpu
  <span class="token operator">|</span><span class="token function">where</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;cpu&quot;</span> <span class="token operator">==</span> <span class="token string">'cpu-total'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">eval</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token number">100.0</span> <span class="token operator">-</span> <span class="token string">&quot;usage_idle&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'used'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">'host'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">period</span><span class="token punctuation">(</span><span class="token number">1</span>m<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token number">1</span>m<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">mean</span><span class="token punctuation">(</span><span class="token string">'used'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">stateCount</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;mean&quot;</span> <span class="token operator">&gt;</span> <span class="token number">90</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'state_count_critical'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">stateCount</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;mean&quot;</span> <span class="token operator">&lt;</span> <span class="token number">90</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'state_count_ok'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">'{{ index .Tags &quot;host&quot;}} alert'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">crit</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;state_count_critical&quot;</span> <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">critReset</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;state_count_ok&quot;</span> <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">stateChangesOnly</span><span class="token punctuation">(</span><span class="token number">24</span>h<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://monitor.example.com/alerts'</span><span class="token punctuation">)</span>
    <span class="token comment">// 这里可以定义任何接收报警的渠道，比如 email 等等。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>上面的 tick 脚本的含义就是，每分钟聚合一次数据点，求出 <code>cpu used</code> 的平均值，判断该值是否大于 90（百分比），如果连续 5 此大于 90，则 post critical 级别的报警，如果连续 30 次小于 90，则重置 critical报警（会 post 恢复的报警）。</p> <h3 id="log-报警"><a href="#log-报警" class="header-anchor">#</a> log 报警</h3> <ul><li>access 日志：
<ul><li>应用错误：针对 5xx 和 4xx 报警，按照 service 名称做 groupBy，每分钟 5xx 数量大于 100 即报警</li> <li>慢响应：针对 200 报警，按照 service 名称做 groupBy，每分钟日志响应时间大于 1 秒的数量大于 100 即报警</li></ul></li> <li>accessOut 日志：同上</li> <li>service 日志：针对 error 级别报警，按照 service 和 category 做 groupBy，每分钟 error 日志数量大于 100 即报警</li> <li>slowquery 日志：按照 database 和 collection 做 groupBy，每分钟 slowquery 数量大于 20 条即报警</li></ul> <p>一个 service access 报警的例子：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> service string
<span class="token keyword">var</span> measurement <span class="token operator">=</span> service <span class="token operator">+</span> <span class="token string">'.access'</span>

<span class="token keyword">var</span> access <span class="token operator">=</span>  stream
  <span class="token operator">|</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">measurement</span><span class="token punctuation">(</span>measurement<span class="token punctuation">)</span>

<span class="token keyword">var</span> access1m <span class="token operator">=</span> access
  <span class="token operator">|</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">measurement</span><span class="token punctuation">(</span>measurement<span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token string">'service'</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span>
  <span class="token comment">// use eval node to delete all fields except 'responseTime'</span>
  <span class="token operator">|</span><span class="token function">eval</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;responseTime&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'responseTime'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">'service'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">period</span><span class="token punctuation">(</span><span class="token number">1</span>m<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token number">1</span>m<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> slowResponse <span class="token operator">=</span> access1m
  <span class="token operator">|</span><span class="token function">where</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;responseTime&quot;</span> <span class="token operator">&gt;</span> <span class="token number">1000.0</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">'responseTime'</span><span class="token punctuation">)</span>

access
  <span class="token operator">|</span><span class="token function">where</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;responseStatus&quot;</span> <span class="token operator">=</span><span class="token operator">~</span> <span class="token regex">/^5.*/</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">'host'</span><span class="token punctuation">,</span> <span class="token string">'@namespace'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token number">1</span>m<span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">difference</span><span class="token punctuation">(</span><span class="token string">'emitted'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">stateCount</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;difference&quot;</span> <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'state_count_ok'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">'{&quot;name&quot;:&quot;5xx&quot;,&quot;priority&quot;:&quot;P1&quot;}'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">crit</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;difference&quot;</span> <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">critReset</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;state_count_ok&quot;</span> <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">stateChangesOnly</span><span class="token punctuation">(</span><span class="token number">1</span>h<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://monitor.example.com/alerts'</span><span class="token punctuation">)</span>

access
  <span class="token operator">|</span><span class="token function">where</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;responseStatus&quot;</span> <span class="token operator">=</span><span class="token operator">~</span> <span class="token regex">/^4.*/</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">'host'</span><span class="token punctuation">,</span> <span class="token string">'@namespace'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token number">1</span>m<span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">difference</span><span class="token punctuation">(</span><span class="token string">'emitted'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">stateCount</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;difference&quot;</span> <span class="token operator">&lt;</span> <span class="token number">2500</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'state_count_ok'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">'{&quot;name&quot;:&quot;4xx&quot;,&quot;priority&quot;:&quot;P3&quot;}'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">crit</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;difference&quot;</span> <span class="token operator">&gt;</span> <span class="token number">5000</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">critReset</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;state_count_ok&quot;</span> <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">stateChangesOnly</span><span class="token punctuation">(</span><span class="token number">1</span>h<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://monitor.example.com/alerts'</span><span class="token punctuation">)</span>

slowResponse
  <span class="token operator">|</span><span class="token function">stateCount</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;count&quot;</span> <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">'state_count_ok'</span><span class="token punctuation">)</span>
  <span class="token operator">|</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">'{&quot;name&quot;:&quot;slowResponse&quot;,&quot;priority&quot;:&quot;P1&quot;}'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">crit</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;count&quot;</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">critReset</span><span class="token punctuation">(</span>lambda<span class="token operator">:</span> <span class="token string">&quot;state_count_ok&quot;</span> <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">stateChangesOnly</span><span class="token punctuation">(</span><span class="token number">1</span>h<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://monitor.example.com/alerts'</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h3 id="k8s-报警"><a href="#k8s-报警" class="header-anchor">#</a> k8s 报警</h3> <ul><li>pod：针对 pod 状态做报警，根据状态不同，设置不同的报警条件。
<ul><li>pod 状态为 pending 超过 5 分钟，说明可能 clusterautoscaler 出问题了，或者拉镜像很慢或者出问题了，需要干预。</li> <li>pod 状态为 failed，直接报警，需要干预。</li> <li>pod 状态为 running 但是 ready 字段为 false，说明 pod 长时间出于 notReady 状态，可能是健康检查出问题了，需要干预。</li></ul></li> <li>node：
<ul><li>node 状态为 notReady，需要干预。</li></ul></li> <li>certificate：
<ul><li>kubelet 证书过期</li> <li>apiserver 证书过期</li> <li>ca 证书过期</li></ul></li> <li>clusterautoscaler：
<ul><li>ca 机器数量达到了最大值需要报警，因为再有新的 pod 创建可能导致无法新加机器，甚至需要排查当前 ca 机器满的原因，是否出现了什么 bug。</li> <li>ca 机器连续一段时间不被释放需要报警，一直不被释放说明集群资源可能确实不够用了，应该加固定的机器而不是一直使用 ca。</li></ul></li> <li>hpa：
<ul><li>某个服务的 hpa 达到最大值并且一直保持了一段时间需要报警，可能是因为当前流量较高，需要注意。</li></ul></li></ul> <h3 id="其他分类报警"><a href="#其他分类报警" class="header-anchor">#</a> 其他分类报警</h3> <ul><li>数据库</li> <li>消息队列</li> <li>域名</li> <li>等等</li> <li>站点可用性报警</li></ul> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://docs.influxdata.com/kapacitor/v1.5/nodes" target="_blank" rel="noopener noreferrer">Kapacitor Node<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/influxdata/kapacitor/tree/master/examples/telegraf" target="_blank" rel="noopener noreferrer">Kapacitor Tick Examples<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/12/2020, 2:19:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/infrastructure/monitor/influxdata/telegraf.html" class="prev">
        Telegraf 源码阅读
      </a></span> <span class="next"><a href="/blog/infrastructure/monitor/influxdata/batch_vs_stream.html">
        Kapacitor Batch Vs Stream
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8ad36d1f.js" defer></script><script src="/blog/assets/js/2.371adafa.js" defer></script><script src="/blog/assets/js/38.1148a674.js" defer></script>
  </body>
</html>
